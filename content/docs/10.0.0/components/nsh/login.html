<!--
 Documentation/_templates/layout.html

 Licensed to the Apache Software Foundation (ASF) under one or more
 contributor license agreements.  See the NOTICE file distributed with
 this work for additional information regarding copyright ownership.  The
 ASF licenses this file to you under the Apache License, Version 2.0 (the
 "License"); you may not use this file except in compliance with the
 License.  You may obtain a copy of the License at

   http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
 WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 License for the specific language governing permissions and limitations
 under the License.
-->



<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Shell Login &mdash; NuttX latest documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/sphinx_tabs/semantic-ui-2.4.1/segment.min.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/sphinx_tabs/semantic-ui-2.4.1/menu.min.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/sphinx_tabs/semantic-ui-2.4.1/tab.min.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/sphinx_tabs/tabs.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Power Management" href="../power.html" />
    <link rel="prev" title="Customizing NSH Initialization" href="installation.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          
  
    <a href="../../index.html" class="icon icon-home"> NuttX
  

  
    
    <img src="../../_static/NuttX.png" class="logo" alt="Logo"/>
  
  </a>
  
  <!-- this version selector is quite ugly, should be probably replaced by something
       more modern -->
       
  <div class="version-selector">
    <select>
    
      <option value="latest" selected="selected">latest</option>
    
    </select>
  </div>
  
  
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Table of Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../index.html">Home</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../introduction/index.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../introduction/inviolables.html">The Inviolable Principles of NuttX</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quickstart/index.html">Getting Started</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">OS Components</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="index.html">NuttShell (NSH)</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="nsh.html">Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="commands.html">Commands</a></li>
<li class="toctree-l3"><a class="reference internal" href="config.html">Configuration Settings</a></li>
<li class="toctree-l3"><a class="reference internal" href="customizing.html">Customizing the NuttShell</a></li>
<li class="toctree-l3"><a class="reference internal" href="builtin.html">NSH “Built-In” Applications</a></li>
<li class="toctree-l3"><a class="reference internal" href="installation.html">Customizing NSH Initialization</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Shell Login</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#enabling-shell-logins">Enabling Shell Logins</a></li>
<li class="toctree-l4"><a class="reference internal" href="#verification-of-credentials">Verification of Credentials</a></li>
<li class="toctree-l4"><a class="reference internal" href="#password-files">Password Files</a></li>
<li class="toctree-l4"><a class="reference internal" href="#creating-a-password-file-for-a-romfs-file-system">Creating a Password File for a ROMFS File System</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../power.html">Power Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="../socketcan.html">SocketCAN Device Drivers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../syslog.html">SYSLOG</a></li>
<li class="toctree-l2"><a class="reference internal" href="../binfmt.html">Binary Loader</a></li>
<li class="toctree-l2"><a class="reference internal" href="../drivers/index.html">Device Drivers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../filesystem.html">NuttX File System</a></li>
<li class="toctree-l2"><a class="reference internal" href="../nxflat.html">NXFLAT</a></li>
<li class="toctree-l2"><a class="reference internal" href="../nxgraphics/index.html">NX Graphics Subsystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../nxwidgets.html">NxWidgets</a></li>
<li class="toctree-l2"><a class="reference internal" href="../paging.html">On-Demand Paging</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../applications/index.html">Applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../boards/index.html">Supported Boards</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reference/index.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guides/index.html">Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../releases/index.html">Releases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing/index.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../glossary.html">Glossary</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">NuttX</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">OS Components</a> &raquo;</li>
        
          <li><a href="index.html">NuttShell (NSH)</a> &raquo;</li>
        
      <li>Shell Login</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/components/nsh/login.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="shell-login">
<h1>Shell Login<a class="headerlink" href="#shell-login" title="Permalink to this headline">¶</a></h1>
<div class="section" id="enabling-shell-logins">
<h2>Enabling Shell Logins<a class="headerlink" href="#enabling-shell-logins" title="Permalink to this headline">¶</a></h2>
<p>NuttShell sessions can be protected by requiring that the user supply
username and password credentials at the beginning of the session.
Logins can be enabled for standard USB or serial consoles with:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>CONFIG_NSH_CONSOLE_LOGIN=y
</pre></div>
</div>
<p>Logins for Telnet sessions can be enabled separately with:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>CONFIG_NSH_TELNET_LOGIN=y
</pre></div>
</div>
<p>Logins can be enabled for either or both session types. On a successful
login, the user will have access to the NSH session:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>login: admin
password:
User Logged-in!

NuttShell (NSH)
nsh&gt;
</pre></div>
</div>
<p>After each failed login attempt, a delay can be set up. The purpose of
this delay is to discourage attempts to crack the password by brute
force. That delay is configured with:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>CONFIG_NSH_LOGIN_FAILDELAY=0
</pre></div>
</div>
<p>This setting provides the login failure delay in units of milliseconds.
The system will pause this amount of time after each failed login
attempt. After a certain number of failed login attempts, the session
will be closed. That number is controlled by:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>CONFIG_NSH_LOGIN_FAILCOUNT=3
</pre></div>
</div>
</div>
<div class="section" id="verification-of-credentials">
<h2>Verification of Credentials<a class="headerlink" href="#verification-of-credentials" title="Permalink to this headline">¶</a></h2>
<p>There are three ways that NSH can be configured to verify user
credentials at login time:</p>
<blockquote>
<div><ol class="arabic">
<li><p>The simplest implementation simply uses fixed login credentials and
is selected with:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>CONFIG_NSH_LOGIN_FIXED=y
</pre></div>
</div>
<p>The fixed login credentials are selected via:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>CONFIG_NSH_LOGIN_USERNAME=admin
CONFIG_NSH_LOGIN_PASSWORD=&quot;Administrator&quot;
</pre></div>
</div>
<p>This is not very flexible since there can be only one user and the
password is fixed in the FLASH image. This option is also not very
secure because a malicious user could get the password by just
looking at the <code class="docutils literal notranslate"><span class="pre">.text</span></code> stings in the flash image.</p>
</li>
<li><p>NSH can also be configured to defer the entire user credential
verification to platform-specific logic with this setting:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>CONFIG_NSH_LOGIN_PLATFORM=y
</pre></div>
</div>
<p>In this case, NSH will call a platform-specific function to perform
the verification of user credentials. The platform-specific logic
must provide a function with the following prototype:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="nf">platform_user_verify</span><span class="p">(</span><span class="n">FAR</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">username</span><span class="p">,</span> <span class="n">FAR</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">password</span><span class="p">);</span>
</pre></div>
</div>
<p>which is prototyped an described in <code class="docutils literal notranslate"><span class="pre">apps/include/nsh.h</span></code> and which
may be included like:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;apps/nsh.h&gt;</span><span class="cp"></span>
</pre></div>
</div>
<p>An appropriate place to implement this function might be in the
directory <code class="docutils literal notranslate"><span class="pre">apps/platform/&lt;board&gt;</span></code>.</p>
</li>
<li><p>A final option is to use a password file contained encrypted password
information. This final option is selected with the following and
described in more detail in the following paragraph:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>CONFIG_NSH_LOGIN_PASSWD=y
</pre></div>
</div>
</li>
</ol>
</div></blockquote>
</div>
<div class="section" id="password-files">
<h2>Password Files<a class="headerlink" href="#password-files" title="Permalink to this headline">¶</a></h2>
<p>NuttX can also be configured to support a password file, by default at
<code class="docutils literal notranslate"><span class="pre">/etc/passwd</span></code>. This option enables support for a password file:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>CONFIG_NSH_LOGIN_PASSWD=y
</pre></div>
</div>
<p>This options requires that you have selected <code class="docutils literal notranslate"><span class="pre">CONFIG_FSUTILS_PASSWD=y</span></code>
to enable the access methods of <code class="docutils literal notranslate"><span class="pre">apps/fsutils/passwd</span></code>:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>CONFIG_FSUTILS_PASSWD=y
</pre></div>
</div>
<p>And this determines the location of the password file in a mounted
volume:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>CONFIG_FSUTILS_PASSWD_PATH=&quot;/etc/passwd&quot;
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">/etc/passwd</span></code> is a <em>standard</em> location, but you will need to locate
the password where ever you have a mounted volume.</p>
<p>The password file can be a fixed list of users in a ROMFS file system or
a modifiable list maintained in a file in some writable file system. If
the password file lies in a read-only file system like ROMFS, then you
should also indicate that the password file is read-only.</p>
<blockquote>
<div><p>CONFIG_FSUTILS_PASSWD_READONLY=y</p>
</div></blockquote>
<p>If the password file is writable, then additional NSH commands will be
enabled to modify the password file: <code class="docutils literal notranslate"><span class="pre">`useradd</span></code> &lt;#cmduseradd&gt;`__,
<code class="docutils literal notranslate"><span class="pre">`userdel</span></code> &lt;#cmduserdel&gt;`__, and <code class="docutils literal notranslate"><span class="pre">`passwd</span></code> &lt;#cmdpasswd&gt;`__. If you
do not wish you have these commands available, then they should be
specifically disabled.</p>
<p>The password file logic requires a few additional settings:</p>
<blockquote>
<div><ol class="arabic">
<li><p>The size of dynamically allocated and freed buffer that is used for
file access:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>CONFIG_FSUTILS_PASSWD_IOBUFFER_SIZE=512
</pre></div>
</div>
</li>
<li><p>And the 128-bit encryption key. The password file currently uses the
Tiny Encryption Algorithm (TEA), but could be extended to use
something more powerful.</p>
<blockquote>
<div><p>CONFIG_FSUTILS_PASSWD_KEY1=0x12345678
CONFIG_FSUTILS_PASSWD_KEY2=0x9abcdef0
CONFIG_FSUTILS_PASSWD_KEY3=0x12345678
CONFIG_FSUTILS_PASSWD_KEY4=0x9abcdef0</p>
</div></blockquote>
</li>
</ol>
</div></blockquote>
<p>Password can only be decrypted with access to this key. Note that this
key could potentially be fished out of your FLASH image, but without any
symbolic information, that would be a difficult job since the TEA KEY is
binary data and not distinguishable from other binary data in the FLASH
image.</p>
<p>If the password file is enabled (<code class="docutils literal notranslate"><span class="pre">CONFIG_NSH_LOGIN_PASSWD=y</span></code>), then
the fixed user credentials will not be used for the NSH session login.
Instead, the password file will be consulted to verify the user
credentials.</p>
</div>
<div class="section" id="creating-a-password-file-for-a-romfs-file-system">
<h2>Creating a Password File for a ROMFS File System<a class="headerlink" href="#creating-a-password-file-for-a-romfs-file-system" title="Permalink to this headline">¶</a></h2>
<p>What we want to accomplish is a ROMFS file system, mounted at <code class="docutils literal notranslate"><span class="pre">/etc</span></code>
and containing the password file, <code class="docutils literal notranslate"><span class="pre">passwd</span></code> like:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>NuttShell (NSH)
nsh&gt; ls -Rl /etc
/etc:
 dr-xr-xr-x       0 .
 dr-xr-xr-x       0 init.d/
 -r--r--r--      39 passwd
/etc/init.d:
 dr-xr-xr-x       0 ..
 -r--r--r--     110 rcS
nsh&gt;
</pre></div>
</div>
<p>Where <code class="docutils literal notranslate"><span class="pre">/etc/init.d/rcS</span></code> is the start-up script; <code class="docutils literal notranslate"><span class="pre">/etc/passwd</span></code> is a
the password file. Note that here we assume that you are already using a
start-up script. We can then piggyback the passwd file into the <code class="docutils literal notranslate"><span class="pre">/etc</span></code>
file system already mounted for the NSH start up file as described above
<a class="reference external" href="#custinit">above</a>.</p>
<p>I use the sim/nsh configuration to create a new password file, but other
configurations could also be used. That configuration already supports a
ROMFS file system, passwords, and login prompts. First, I make these
changes to that configuration.</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>Disable logins:</p></li>
</ol>
<blockquote>
<div><div class="highlight-diff notranslate"><div class="highlight"><pre><span></span><span class="gd">- CONFIG_NSH_CONSOLE_LOGIN=y</span>
<span class="gi">+ # CONFIG_NSH_CONSOLE_LOGIN is not set</span>
  # CONFIG_NSH_TELNET_LOGIN is not set
</pre></div>
</div>
</div></blockquote>
<ol class="arabic simple">
<li><p>Move the password file to a write-able file system:</p></li>
</ol>
<blockquote>
<div><div class="highlight-diff notranslate"><div class="highlight"><pre><span></span><span class="gd">- CONFIG_FSUTILS_PASSWD_PATH=&quot;/etc/passwd&quot;</span>
<span class="gi">+ CONFIG_FSUTILS_PASSWD_PATH=&quot;/tmp/passwd&quot;</span>
</pre></div>
</div>
</div></blockquote>
<ol class="arabic simple">
<li><p>Make the password file modifiable</p></li>
</ol>
<blockquote>
<div><div class="highlight-diff notranslate"><div class="highlight"><pre><span></span><span class="gd">- CONFIG_FSUTILS_PASSWD_READONLY=y</span>
# CONFIG_FSUTILS_PASSWD_READONLY is not set
</pre></div>
</div>
</div></blockquote>
</div></blockquote>
<p>Now rebuild the simulation. No login should be required to enter the
shell and you should find the <code class="docutils literal notranslate"><span class="pre">`useradd</span></code> &lt;#cmduseradd&gt;`__,
<code class="docutils literal notranslate"><span class="pre">`userdel</span></code> &lt;#cmduserdel&gt;`__, and <code class="docutils literal notranslate"><span class="pre">`passwd</span></code> &lt;#cmdpasswd&gt;`__ commands
available in the help summary, provided that they are enabled. Make
certain that the <code class="docutils literal notranslate"><span class="pre">useradd</span></code> command is not disabled:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># CONFIG_NSH_DISABLE_USERADD is not set
</pre></div>
</div>
<p>Use the NSH <code class="docutils literal notranslate"><span class="pre">`useradd</span></code> &lt;#cmduseradd&gt;`__ command to add new uses with
new user passwords like:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>nsh&gt; useradd &lt;username&gt; &lt;password&gt;
</pre></div>
</div>
<p>Do this as many times as you would like. Each time that you do this a
new entry with an encrypted password will be added to the <code class="docutils literal notranslate"><span class="pre">passwd</span></code>
file at <code class="docutils literal notranslate"><span class="pre">/tmp/passwd</span></code>. You can see the content of the password file
like:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>nsh&gt; cat /tmp/passwd
</pre></div>
</div>
<p>When you are finished, you can simply copy the <code class="docutils literal notranslate"><span class="pre">/tmp/passwd</span></code> content
from the <code class="docutils literal notranslate"><span class="pre">cat</span></code> command and paste it into an editor. Make sure to
remove any carriage returns that may have ended up on the file if you
are using Windows.</p>
<p>Then create/re-create the <code class="docutils literal notranslate"><span class="pre">nsh_romfsimg.h</span></code> file as described below.</p>
<blockquote>
<div><ol class="arabic">
<li><p>The content on the <code class="docutils literal notranslate"><span class="pre">nsh_romfsimg.h</span></code> header file is generated from a
template directory structure. Create the directory structure:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>mkdir etc
mkdir etc/init.d
</pre></div>
</div>
<p>And copy your existing startup script into <code class="docutils literal notranslate"><span class="pre">etc/init.c</span></code> as <code class="docutils literal notranslate"><span class="pre">rcS</span></code>.</p>
</li>
<li><p>Save your new password file in the <code class="docutils literal notranslate"><span class="pre">etc/</span></code> directory as <code class="docutils literal notranslate"><span class="pre">passwd</span></code>.</p></li>
<li><p>Create the new ROMFS image:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>genromfs -f romfs_img -d etc -V MyVolName
</pre></div>
</div>
</li>
<li><p>Convert the ROMFS image to a C header file:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>xxd -i romfs_img &gt;nsh_romfsimg.h
</pre></div>
</div>
</li>
<li><p>Edit <code class="docutils literal notranslate"><span class="pre">nsh_romfsimg.h</span></code>: Mark both data definitions as <code class="docutils literal notranslate"><span class="pre">const</span></code> so
that the data will be stored in FLASH.</p></li>
<li><p>Edit nsh_romfsimg.h, mark both data definitions as <code class="docutils literal notranslate"><span class="pre">const</span></code> so that
that will be stored in FLASH.</p></li>
</ol>
</div></blockquote>
<p>There is a good example of how to do this in the NSH simulation
configuration at
<a class="reference external" href="https://bitbucket.org/nuttx/nuttx/src/master/boards/sim/sim/sim/configs/nsh/">boards/sim/sim/sim/configs/nsh</a>.
The ROMFS support files are provided at
<a class="reference external" href="https://bitbucket.org/nuttx/nuttx/boards/src/master/sim/sim/sim/include/">boards/sim/include</a>
and the
<a class="reference external" href="https://bitbucket.org/nuttx/nuttx/src/master/boards/sim/sim/sim/include/README.txt">README.txt</a>
file at the location provides detailed information about creating and
modifying the ROMFS file system.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, The Apache Software Foundation

    </p>
  </div> 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>