<!--
 Documentation/_templates/layout.html

 Licensed to the Apache Software Foundation (ASF) under one or more
 contributor license agreements.  See the NOTICE file distributed with
 this work for additional information regarding copyright ownership.  The
 ASF licenses this file to you under the Apache License, Version 2.0 (the
 "License"); you may not use this file except in compliance with the
 License.  You may obtain a copy of the License at

   http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
 WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 License for the specific language governing permissions and limitations
 under the License.
-->



<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>USB Host-Side Drivers &mdash; NuttX latest documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/sphinx_tabs/semantic-ui-2.4.1/segment.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/sphinx_tabs/semantic-ui-2.4.1/menu.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/sphinx_tabs/semantic-ui-2.4.1/tab.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/sphinx_tabs/tabs.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="USB Device-Side Drivers" href="usbdev.html" />
    <link rel="prev" title="SDIO Device Drivers" href="sdio.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          
  
    <a href="../../../index.html" class="icon icon-home"> NuttX
  

  
    
    <img src="../../../_static/NuttX.png" class="logo" alt="Logo"/>
  
  </a>
  
  <!-- this version selector is quite ugly, should be probably replaced by something
       more modern -->
       
  <div class="version-selector">
    <select>
    
      <option value="latest" selected="selected">latest</option>
    
    </select>
  </div>
  
  
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Table of Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../index.html">Home</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../introduction/index.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../introduction/inviolables.html">The Inviolable Principles of NuttX</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../quickstart/index.html">Getting Started</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../index.html">OS Components</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../nsh/index.html">NuttShell (NSH)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../power.html">Power Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../socketcan.html">SocketCAN Device Drivers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../syslog.html">SYSLOG</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../binfmt.html">Binary Loader</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.html">Device Drivers</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../character/index.html">Character Device Drivers</a></li>
<li class="toctree-l3"><a class="reference internal" href="../block/index.html">Block Device Drivers</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="index.html">Specialized Device Drivers</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="spi.html">SPI Device Drivers</a></li>
<li class="toctree-l4"><a class="reference internal" href="i2c.html">I2C Device Drivers</a></li>
<li class="toctree-l4"><a class="reference internal" href="ethernet.html">Ethernet Device Drivers</a></li>
<li class="toctree-l4"><a class="reference internal" href="framebuffer.html">Frame Buffer Drivers</a></li>
<li class="toctree-l4"><a class="reference internal" href="lcd.html">LCD Drivers</a></li>
<li class="toctree-l4"><a class="reference internal" href="mtd.html">Memory Technology Device Drivers</a></li>
<li class="toctree-l4"><a class="reference internal" href="sdio.html">SDIO Device Drivers</a></li>
<li class="toctree-l4 current"><a class="current reference internal" href="#">USB Host-Side Drivers</a></li>
<li class="toctree-l4"><a class="reference internal" href="usbdev.html">USB Device-Side Drivers</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../index.html#lower-half-and-upper-half">Lower-half and upper-half</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../filesystem.html">NuttX File System</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../nxflat.html">NXFLAT</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../nxgraphics/index.html">NX Graphics Subsystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../nxwidgets.html">NxWidgets</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../paging.html">On-Demand Paging</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../applications/index.html">Applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../boards/index.html">Supported Boards</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../reference/index.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/index.html">Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../releases/index.html">Releases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing/index.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../glossary.html">Glossary</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">NuttX</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">OS Components</a> &raquo;</li>
        
          <li><a href="../index.html">Device Drivers</a> &raquo;</li>
        
          <li><a href="index.html">Specialized Device Drivers</a> &raquo;</li>
        
      <li>USB Host-Side Drivers</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../../_sources/components/drivers/special/usbhost.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="usb-host-side-drivers">
<h1>USB Host-Side Drivers<a class="headerlink" href="#usb-host-side-drivers" title="Permalink to this headline">Â¶</a></h1>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">include/nuttx/usb/usbhost.h</span></code>. All structures and APIs
needed to work with USB host-side drivers are provided in this
header file.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">usbhost_driver_s</span></code> and
<code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">usbhost_connection_s</span></code>. Each USB host controller
driver must implement an instance of
<code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">usbhost_driver_s</span></code> and
<code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">usbhost_connection_s</span></code>: <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">usbhost_driver_s</span></code>
provides the interface between the USB host driver and the USB
class driver; <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">usbhost_connection_s</span></code> provides the
interface between the USB host driver and platform-specific
connection management and device enumeration logic. These
structures are defined in <code class="docutils literal notranslate"><span class="pre">include/nuttx/usb/usbhost.h</span></code>.</p>
<p><strong>Examples</strong>: <code class="docutils literal notranslate"><span class="pre">arch/arm/src/lpc17xx_40xx/lpc17_40_usbhost.c</span></code>,
<code class="docutils literal notranslate"><span class="pre">arch/arm/src/stm32/stm32_otgfshost.c</span></code>,
<code class="docutils literal notranslate"><span class="pre">arch/arm/src/sama5/sam_ohci.c</span></code>, and
<code class="docutils literal notranslate"><span class="pre">arch/arm/src/sama5/sam_ehci.c</span></code>.</p>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">usbhost_class_s</span></code>. Each USB host class driver must
implement an instance of <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">usbhost_class_s</span></code>. This
structure is also defined in <code class="docutils literal notranslate"><span class="pre">include/nuttx/usb/usbhost.h</span></code>.</p>
<p><strong>Examples</strong>: <code class="docutils literal notranslate"><span class="pre">drivers/usbhost/usbhost_storage.c</span></code></p>
</li>
<li><p><strong>USB Host Class Driver Registry</strong>. The NuttX USB host
infrastructure includes a <em>registry</em>. During its
initialization, each USB host class driver must call the
interface, <code class="docutils literal notranslate"><span class="pre">usbhost_registerclass()</span></code> in order add its
interface to the registry. Later, when a USB device is
connected, the USB host controller will look up the USB host
class driver that is needed to support the connected device in
this registry.</p>
<p><strong>Examples</strong>: <code class="docutils literal notranslate"><span class="pre">drivers/usbhost/usbhost_registry.c</span></code>,
<code class="docutils literal notranslate"><span class="pre">drivers/usbhost/usbhost_registerclass.c</span></code>, and
<code class="docutils literal notranslate"><span class="pre">drivers/usbhost/usbhost_findclass.c</span></code>,</p>
</li>
<li><p><strong>Detection and Enumeration of Connected Devices</strong>. Each USB
host device controller supports two methods that are used to
detect and enumeration newly connected devices (and also detect
disconnected devices):</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">int</span> <span class="pre">(*wait)(FAR</span> <span class="pre">struct</span> <span class="pre">usbhost_connection_s</span> <span class="pre">*drvr,</span> <span class="pre">FAR</span> <span class="pre">const</span> <span class="pre">bool</span> <span class="pre">*connected);</span></code></p>
<p>Wait for a device to be connected or disconnected.</p>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">int</span> <span class="pre">(*enumerate)(FAR</span> <span class="pre">struct</span> <span class="pre">usbhost_connection_s</span> <span class="pre">*drvr,</span> <span class="pre">int</span> <span class="pre">rhpndx);</span></code></p>
<p>Enumerate the device connected to a root hub port. As part
of this enumeration process, the driver will (1) get the
deviceâs configuration descriptor, (2) extract the class ID
info from the configuration descriptor, (3) call
<code class="docutils literal notranslate"><span class="pre">usbhost_findclass(</span></code>) to find the class that supports this
device, (4) call the <code class="docutils literal notranslate"><span class="pre">create()</span></code> method on the
<code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">usbhost_registry_s</span> <span class="pre">interface</span></code> to get a class
instance, and finally (5) call the <code class="docutils literal notranslate"><span class="pre">connect()</span></code> method of
the <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">usbhost_class_s</span></code> interface. After that, the
class is in charge of the sequence of operations.</p>
</li>
</ul>
</li>
<li><p><strong>Binding USB Host-Side Drivers</strong>. USB host-side controller
drivers are not normally directly accessed by user code, but
are usually bound to another, higher level USB host class
driver. The class driver exports the standard NuttX device
interface so that the connected USB device can be accessed just
as with other, similar, on-board devices. For example, the USB
host mass storage class driver
(<code class="docutils literal notranslate"><span class="pre">drivers/usbhost/usbhost_storage.c</span></code>) will register a
standard, NuttX block driver interface (like <code class="docutils literal notranslate"><span class="pre">/dev/sda</span></code>) that
can be used to mount a file system just as with any other other
block driver instance. In general, the binding sequence is:</p>
<ol class="arabic">
<li><p>Each USB host class driver includes an initialization entry
point that is called from the application at initialization
time. This driver calls <code class="docutils literal notranslate"><span class="pre">usbhost_registerclass()</span></code> during
this initialization in order to makes itself available in
the event the device that it supports is connected.</p>
<p><strong>Examples</strong>: The function <code class="docutils literal notranslate"><span class="pre">usbhost_msc_initialize()</span></code> in
the file <code class="docutils literal notranslate"><span class="pre">drivers/usbhost/usbhost_storage.c</span></code></p>
</li>
<li><p>Each application must include a <em>waiter</em> thread thread that
(1) calls the USB host controller driverâs <code class="docutils literal notranslate"><span class="pre">wait()</span></code> to
detect the connection of a device, and then (2) call the USB
host controller driverâs <code class="docutils literal notranslate"><span class="pre">enumerate</span></code> method to bind the
registered USB host class driver to the USB host controller
driver.</p>
<p><strong>Examples</strong>: The function <code class="docutils literal notranslate"><span class="pre">nsh_waiter()</span></code> in the file
<code class="docutils literal notranslate"><span class="pre">boards/arm/lpc17xx_40xx/olimex-lpc1766stk/src/lpc17_40_appinit.c</span></code>.</p>
</li>
<li><p>As part of its operation during the binding operation, the
USB host class driver will register an instances of a
standard NuttX driver under the <code class="docutils literal notranslate"><span class="pre">/dev</span></code> directory. To
repeat the above example, the USB host mass storage class
driver (<code class="docutils literal notranslate"><span class="pre">drivers/usbhost/usbhost_storage.c</span></code>) will register
a standard, NuttX block driver interface (like <code class="docutils literal notranslate"><span class="pre">/dev/sda</span></code>)
that can be used to mount a file system just as with any
other other block driver instance.</p>
<p><strong>Examples</strong>: See the call to <code class="docutils literal notranslate"><span class="pre">register_blockdriver()</span></code> in
the function <code class="docutils literal notranslate"><span class="pre">usbhost_initvolume()</span></code> in the file
<code class="docutils literal notranslate"><span class="pre">drivers/usbhost/usbhost_storage.c</span></code>.</p>
</li>
</ol>
</li>
</ul>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, The Apache Software Foundation

    </p>
  </div> 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>