<!--
 Documentation/_templates/layout.html

 Licensed to the Apache Software Foundation (ASF) under one or more
 contributor license agreements.  See the NOTICE file distributed with
 this work for additional information regarding copyright ownership.  The
 ASF licenses this file to you under the Apache License, Version 2.0 (the
 "License"); you may not use this file except in compliance with the
 License.  You may obtain a copy of the License at

   http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
 WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 License for the specific language governing permissions and limitations
 under the License.
-->

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CNxConsole Keyboard Input &mdash; NuttX latest documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/copybutton.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/tabs.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/sphinx_highlight.js"></script>
        <script src="../../../_static/clipboard.min.js"></script>
        <script src="../../../_static/copybutton.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="pdcurs34 pdcurses Text User Interface (TUI)" href="../pdcurs34/index.html" />
    <link rel="prev" title="nxwm NuttX Tiny Window Manager (NxWM)" href="index.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
  
    <a href="../../../index.html" class="icon icon-home"> NuttX
  

  
  </a>

  <!-- this version selector is quite ugly, should be probably replaced by something
       more modern -->

  <div class="version-selector">
    <select onchange="javascript:location.href = this.value;">
    
    <option value="../../../../latest" selected="selected">latest</option>
    
    <option value="../../../../10.0.0" >10.0.0</option>
    
    <option value="../../../../10.0.1" >10.0.1</option>
    
    <option value="../../../../10.1.0" >10.1.0</option>
    
    <option value="../../../../10.2.0" >10.2.0</option>
    
    <option value="../../../../10.3.0" >10.3.0</option>
    
    <option value="../../../../11.0.0" >11.0.0</option>
    
    <option value="../../../../12.0.0" >12.0.0</option>
    
    <option value="../../../../12.1.0" >12.1.0</option>
    
    <option value="../../../../12.2.0" >12.2.0</option>
    
    <option value="../../../../12.2.1" >12.2.1</option>
    
    <option value="../../../../12.3.0" >12.3.0</option>
    
    <option value="../../../../12.4.0" >12.4.0</option>
    
    </select>
  </div>

  
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Table of Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../index.html">Home</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../introduction/index.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../quickstart/index.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing/index.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../introduction/inviolables.html">The Inviolable Principles of NuttX</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../platforms/index.html">Supported Platforms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../components/index.html">OS Components</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../index.html">Applications</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../audioutils/index.html">Audio Utility libraries</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../boot/index.html">Bootloader Utilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../benchmarks/index.html">Benchmark Applications</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../canutils/index.html">CAN Utilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../crypto/index.html">Cryptography Library Support</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../fsutils/index.html">File System Utilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../games/index.html">Games</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.html">Graphics Support</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../ft80x/index.html"><code class="docutils literal notranslate"><span class="pre">ft80x</span></code> FTDI/BridgeTek FT80x library</a></li>
<li class="toctree-l3"><a class="reference internal" href="../libjpeg/index.html"><code class="docutils literal notranslate"><span class="pre">libjpeg</span></code> libjpeg JPEG image encoding</a></li>
<li class="toctree-l3"><a class="reference internal" href="../libyuv/index.html"><code class="docutils literal notranslate"><span class="pre">libyuv</span></code> libyuv</a></li>
<li class="toctree-l3"><a class="reference internal" href="../lvgl/index.html"><code class="docutils literal notranslate"><span class="pre">lvgl</span></code> LVGL</a></li>
<li class="toctree-l3"><a class="reference internal" href="../nxwidgets/index.html"><code class="docutils literal notranslate"><span class="pre">nxwidgets</span></code> NXWidgets</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="index.html"><code class="docutils literal notranslate"><span class="pre">nxwm</span></code> NuttX Tiny Window Manager (NxWM)</a><ul class="current">
<li class="toctree-l4 current"><a class="current reference internal" href="#">CNxConsole Keyboard Input</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#doxygen">Doxygen</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../pdcurs34/index.html"><code class="docutils literal notranslate"><span class="pre">pdcurs34</span></code> pdcurses Text User Interface (TUI)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../screenshot/index.html"><code class="docutils literal notranslate"><span class="pre">screenshot</span></code> TIFF screenshot utility</a></li>
<li class="toctree-l3"><a class="reference internal" href="../slcd/index.html"><code class="docutils literal notranslate"><span class="pre">slcd</span></code> Segment LCD Emulaton</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tiff/index.html"><code class="docutils literal notranslate"><span class="pre">tiff</span></code> TIFF Creation Library</a></li>
<li class="toctree-l3"><a class="reference internal" href="../twm4nx/index.html"><code class="docutils literal notranslate"><span class="pre">twm4nx</span></code> Tab Window Manager (TWM)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../industry/index.html">Industrial Applications</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../inertial/index.html">Inertial Libraries Support</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../interpreters/index.html">Interpreters</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../logging/index.html">Logging Utilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../lte/index.html">LTE Libraries and NSH Add-Ons</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../math/index.html">Math Library Support</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../mlearing/index.html">Machine Learning Support</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../netutils/index.html">Network Utilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../nsh/index.html">NuttShell (NSH)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../sdr/index.html">Software Define Radio Libraries</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../system/index.html">System Libraries and NSH Add-Ons</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../testing/index.html">Testing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tools/index.html">Host Side Tools</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../wireless/index.html">Wireless Libraries and NSH Add-Ons</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../examples/index.html">Examples</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../implementation/index.html">Implementation Details</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../reference/index.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq/index.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/index.html">Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../glossary.html">Glossary</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">NuttX</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Applications</a></li>
          <li class="breadcrumb-item"><a href="../index.html">Graphics Support</a></li>
          <li class="breadcrumb-item"><a href="index.html"><code class="docutils literal notranslate"><span class="pre">nxwm</span></code> NuttX Tiny Window Manager (NxWM)</a></li>
      <li class="breadcrumb-item active">CNxConsole Keyboard Input</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../_sources/applications/graphics/nxwm/cnxconsole.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="cnxconsole-keyboard-input">
<h1>CNxConsole Keyboard Input<a class="headerlink" href="#cnxconsole-keyboard-input" title="Permalink to this heading"></a></h1>
<p><strong>Players</strong></p>
<p>Let’s look at the major players in the keyboard data transfer. This is much more
complex than you might initially think:</p>
<p><strong>Special Drivers</strong>
NxConsole Device. The NX console input comes through a special device driver that
is registered at <code class="docutils literal notranslate"><span class="pre">/dev/nxcon0</span></code> as part of early initialization.</p>
<p><strong>Kernel Threads</strong></p>
<ul class="simple">
<li><p><strong>NX Server Thread</strong> The NX Server is the graphics server command. It receives
messages from various sources, performs graphics actions, and forwards graphic
event messages to the correct window. Most of the time, the NX Server Thread was
waiting on a message queue to receive the next graphics event.</p></li>
<li><p><strong>NxConsole Threads</strong> Each NxConsole has a thread that was started when each
<code class="docutils literal notranslate"><span class="pre">NxWM::CNxConsole</span></code> instance was created by NxWM. Each <code class="docutils literal notranslate"><span class="pre">NxWM::CNxConsole</span></code>
thread opens the NxConsole driver at <code class="docutils literal notranslate"><span class="pre">/dev/nxcon0</span></code> and redirects stdin,
stdout, and stderr to/from that special device. Normally, the <code class="docutils literal notranslate"><span class="pre">NxWM::CNxConsole</span></code>
thread is stopped, just waiting on read for keyboard input to complete.</p></li>
</ul>
<p><strong>Application Threads</strong></p>
<ul class="simple">
<li><p><strong>NxWidgets Window Event Handler Thread</strong> <code class="docutils literal notranslate"><span class="pre">CNxServer::listener()</span></code> is an
application thread started by NxWidgets each time a new window is opened.
It receives window messages from the NX server and dispatches the messages
accordingly.</p></li>
<li><p><strong>Keyboard Listener Thread</strong> <code class="docutils literal notranslate"><span class="pre">CKeyboard::listener()</span></code> is an application thread
that is started by NxWM. It just listens for keyboard input and forwards it through
the graphics routing system.</p></li>
</ul>
<p>Now here is the sequence of events to get keyboard input from the stdin device to
the correct NxConsole.</p>
<ol class="arabic">
<li><p>Application Space / NxWidgets Window Event Handler Thread
Let’s start with the initial state of the NX Server Thread. Initially, it will
just want for messages from the NX Server.</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">NxWidgets/libnxwidgets/src/cnxserver.cxx</span></code>
<code class="docutils literal notranslate"><span class="pre">CNxServer::listener()</span></code> is it window listener thread. It just calls
<code class="docutils literal notranslate"><span class="pre">nx_eventhandler()</span></code> to receive and process server events. There is one
such listener thread per window.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">nuttx/libnx/nxwm/nx_eventhandler</span></code>
<code class="docutils literal notranslate"><span class="pre">nx_eventhandler()</span></code> waits to receive a message from the NX server. Each
window has its own message queue; each window instance has its own
<code class="docutils literal notranslate"><span class="pre">nx_eventhandler()</span></code> waiting for messages.</p></li>
</ul>
</div></blockquote>
</li>
<li><p>Application Space / Keyboard Listener Thread</p>
<p>Here are the immediate events that happen when the keyboard data is entered.
The Keyboard Listener Thread wakes up and forwards the Keyboard data to the
the NX Server. Only the NX Server knows which window should get the keyboard input.</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">NxWidgets\nxwm\src\ckeyboard.cxx</span></code>
<code class="docutils literal notranslate"><span class="pre">CKeyboard::listener()</span></code> is a tiny thread that is started by NxWM that just
listens for keyboard input. It opens the keyboard device and waits on a <code class="docutils literal notranslate"><span class="pre">read()</span></code>
from the keyboard device to receive the next keyboard input. When data is
returned by reading from the keyboard device, <code class="docutils literal notranslate"><span class="pre">CKeyboard::listener()</span></code>
calls <code class="docutils literal notranslate"><span class="pre">nx_kbdin()</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">nuttx\libnx\nxmu\nx_kbdin.c</span></code>
This library function just hides the NX server messaging implementation.
It sends the <code class="docutils literal notranslate"><span class="pre">NX_SVRMSG_KBDIN</span></code> to the NX server thread.</p></li>
</ul>
</div></blockquote>
</li>
<li><p>Kernel Space / NX Server</p>
<p>The NX Server wakes up, receives the keyboard message, and forwards it to the
appropriate window.</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">nuttx/graphics/nxmu/nxmu/nxmu_server.c</span></code>
The receipt of the <code class="docutils literal notranslate"><span class="pre">NX_SVRMSG_KBDIN</span></code> message wakes up the NX server
thread. The NX server thread decodes the message and calls <code class="docutils literal notranslate"><span class="pre">nxmu_kbdin()</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">nuttx/graphics/nxconsole/nxmu_kbdin.c</span></code>
<code class="docutils literal notranslate"><span class="pre">nxmu_kbdin()</span></code> simply sends the <code class="docutils literal notranslate"><span class="pre">NX_CLIMSG_KBDIN</span></code> to the appropriate
windows client via the client message queue associated with the window.</p></li>
</ul>
</div></blockquote>
</li>
<li><p>Application Space / NxWidgets Window Event Handler Thread</p>
<p>The Windows client wakes up when the keyboard message is received. It forwards
the keyboard data to <code class="docutils literal notranslate"><span class="pre">/dev/nxcon0/</span></code> so that is can be available to the
NxConsole window.</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">nuttx/libnx/nxwm/nx_eventhandler</span></code>
The <code class="docutils literal notranslate"><span class="pre">nx_eventhandler()</span></code> logic running in the <code class="docutils literal notranslate"><span class="pre">CNxServer::listener()</span></code>
thread receives the <code class="docutils literal notranslate"><span class="pre">NX_CLIMSG_KBDIN</span></code> message and dispatches it to the
kbdin callback method. In this case that callback method maps to
<code class="docutils literal notranslate"><span class="pre">CCallback::newKeyboardEvent()</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">NxWidgets/libnxwidgets/src/ccallback.cxx</span></code>
For normal keyboard input, <code class="docutils literal notranslate"><span class="pre">CCallback::newKeyboardEvent()</span></code> directs the
Keyboard to the widget with focus via the <code class="docutils literal notranslate"><span class="pre">CWidgetControl::newKeyboardEvent()</span></code>
method. But the story is different for the NxConsole window. This case,
<code class="docutils literal notranslate"><span class="pre">CCallback::newKeyboardEvent()</span></code>, calls <code class="docutils literal notranslate"><span class="pre">nxcon_kbdin()</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">nuttx/graphics/nxconsole/nxcon_kbdin.c</span></code>
<code class="docutils literal notranslate"><span class="pre">nxcon_kbdin()</span></code> adds the keyboard data to a circular buffer and wakes up
any reads on the <code class="docutils literal notranslate"><span class="pre">/dev/nxcon0</span></code> input device.</p></li>
</ul>
</div></blockquote>
<p>NOTE: Here is a violation of the Application and Kernel Space boundaries.
<code class="docutils literal notranslate"><span class="pre">nxcon_kbdin.c</span></code> built into Kernel Space but it is called from Application
Space. The solution is to (1) move <code class="docutils literal notranslate"><span class="pre">nxcon_kbdin()</span></code> to <code class="docutils literal notranslate"><span class="pre">libnx/</span></code> and (2) it
should then communicate with the <code class="docutils literal notranslate"><span class="pre">/dev/nxcon9</span></code> driver via ioctl calls.
This will become a problem some day.</p>
</li>
<li><p>Kernel Space / NxConsole Thread</p>
<dl class="simple">
<dt>Finally,</dt><dd><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">nuttx/graphics/nxconsole/nxcon_kbdin.c</span></code>
The receipt and enqueuing of keyboard data by <code class="docutils literal notranslate"><span class="pre">nxcon_kbdin()</span></code> wakes up
any threads waiting in the <code class="docutils literal notranslate"><span class="pre">nxcon_read()</span></code> method. This is how the
NxConsole gets its keyboard input.</p></li>
</ul>
</dd>
</dl>
</li>
</ol>
<p><strong>Mouse Input</strong>
Almost everything said here applies to mouse/touchscreen input as well. If we
were to replace the names keyboard to mouse, kbdin to mousein, etc. you have a
pretty good description of how mouse/touchscreen input works.</p>
<p>The mouse/touchscreen input is a little simpler, however: The main simplication
is that the additional complexities of the NxConsole and its special input device
do not apply. Mouse/touchscreen input as always steered to widgets when the
callback is received in <code class="docutils literal notranslate"><span class="pre">CCallback::newMouseEvent</span></code> by an unconditional call to
<code class="docutils literal notranslate"><span class="pre">CWidgetControl::newMouseEvent</span></code>. There is a “fork in the road” at the
corresponding point in the logic of <code class="docutils literal notranslate"><span class="pre">CCallback::newKeyboardEvent</span></code></p>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="index.html" class="btn btn-neutral float-left" title="nxwm NuttX Tiny Window Manager (NxWM)" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../pdcurs34/index.html" class="btn btn-neutral float-right" title="pdcurs34 pdcurses Text User Interface (TUI)" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, The Apache Software Foundation.</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>