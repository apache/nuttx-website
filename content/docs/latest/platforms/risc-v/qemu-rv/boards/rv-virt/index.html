<!--
 Documentation/_templates/layout.html

 Licensed to the Apache Software Foundation (ASF) under one or more
 contributor license agreements.  See the NOTICE file distributed with
 this work for additional information regarding copyright ownership.  The
 ASF licenses this file to you under the Apache License, Version 2.0 (the
 "License"); you may not use this file except in compliance with the
 License.  You may obtain a copy of the License at

   http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
 WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 License for the specific language governing permissions and limitations
 under the License.
-->

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>rv-virt &mdash; NuttX latest documentation</title>
      <link rel="stylesheet" href="../../../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../../../_static/copybutton.css" type="text/css" />
      <link rel="stylesheet" href="../../../../../_static/tabs.css" type="text/css" />
      <link rel="stylesheet" href="../../../../../_static/custom.css" type="text/css" />
    <link rel="shortcut icon" href="../../../../../_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="../../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../../../_static/jquery.js"></script>
        <script src="../../../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../../../../../" id="documentation_options" src="../../../../../_static/documentation_options.js"></script>
        <script src="../../../../../_static/doctools.js"></script>
        <script src="../../../../../_static/sphinx_highlight.js"></script>
        <script src="../../../../../_static/clipboard.min.js"></script>
        <script src="../../../../../_static/copybutton.js"></script>
    <script src="../../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" />
    <link rel="next" title="NXP RV32M1" href="../../../rv32m1/index.html" />
    <link rel="prev" title="QEMU Generic RV32/RV64" href="../../index.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
  
    <a href="../../../../../index.html" class="icon icon-home"> NuttX
  

  
  </a>

  <!-- this version selector is quite ugly, should be probably replaced by something
       more modern -->

  <div class="version-selector">
    <select onchange="javascript:location.href = this.value;">
    
    <option value="../../../../../../latest" selected="selected">latest</option>
    
    <option value="../../../../../../10.0.0" >10.0.0</option>
    
    <option value="../../../../../../10.0.1" >10.0.1</option>
    
    <option value="../../../../../../10.1.0" >10.1.0</option>
    
    <option value="../../../../../../10.2.0" >10.2.0</option>
    
    <option value="../../../../../../10.3.0" >10.3.0</option>
    
    <option value="../../../../../../11.0.0" >11.0.0</option>
    
    <option value="../../../../../../12.0.0" >12.0.0</option>
    
    <option value="../../../../../../12.1.0" >12.1.0</option>
    
    <option value="../../../../../../12.2.0" >12.2.0</option>
    
    <option value="../../../../../../12.2.1" >12.2.1</option>
    
    <option value="../../../../../../12.3.0" >12.3.0</option>
    
    <option value="../../../../../../12.4.0" >12.4.0</option>
    
    <option value="../../../../../../12.5.0" >12.5.0</option>
    
    <option value="../../../../../../12.5.1" >12.5.1</option>
    
    </select>
  </div>

  
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Table of Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../../../index.html">Home</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../introduction/index.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../quickstart/index.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../contributing/index.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../introduction/inviolables.html">The Inviolable Principles of NuttX</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../../../index.html">Supported Platforms</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../../../arm/index.html">ARM</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../arm64/index.html">ARM64</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../avr/index.html">Microchip AVR</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../ceva/index.html">CEVA</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../hc/index.html">HC</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../mips/index.html">MIPS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../misco/index.html">Misoc</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../or1k/index.html">OpenRISC</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../renesas/index.html">Renesas</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../../../index.html">RISC-V</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../../../bl602/index.html">Bouffalo Lab BL602</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../bl808/index.html">Bouffalo Lab BL808</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../c906/index.html">THEAD C906</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../esp32c3-legacy/index.html">Espressif ESP32-C3 (Legacy)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../esp32c3/index.html">Espressif ESP32-C3</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../esp32c6/index.html">Espressif ESP32-C6</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../esp32h2/index.html">Espressif ESP32-H2</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../fe310/index.html">SiFive FE310</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../hpm6750/index.html">Hpmicro HPM6750</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../jh7110/index.html">StarFive JH7110</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../k210/index.html">Kendryte K210</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../k230/index.html">Kendryte K230</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../litex/index.html">Enjoy Digital LiteX FPGA’s</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../mpfs/index.html">Microchip PolarFire® SoC FPGA’s (MPFS)</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="../../index.html">QEMU Generic RV32/RV64</a><ul class="current">
<li class="toctree-l4 current"><a class="reference internal" href="../../index.html#supported-boards">Supported Boards</a><ul class="current">
<li class="toctree-l5 current"><a class="current reference internal" href="#">rv-virt</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../rv32m1/index.html">NXP RV32M1</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../sg2000/index.html">SOPHGO SG2000</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../sim/index.html">Simulators</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../sparc/index.html">SPARC</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../tricore/index.html">TriCore</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../x86/index.html">Intel 80x86</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../x86_64/index.html">Intel 80x86_64</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../xtensa/index.html">Xtensa</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../z16/index.html">Z16</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../z80/index.html">Z80</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../components/index.html">OS Components</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../applications/index.html">Applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../implementation/index.html">Implementation Details</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../reference/index.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../faq/index.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../guides/index.html">Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../logos/index.html">NuttX Logos</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../index.html">NuttX</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../../index.html">Supported Platforms</a></li>
          <li class="breadcrumb-item"><a href="../../../index.html">RISC-V</a></li>
          <li class="breadcrumb-item"><a href="../../index.html">QEMU Generic RV32/RV64</a></li>
      <li class="breadcrumb-item active">rv-virt</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../../../_sources/platforms/risc-v/qemu-rv/boards/rv-virt/index.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="rv-virt">
<h1>rv-virt<a class="headerlink" href="#rv-virt" title="Permalink to this heading"></a></h1>
<section id="risc-v-toolchain">
<h2>RISC-V Toolchain<a class="headerlink" href="#risc-v-toolchain" title="Permalink to this heading"></a></h2>
<p>Any generic RISC-V toolchain can be used. It’s recommended to use the same toolchain used by NuttX CI.</p>
<p>Please refer to the <a class="reference external" href="https://github.com/apache/nuttx/tree/master/tools/ci/docker/linux/Dockerfile">Docker container</a> and
check for the current compiler version being used. For instance:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>###############################################################################
# Build image for tool required by RISCV builds
###############################################################################
FROM nuttx-toolchain-base AS nuttx-toolchain-riscv
# Download the latest RISCV GCC toolchain prebuilt by xPack
RUN mkdir riscv-none-elf-gcc &amp;&amp; \
curl -s -L &quot;https://github.com/xpack-dev-tools/riscv-none-elf-gcc-xpack/releases/download/v13.2.0-2/xpack-riscv-none-elf-gcc-13.2.0-2-linux-x64.tar.gz&quot; \
| tar -C riscv-none-elf-gcc --strip-components 1 -xz
</pre></div>
</div>
<p>It uses the xPack’s prebuilt toolchain based on GCC 13.2.0-2.</p>
</section>
<section id="risc-v-qemu">
<h2>RISC-V QEMU<a class="headerlink" href="#risc-v-qemu" title="Permalink to this heading"></a></h2>
<p>Build and install <code class="docutils literal notranslate"><span class="pre">qemu</span></code>:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ git clone https://github.com/qemu/qemu
$ cd qemu
$ ./configure --target-list=riscv32-softmmu,riscv64-softmmu
$ make
$ sudo make install
</pre></div>
</div>
</section>
<section id="minimum-requirement">
<h2>Minimum Requirement<a class="headerlink" href="#minimum-requirement" title="Permalink to this heading"></a></h2>
<p>The table below lists all the minimum versions for QEMU and OpenSBI.
For stability, it is also recommended to use the latest QEMU and OpenSBI.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Extension</p></th>
<th class="head"><p>QEMU Version</p></th>
<th class="head"><p>OpenSBI Version</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>No extension</p></td>
<td><p>6.2.0</p></td>
<td><p>v1.0</p></td>
</tr>
<tr class="row-odd"><td><p>SSTC</p></td>
<td><p>7.2.9</p></td>
<td><p>v1.1</p></td>
</tr>
<tr class="row-even"><td><p>AIA</p></td>
<td><p>8.2.0</p></td>
<td><p>v1.2</p></td>
</tr>
</tbody>
</table>
<p>For users who wish to use their own OpenSBI, please refer to <a class="reference external" href="https://github.com/riscv-software-src/opensbi">OpenSBI repository</a>.</p>
</section>
<section id="configurations">
<h2>Configurations<a class="headerlink" href="#configurations" title="Permalink to this heading"></a></h2>
<p>All of the configurations presented below can be tested by running the following commands:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ ./tools/configure.sh rv-virt:&lt;config_name&gt;
</pre></div>
</div>
<p>Where &lt;config_name&gt; is the name of the configuration you want to use, i.e.: nsh, knsh32, knsh64…</p>
<p>To build it, run the following command:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ make -j$(nproc)
</pre></div>
</div>
<p>or, with more verbosity:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ make V=1 -j$(nproc)
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Some configurations require additional steps to be built. Please refer to the specific
configurations to check it out</p>
</div>
<p>Finally, to run it, use the following command:</p>
<p>For 32-bit configurations:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ qemu-system-riscv32 -semihosting -M virt,aclint=on -cpu rv32 -smp &lt;cpu number&gt; -bios none -kernel nuttx -nographic
</pre></div>
</div>
<p>And, for 64-bit configurations:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ qemu-system-riscv64 -semihosting -M virt,aclint=on -cpu rv64 -smp &lt;cpu number&gt; -bios none -kernel nuttx -nographic
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">-smp</span></code> option can be only used in smp build, and the <code class="docutils literal notranslate"><span class="pre">cpu</span> <span class="pre">number</span></code> needs
to be set to the same value as <code class="docutils literal notranslate"><span class="pre">CONFIG_SMP_NCPUS</span></code> in the build config file.</p>
<p>If testing with S-mode build, remove the <code class="docutils literal notranslate"><span class="pre">-bios</span> <span class="pre">none</span></code> option. S-mode build
requires SBI to function properly.</p>
<p>For BUILD_PROTECTED the user-space binary must also be loaded, which can be
done by adding <code class="docutils literal notranslate"><span class="pre">-device</span> <span class="pre">loader,file=./nuttx_user</span></code> to the command line
arguments.</p>
<section id="citest">
<h3>citest<a class="headerlink" href="#citest" title="Permalink to this heading"></a></h3>
<p>This configuration is the default configuration intended to be used by the automated
testing on CI of 32-bit RISC-V using QEMU.</p>
<p>To run it with QEMU, use the following command:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ qemu-system-riscv32 -semihosting -M virt -cpu rv32 \
  -drive index=0,id=userdata,if=none,format=raw,file=./fatfs.img \
  -device virtio-blk-device,bus=virtio-mmio-bus.0,drive=userdata \
  -bios none -kernel nuttx -nographic
</pre></div>
</div>
<p>To run the CI scripts, use the following command:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ ./nuttx/boards/risc-v/qemu-rv/rv-virt/configs/citest/run
</pre></div>
</div>
</section>
<section id="citest64">
<h3>citest64<a class="headerlink" href="#citest64" title="Permalink to this heading"></a></h3>
<p>Identical to the <a class="reference internal" href="#citest">citest</a> configuration, but for 64-bit RISC-V.</p>
</section>
<section id="fb">
<h3>fb<a class="headerlink" href="#fb" title="Permalink to this heading"></a></h3>
<p>Uses the VirtIO GPU driver to run the <cite>fb</cite> demo application on 32-bit RISC-V.</p>
<p>To run it with QEMU, use the following command:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ qemu-system-riscv32 -semihosting -M virt -cpu rv32 -smp 8 \
  -chardev stdio,id=con,mux=on \
  -serial chardev:con \
  -device virtio-gpu-device,xres=640,yres=480,bus=virtio-mmio-bus.0 \
  -mon chardev=con,mode=readline \
  -bios none -kernel nuttx
</pre></div>
</div>
</section>
<section id="fb64">
<h3>fb64<a class="headerlink" href="#fb64" title="Permalink to this heading"></a></h3>
<p>Identical to the <a class="reference internal" href="#fb">fb</a> configuration, but for 64-bit RISC-V.</p>
<p>To run it with QEMU, use the following command:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ qemu-system-riscv64 -semihosting -M virt -cpu rv64 -smp 8 \
  -chardev stdio,id=con,mux=on \
  -serial chardev:con \
  -device virtio-gpu-device,xres=640,yres=480,bus=virtio-mmio-bus.0 \
  -mon chardev=con,mode=readline \
  -bios none -kernel nuttx
</pre></div>
</div>
</section>
<section id="knetnsh64">
<h3>knetnsh64<a class="headerlink" href="#knetnsh64" title="Permalink to this heading"></a></h3>
<p>Similar to the <a class="reference internal" href="#knsh32">knsh32</a> configuration, but with networking support and 64-bit RISC-V.</p>
<p>To run it with QEMU, use the following command:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ dd if=/dev/zero of=./mydisk-1gb.img bs=1M count=1024

$ qemu-system-riscv64 -semihosting -M virt,aclint=on -cpu rv64 -smp 8 \
  -global virtio-mmio.force-legacy=false \
  -device virtio-serial-device,bus=virtio-mmio-bus.0 \
  -chardev socket,telnet=on,host=127.0.0.1,port=3450,server=on,wait=off,id=foo \
  -device virtconsole,chardev=foo \
  -device virtio-rng-device,bus=virtio-mmio-bus.1 \
  -netdev user,id=u1,hostfwd=tcp:127.0.0.1:10023-10.0.2.15:23,hostfwd=tcp:127.0.0.1:15001-10.0.2.15:5001 \
  -device virtio-net-device,netdev=u1,bus=virtio-mmio-bus.2 \
  -drive file=./mydisk-1gb.img,if=none,format=raw,id=hd \
  -device virtio-blk-device,bus=virtio-mmio-bus.3,drive=hd \
  -kernel ./nuttx/nuttx -nographic
</pre></div>
</div>
</section>
<section id="knetnsh64-smp">
<h3>knetnsh64_smp<a class="headerlink" href="#knetnsh64-smp" title="Permalink to this heading"></a></h3>
<p>Similar to the <a class="reference internal" href="#knetnsh64">knetnsh64</a> configuration, but with SMP support for 64-bit RISC-V.</p>
</section>
<section id="knsh32">
<h3>knsh32<a class="headerlink" href="#knsh32" title="Permalink to this heading"></a></h3>
<p>This is similar to the <a class="reference internal" href="#nsh">nsh</a> configuration except that NuttX
is built as a kernel-mode, monolithic module, and the user applications
are built separately. It uses <cite>hostfs</cite> and QEMU in semi-hosting mode to
load the user-space applications. This is intended to 32-bit RISC-V.</p>
<p>To build it, use the following command:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ make V=1 -j$(nproc)
$ make export V=1 -j$(nproc)
$ pushd ../apps
$ ./tools/mkimport.sh -z -x ../nuttx/nuttx-export-*.tar.gz
$ make import V=1 -j$(nproc)
$ popd
</pre></div>
</div>
<p>Run it with QEMU using the default command for 32-bit RISC-V.</p>
<p>In <cite>nsh</cite>, applications can be run from the <cite>/system/bin</cite> directory:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>nsh&gt; /system/bin/hello
</pre></div>
</div>
</section>
<section id="knsh32-paging">
<span id="id1"></span><h3>knsh32_paging<a class="headerlink" href="#knsh32-paging" title="Permalink to this heading"></a></h3>
<p>Similar to <code class="docutils literal notranslate"><span class="pre">knsh32_romfs</span></code>, but enabling on-demand paging: this
configuration simulates a 4MiB device (using QEMU), but sets the number of
heap pages equal to <code class="docutils literal notranslate"><span class="pre">CONFIG_ARCH_HEAP_NPAGES=2048</span></code>. This means that each
process’s heap is 8MiB, whereas <code class="docutils literal notranslate"><span class="pre">CONFIG_POSIX_SPAWN_DEFAULT_STACKSIZE</span></code> is
<code class="docutils literal notranslate"><span class="pre">1048576</span></code> (1MiB) represents the stack size of the processes (which is
allocated from the process’s heap). This configuration is used for 32-bit
RISC-V which implements the Sv32 MMU specification and enables processes
to have their own address space larger than the available physical memory.
This is particularly useful for implementing a set of programming language
interpreters.</p>
</section>
<section id="knsh32-romfs">
<h3>knsh32_romfs<a class="headerlink" href="#knsh32-romfs" title="Permalink to this heading"></a></h3>
<p>Similar to the <a class="reference internal" href="#knsh32">knsh32</a> configuration, but uses ROMFS instead of <cite>hostfs</cite>.
A ROMFS image is generated and linked to the kernel. This requires re-running <code class="docutils literal notranslate"><span class="pre">make</span></code>:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ make V=1 -j$(nproc)
$ make export V=1 -j$(nproc)
$ pushd ../apps
$ ./tools/mkimport.sh -z -x ../nuttx/nuttx-export-*.tar.gz
$ make import V=1 -j$(nproc)
$ ./tools/mkromfsimg.sh ../nuttx/arch/risc-v/src/board/romfs_boot.c
$ popd
$ make V=1 -j$(nproc)
</pre></div>
</div>
<p>To run it, use the following command:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ qemu-system-riscv32 -M virt,aclint=on -cpu rv32 -kernel nuttx -nographic
</pre></div>
</div>
<p>In <cite>nsh</cite>, applications can be run from the <cite>/system/bin</cite> directory:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>nsh&gt; /system/bin/hello
</pre></div>
</div>
</section>
<section id="knsh64">
<h3>knsh64<a class="headerlink" href="#knsh64" title="Permalink to this heading"></a></h3>
<p>Similar to the <a class="reference internal" href="#knsh32">knsh32</a> configuration, but for 64-bit RISC-V.</p>
<p>Run it with QEMU using the default command for 64-bit RISC-V.</p>
<p>In <cite>nsh</cite>, applications can be run from the <cite>/system/bin</cite> directory:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>nsh&gt; /system/bin/hello
</pre></div>
</div>
</section>
<section id="ksmp64">
<h3>ksmp64<a class="headerlink" href="#ksmp64" title="Permalink to this heading"></a></h3>
<p>Identical to the <a class="reference internal" href="#knsh64">knsh64</a> configuration but with SMP support.</p>
</section>
<section id="leds">
<h3>leds<a class="headerlink" href="#leds" title="Permalink to this heading"></a></h3>
<p>Similar to the <a class="reference internal" href="#nsh">nsh</a> configuration, but with User LEDs support for 32-bit RISC-V.</p>
</section>
<section id="leds64">
<h3>leds64<a class="headerlink" href="#leds64" title="Permalink to this heading"></a></h3>
<p>Similar to the <a class="reference internal" href="#nsh64">nsh64</a> configuration, but with User LEDs support for 64-bit RISC-V.</p>
</section>
<section id="netnsh">
<h3>netnsh<a class="headerlink" href="#netnsh" title="Permalink to this heading"></a></h3>
<p>Similar to the <a class="reference internal" href="#nsh">nsh</a> configuration, but with networking support for 32-bit RISC-V.</p>
<p>To run it with QEMU, use the following command:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ dd if=/dev/zero of=./mydisk-1gb.img bs=1M count=1024

$ qemu-system-riscv32 -semihosting -M virt,aclint=on -cpu rv32 -smp 8 \
  -global virtio-mmio.force-legacy=false \
  -device virtio-serial-device,bus=virtio-mmio-bus.0 \
  -chardev socket,telnet=on,host=127.0.0.1,port=3450,server=on,wait=off,id=foo \
  -device virtconsole,chardev=foo \
  -device virtio-rng-device,bus=virtio-mmio-bus.1 \
  -netdev user,id=u1,hostfwd=tcp:127.0.0.1:10023-10.0.2.15:23,hostfwd=tcp:127.0.0.1:15001-10.0.2.15:5001 \
  -device virtio-net-device,netdev=u1,bus=virtio-mmio-bus.2 \
  -drive file=./mydisk-1gb.img,if=none,format=raw,id=hd \
  -device virtio-blk-device,bus=virtio-mmio-bus.3,drive=hd \
  -bios none -kernel ./nuttx/nuttx -nographic
</pre></div>
</div>
</section>
<section id="netnsh64">
<h3>netnsh64<a class="headerlink" href="#netnsh64" title="Permalink to this heading"></a></h3>
<p>Similar to the <a class="reference internal" href="#netnsh">netnsh</a> configuration, but for 64-bit RISC-V.</p>
<p>To run it with QEMU, use the following command:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ dd if=/dev/zero of=./mydisk-1gb.img bs=1M count=1024

$ qemu-system-riscv64 -semihosting -M virt,aclint=on -cpu rv64 -smp 8 \
  -global virtio-mmio.force-legacy=false \
  -device virtio-serial-device,bus=virtio-mmio-bus.0 \
  -chardev socket,telnet=on,host=127.0.0.1,port=3450,server=on,wait=off,id=foo \
  -device virtconsole,chardev=foo \
  -device virtio-rng-device,bus=virtio-mmio-bus.1 \
  -netdev user,id=u1,hostfwd=tcp:127.0.0.1:10023-10.0.2.15:23,hostfwd=tcp:127.0.0.1:15001-10.0.2.15:5001 \
  -device virtio-net-device,netdev=u1,bus=virtio-mmio-bus.2 \
  -drive file=./mydisk-1gb.img,if=none,format=raw,id=hd \
  -device virtio-blk-device,bus=virtio-mmio-bus.3,drive=hd \
  -bios none -kernel ./nuttx/nuttx -nographic
</pre></div>
</div>
</section>
<section id="netnsh64-smp">
<h3>netnsh64_smp<a class="headerlink" href="#netnsh64-smp" title="Permalink to this heading"></a></h3>
<p>Similar to the <a class="reference internal" href="#netnsh64">netnsh64</a> configuration, but with SMP support for 64-bit RISC-V.</p>
<p>To run it with QEMU, use the following command:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ dd if=/dev/zero of=./mydisk-1gb.img bs=1M count=1024

$ qemu-system-riscv64 -semihosting -M virt,aclint=on -cpu rv64 -smp 8 \
  -global virtio-mmio.force-legacy=false \
  -device virtio-serial-device,bus=virtio-mmio-bus.0 \
  -chardev socket,telnet=on,host=127.0.0.1,port=3450,server=on,wait=off,id=foo \
  -device virtconsole,chardev=foo \
  -device virtio-rng-device,bus=virtio-mmio-bus.1 \
  -netdev user,id=u1,hostfwd=tcp:127.0.0.1:10023-10.0.2.15:23,hostfwd=tcp:127.0.0.1:15001-10.0.2.15:5001 \
  -device virtio-net-device,netdev=u1,bus=virtio-mmio-bus.2 \
  -drive file=./mydisk-1gb.img,if=none,format=raw,id=hd \
  -device virtio-blk-device,bus=virtio-mmio-bus.3,drive=hd \
  -bios none -kernel ./nuttx/nuttx -nographic
</pre></div>
</div>
</section>
<section id="netnsh-smp">
<h3>netnsh_smp<a class="headerlink" href="#netnsh-smp" title="Permalink to this heading"></a></h3>
<p>Similar to the <a class="reference internal" href="#netnsh">netnsh</a> configuration, but with SMP support for 32-bit RISC-V.</p>
<p>To run it with QEMU, use the following command:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ dd if=/dev/zero of=./mydisk-1gb.img bs=1M count=1024

$ qemu-system-riscv32 -semihosting -M virt,aclint=on -cpu rv32 -smp 8 \
  -global virtio-mmio.force-legacy=false \
  -device virtio-serial-device,bus=virtio-mmio-bus.0 \
  -chardev socket,telnet=on,host=127.0.0.1,port=3450,server=on,wait=off,id=foo \
  -device virtconsole,chardev=foo \
  -device virtio-rng-device,bus=virtio-mmio-bus.1 \
  -netdev user,id=u1,hostfwd=tcp:127.0.0.1:10023-10.0.2.15:23,hostfwd=tcp:127.0.0.1:15001-10.0.2.15:5001 \
  -device virtio-net-device,netdev=u1,bus=virtio-mmio-bus.2 \
  -drive file=./mydisk-1gb.img,if=none,format=raw,id=hd \
  -device virtio-blk-device,bus=virtio-mmio-bus.3,drive=hd \
  -bios none -kernel ./nuttx/nuttx -nographic
</pre></div>
</div>
</section>
<section id="nsh">
<h3>nsh<a class="headerlink" href="#nsh" title="Permalink to this heading"></a></h3>
<p>Configures the NuttShell (nsh) located at examples/nsh.  This NSH
configuration is focused on low-level, command-line driver testing.
This configuration is used for 32-bit RISC-V</p>
</section>
<section id="nsh64">
<h3>nsh64<a class="headerlink" href="#nsh64" title="Permalink to this heading"></a></h3>
<p>Identical to the <a class="reference internal" href="#nsh">nsh</a> configuration, but for 64-bit RISC-V.</p>
</section>
<section id="smp">
<h3>smp<a class="headerlink" href="#smp" title="Permalink to this heading"></a></h3>
<p>Similar to the <a class="reference internal" href="#nsh">nsh</a> configuration, but with SMP support.
This configuration is used for 32-bit RISC-V</p>
</section>
<section id="smp64">
<h3>smp64<a class="headerlink" href="#smp64" title="Permalink to this heading"></a></h3>
<p>Similar to the <a class="reference internal" href="#nsh">nsh</a> configuration, but with SMP support
This configuration is used for 64-bit RISC-V</p>
</section>
<section id="flats">
<h3>flats<a class="headerlink" href="#flats" title="Permalink to this heading"></a></h3>
<p>Similar to the <a class="reference internal" href="#nsh">nsh</a> configuration, but running in S-mode.
This configuration is used for 32-bit RISC-V</p>
</section>
<section id="flats64">
<h3>flats64<a class="headerlink" href="#flats64" title="Permalink to this heading"></a></h3>
<p>Similar to the <a class="reference internal" href="#nsh">nsh</a> configuration, but running in S-mode.
This configuration is used for 64-bit RISC-V</p>
</section>
<section id="virt-nsh">
<h3>virt_nsh<a class="headerlink" href="#virt-nsh" title="Permalink to this heading"></a></h3>
<p>Similar to <a class="reference internal" href="#nsh">nsh</a> configuration, but uses virtio serial device as console.
Use it below with QEMU:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ qemu-system-riscv32 -M virt,aclint=on -nographic \
-chardev socket,id=aux,path=/tmp/aux,server=on,wait=on \
-device virtio-serial-device,bus=virtio-mmio-bus.0 \
-device virtconsole,chardev=aux \
-bios nuttx
</pre></div>
</div>
<p>Then from another terminal, use below command to access the console:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ socat UNIX-CLIENT:/tmp/aux -
</pre></div>
</div>
<p>We can finish the session with <code class="docutils literal notranslate"><span class="pre">quit</span></code> command in NSH session.</p>
<p>Note the above command line uses UNIX domain socket so please change the socket parameters on hosts without UNIX domain socket.</p>
</section>
</section>
<section id="risc-v-gdb-debugging">
<h2>RISC-V GDB Debugging<a class="headerlink" href="#risc-v-gdb-debugging" title="Permalink to this heading"></a></h2>
<p>First of all, make sure to select <code class="docutils literal notranslate"><span class="pre">CONFIG_DEBUG_SYMBOLS=y</span></code> in <cite>menuconfig</cite>.</p>
<p>After building the kernel (and the applications, in kernel mode), use the toolchain’s GDB
to debug RISC-V applications. For instance, if you are using the xPack’s prebuilt toolchain,
you can use the following command to start GDB:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ riscv-none-elf-gdb-py3 -ix tools/gdb/__init__.py --tui nuttx
</pre></div>
</div>
<p>To use QEMU for debugging, one should add the parameters <code class="docutils literal notranslate"><span class="pre">-s</span> <span class="pre">-S</span></code> to the QEMU command line.</p>
<p>For instance:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ qemu-system-riscv32 -semihosting -M virt,aclint=on -cpu rv32 -smp 8 -bios none -kernel nuttx -nographic -s -S
</pre></div>
</div>
<p>Then, in GDB, use the following command to connect to QEMU:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ target extended-remote localhost:1234
</pre></div>
</div>
<section id="debugging-applications-in-kernel-mode">
<h3>Debugging Applications in Kernel Mode<a class="headerlink" href="#debugging-applications-in-kernel-mode" title="Permalink to this heading"></a></h3>
<p>In kernel mode, only the kernel symbols are loaded by default.</p>
<p>If needed, one should also load the application symbols using the following command:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ add-symbol-file &lt;file&gt; &lt;address&gt;
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">address</span></code> refers to the <code class="docutils literal notranslate"><span class="pre">.text</span></code> section of the application and can be retrieved from the ELF file using the following command:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ riscv-none-elf-readelf -WS &lt;file&gt; | grep .text
</pre></div>
</div>
<p>For instance, to check the <code class="docutils literal notranslate"><span class="pre">.text</span></code> section address of the <code class="docutils literal notranslate"><span class="pre">hello</span></code> application, use the following command:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ riscv-none-elf-readelf -WS ../apps/bin/hello | grep .text
[ 1] .text             PROGBITS        c0000000 001000 0009e0 00  AX  0   0  2
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Pay attention that <code class="docutils literal notranslate"><span class="pre">riscv-none-elf-readelf</span></code> refers to your toolchain’s readelf utility. Adjust accordingly if you are
using a different toolchain.</p>
</div>
<p>Then, look for the <code class="docutils literal notranslate"><span class="pre">.text</span></code> section address and use the <code class="docutils literal notranslate"><span class="pre">c0000000</span></code> as the address to load the symbols.</p>
<p>For instance, if you want to load the <code class="docutils literal notranslate"><span class="pre">hello</span></code> application, you can use the following command in GDB:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ add-symbol-file ../apps/bin/hello 0xc0000000
</pre></div>
</div>
<p>Then, you can set breakpoints, step through the code, and inspect the memory and registers of the applications too.</p>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../../index.html" class="btn btn-neutral float-left" title="QEMU Generic RV32/RV64" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../../../rv32m1/index.html" class="btn btn-neutral float-right" title="NXP RV32M1" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, The Apache Software Foundation.</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>