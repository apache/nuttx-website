<!--
 Documentation/_templates/layout.html

 Licensed to the Apache Software Foundation (ASF) under one or more
 contributor license agreements.  See the NOTICE file distributed with
 this work for additional information regarding copyright ownership.  The
 ASF licenses this file to you under the Apache License, Version 2.0 (the
 "License"); you may not use this file except in compliance with the
 License.  You may obtain a copy of the License at

   http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
 WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 License for the specific language governing permissions and limitations
 under the License.
-->



<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>QEMU ARMv8-A &mdash; NuttX latest documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../../_static/pygments.css" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/css/theme.css" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/copybutton.css" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/sphinx_collapse.css" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/custom.css" />

  
    <link rel="shortcut icon" href="../../../../../_static/favicon.ico"/>
      <script src="../../../../../_static/jquery.js"></script>
      <script src="../../../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
      <script data-url_root="../../../../../" id="documentation_options" src="../../../../../_static/documentation_options.js"></script>
      <script src="../../../../../_static/doctools.js"></script>
      <script src="../../../../../_static/sphinx_highlight.js"></script>
      <script src="../../../../../_static/clipboard.min.js"></script>
      <script src="../../../../../_static/copybutton.js"></script>
      <script src="../../../../../_static/design-tabs.js"></script>
    <script src="../../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" />
    <link rel="next" title="Rockchip rk3399" href="../../../rk3399/index.html" />
    <link rel="prev" title="qemu" href="../../index.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
  
    <a href="../../../../../index.html" class="icon icon-home"> NuttX
  

  
  </a>

  <!-- this version selector is quite ugly, should be probably replaced by something
       more modern -->

  <div class="version-selector">
    <select onchange="javascript:location.href = this.value;">
    
    <option value="../../../../../../latest" selected="selected">latest</option>
    
    <option value="../../../../../../10.0.0" >10.0.0</option>
    
    <option value="../../../../../../10.0.1" >10.0.1</option>
    
    <option value="../../../../../../10.1.0" >10.1.0</option>
    
    <option value="../../../../../../10.2.0" >10.2.0</option>
    
    <option value="../../../../../../10.3.0" >10.3.0</option>
    
    <option value="../../../../../../11.0.0" >11.0.0</option>
    
    <option value="../../../../../../12.0.0" >12.0.0</option>
    
    <option value="../../../../../../12.1.0" >12.1.0</option>
    
    <option value="../../../../../../12.2.0" >12.2.0</option>
    
    <option value="../../../../../../12.2.1" >12.2.1</option>
    
    <option value="../../../../../../12.3.0" >12.3.0</option>
    
    <option value="../../../../../../12.4.0" >12.4.0</option>
    
    <option value="../../../../../../12.5.0" >12.5.0</option>
    
    <option value="../../../../../../12.5.1" >12.5.1</option>
    
    <option value="../../../../../../12.6.0" >12.6.0</option>
    
    <option value="../../../../../../12.7.0" >12.7.0</option>
    
    <option value="../../../../../../12.8.0" >12.8.0</option>
    
    <option value="../../../../../../12.9.0" >12.9.0</option>
    
    <option value="../../../../../../12.10.0" >12.10.0</option>
    
    <option value="../../../../../../12.11.0" >12.11.0</option>
    
    </select>
  </div>

  
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Table of Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../../../index.html">Home</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../introduction/index.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../quickstart/index.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../contributing/index.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../introduction/inviolables.html">The Inviolable Principles of NuttX</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../../../index.html">Supported Platforms</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../../../arm/index.html">ARM</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../../../index.html">ARM64</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../../../a527/index.html">Allwinner A527</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../a64/index.html">Allwinner A64</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../bcm2711/index.html">BCM2711</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../fvp-v8r/index.html">fvp-v8r</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../imx8/index.html">NXP i.MX8</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../imx9/index.html">NXP i.MX9</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="../../index.html">qemu</a><ul class="current">
<li class="toctree-l4 current"><a class="reference internal" href="../../index.html#supported-boards">Supported Boards</a><ul class="current">
<li class="toctree-l5 current"><a class="current reference internal" href="#">QEMU ARMv8-A</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../rk3399/index.html">Rockchip rk3399</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../zynq-mpsoc/index.html">Zynq UltraScale+ MPSoC</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../avr/index.html">Microchip AVR</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../ceva/index.html">CEVA</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../hc/index.html">HC</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../mips/index.html">MIPS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../misco/index.html">Misoc</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../or1k/index.html">OpenRISC</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../renesas/index.html">Renesas</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../risc-v/index.html">RISC-V</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../sim/index.html">Simulators</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../sim/network_linux.html">Network Support on Linux</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../sim/network_vpnkit.html">Network support with VPNKit</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../sparc/index.html">SPARC</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../tricore/index.html">TriCore</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../x86/index.html">Intel 80x86</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../x86_64/index.html">Intel 80x86_64</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../xtensa/index.html">Xtensa</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../z16/index.html">Z16</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../z80/index.html">Z80</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../components/index.html">OS Components</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../applications/index.html">Applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../implementation/index.html">Implementation Details</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../reference/index.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../faq/index.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../debugging/index.html">Debugging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../guides/index.html">Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../standards/index.html">Standards</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../logos/index.html">NuttX Logos</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../_tags/tagsindex.html">Tags</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../index.html">NuttX</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../../index.html">Supported Platforms</a></li>
          <li class="breadcrumb-item"><a href="../../../index.html">ARM64</a></li>
          <li class="breadcrumb-item"><a href="../../index.html">qemu</a></li>
      <li class="breadcrumb-item active">QEMU ARMv8-A</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/apache/nuttx/blob/master/Documentation/platforms/arm64/qemu/boards/qemu-armv8a/index.rst" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="qemu-armv8-a">
<h1>QEMU ARMv8-A<a class="headerlink" href="#qemu-armv8-a" title="Permalink to this heading"></a></h1>
<p class="tags"><span>Tags: </span><a class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary reference internal" href="../../../../../_tags/chip-virt.html"><span class="doc">chip:virt</span></a><span> </span><a class="sd-sphinx-override sd-badge sd-bg-primary sd-bg-text-primary reference internal" href="../../../../../_tags/arch-arm64.html"><span class="doc">arch:arm64</span></a></p>
<p>This board configuration will use QEMU to emulate generic ARM64 v8-A series
hardware platform and provides support for these devices:</p>
<ul class="simple">
<li><p>GICv2 and GICv3 interrupt controllers</p></li>
<li><p>ARM Generic Timer</p></li>
<li><p>PL011 UART controller</p></li>
</ul>
<section id="getting-started">
<h2>Getting Started<a class="headerlink" href="#getting-started" title="Permalink to this heading"></a></h2>
<section id="compile-toolchain">
<h3>Compile Toolchain<a class="headerlink" href="#compile-toolchain" title="Permalink to this heading"></a></h3>
<ol class="arabic">
<li><p>Host environment: GNU/Linux: Ubuntu 18.04 or greater</p></li>
<li><p>Download and Install</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>wget<span class="w"> </span>https://developer.arm.com/-/media/Files/downloads/gnu/11.2-2022.02/binrel/gcc-arm-11.2-2022.02-x86_64-aarch64-none-elf.tar.xz
<span class="gp">$ </span>xz<span class="w"> </span>-d<span class="w"> </span>gcc-arm-11.2-2022.02-x86_64-aarch64-none-elf.tar.xz
<span class="gp">$ </span>tar<span class="w"> </span>xf<span class="w"> </span>gcc-arm-11.2-2022.02-x86_64-aarch64-none-elf.tar
</pre></div>
</div>
<p>Put <code class="docutils literal notranslate"><span class="pre">gcc-arm-11.2-2022.02-x86_64-aarch64-none-elf/bin/</span></code> on your host
<code class="docutils literal notranslate"><span class="pre">PATH</span></code> environment variable, like:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span><span class="nb">export</span><span class="w"> </span><span class="nv">PATH</span><span class="o">=</span><span class="nv">$PATH</span>:/opt/software/arm/linaro-toolchain/gcc-arm-11.2-2022.02-x86_64-aarch64-none-elf/bin
</pre></div>
</div>
<p>check the toolchain:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>aarch64-none-elf-gcc<span class="w"> </span>-v
</pre></div>
</div>
</li>
</ol>
</section>
<section id="install-qemu">
<h3>Install QEMU<a class="headerlink" href="#install-qemu" title="Permalink to this heading"></a></h3>
<p>In Ubuntu 18.04(or greater), install qemu:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>sudo<span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>qemu-system-arm<span class="w"> </span>qemu-efi-aarch64<span class="w"> </span>qemu-utils
</pre></div>
</div>
<p>And verify your installation worked properly:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>qemu-system-aarch64<span class="w"> </span>--help
</pre></div>
</div>
</section>
<section id="configuring-and-running">
<h3>Configuring and Running<a class="headerlink" href="#configuring-and-running" title="Permalink to this heading"></a></h3>
<section id="single-core-gicv3">
<h4>Single Core (GICv3)<a class="headerlink" href="#single-core-gicv3" title="Permalink to this heading"></a></h4>
<p>Configuring NuttX and compile:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>./tools/configure.sh<span class="w"> </span>-l<span class="w"> </span>qemu-armv8a:nsh
<span class="gp">$ </span>make
</pre></div>
</div>
<p>Running with QEMU:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>qemu-system-aarch64<span class="w"> </span>-cpu<span class="w"> </span>cortex-a53<span class="w"> </span>-nographic<span class="w"> </span><span class="se">\</span>
<span class="w"> </span>-machine<span class="w"> </span>virt,virtualization<span class="o">=</span>on,gic-version<span class="o">=</span><span class="m">3</span><span class="w"> </span><span class="se">\</span>
<span class="w"> </span>-net<span class="w"> </span>none<span class="w"> </span>-chardev<span class="w"> </span>stdio,id<span class="o">=</span>con,mux<span class="o">=</span>on<span class="w"> </span>-serial<span class="w"> </span>chardev:con<span class="w"> </span><span class="se">\</span>
<span class="w"> </span>-mon<span class="w"> </span><span class="nv">chardev</span><span class="o">=</span>con,mode<span class="o">=</span>readline<span class="w"> </span>-kernel<span class="w"> </span>./nuttx
</pre></div>
</div>
</section>
<section id="single-core-with-virtio-network-block-rng-serial-driver-gicv3">
<h4>Single Core with virtio network, block, rng, serial driver (GICv3)<a class="headerlink" href="#single-core-with-virtio-network-block-rng-serial-driver-gicv3" title="Permalink to this heading"></a></h4>
<p>Configuring NuttX and compile:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>./tools/configure.sh<span class="w"> </span>-l<span class="w"> </span>qemu-armv8a:netnsh
<span class="gp">$ </span>make
<span class="gp">$ </span>dd<span class="w"> </span><span class="k">if</span><span class="o">=</span>/dev/zero<span class="w"> </span><span class="nv">of</span><span class="o">=</span>./mydisk-1gb.img<span class="w"> </span><span class="nv">bs</span><span class="o">=</span>1M<span class="w"> </span><span class="nv">count</span><span class="o">=</span><span class="m">1024</span>
</pre></div>
</div>
<p>Running with QEMU:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>qemu-system-aarch64<span class="w"> </span>-cpu<span class="w"> </span>cortex-a53<span class="w"> </span>-nographic<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-machine<span class="w"> </span>virt,virtualization<span class="o">=</span>on,gic-version<span class="o">=</span><span class="m">3</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-chardev<span class="w"> </span>stdio,id<span class="o">=</span>con,mux<span class="o">=</span>on<span class="w"> </span>-serial<span class="w"> </span>chardev:con<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-global<span class="w"> </span>virtio-mmio.force-legacy<span class="o">=</span><span class="nb">false</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-device<span class="w"> </span>virtio-serial-device,bus<span class="o">=</span>virtio-mmio-bus.0<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-chardev<span class="w"> </span>socket,telnet<span class="o">=</span>on,host<span class="o">=</span><span class="m">127</span>.0.0.1,port<span class="o">=</span><span class="m">3450</span>,server<span class="o">=</span>on,wait<span class="o">=</span>off,id<span class="o">=</span>foo<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-device<span class="w"> </span>virtconsole,chardev<span class="o">=</span>foo<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-device<span class="w"> </span>virtio-rng-device,bus<span class="o">=</span>virtio-mmio-bus.1<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-netdev<span class="w"> </span>user,id<span class="o">=</span>u1,hostfwd<span class="o">=</span>tcp:127.0.0.1:10023-10.0.2.15:23,hostfwd<span class="o">=</span>tcp:127.0.0.1:15001-10.0.2.15:5001<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-device<span class="w"> </span>virtio-net-device,netdev<span class="o">=</span>u1,bus<span class="o">=</span>virtio-mmio-bus.2<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-drive<span class="w"> </span><span class="nv">file</span><span class="o">=</span>./mydisk-1gb.img,if<span class="o">=</span>none,format<span class="o">=</span>raw,id<span class="o">=</span>hd<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-device<span class="w"> </span>virtio-blk-device,bus<span class="o">=</span>virtio-mmio-bus.3,drive<span class="o">=</span>hd<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-mon<span class="w"> </span><span class="nv">chardev</span><span class="o">=</span>con,mode<span class="o">=</span>readline<span class="w"> </span>-kernel<span class="w"> </span>./nuttx
</pre></div>
</div>
</section>
<section id="single-core-with-virtio-gpu-driver-gicv3">
<h4>Single Core with virtio gpu driver (GICv3)<a class="headerlink" href="#single-core-with-virtio-gpu-driver-gicv3" title="Permalink to this heading"></a></h4>
<p>Configuring NuttX and compile:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>./tools/configure.sh<span class="w"> </span>qemu-armv8a:fb
<span class="gp">$ </span>make<span class="w"> </span>-j
</pre></div>
</div>
<p>Running with QEMU:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>qemu-system-aarch64<span class="w"> </span>-cpu<span class="w"> </span>cortex-a53<span class="w"> </span><span class="se">\</span>
<span class="w"> </span>-machine<span class="w"> </span>virt,virtualization<span class="o">=</span>on,gic-version<span class="o">=</span><span class="m">3</span><span class="w"> </span><span class="se">\</span>
<span class="w"> </span>-chardev<span class="w"> </span>stdio,id<span class="o">=</span>con,mux<span class="o">=</span>on<span class="w"> </span>-serial<span class="w"> </span>chardev:con<span class="w"> </span><span class="se">\</span>
<span class="w"> </span>-global<span class="w"> </span>virtio-mmio.force-legacy<span class="o">=</span><span class="nb">false</span><span class="w"> </span><span class="se">\</span>
<span class="w"> </span>-device<span class="w"> </span>virtio-gpu-device,xres<span class="o">=</span><span class="m">640</span>,yres<span class="o">=</span><span class="m">480</span>,bus<span class="o">=</span>virtio-mmio-bus.0<span class="w"> </span><span class="se">\</span>
<span class="w"> </span>-mon<span class="w"> </span><span class="nv">chardev</span><span class="o">=</span>con,mode<span class="o">=</span>readline<span class="w"> </span>-kernel<span class="w"> </span>./nuttx

<span class="go">NuttShell (NSH) NuttX-10.4.0</span>
<span class="go">nsh&gt; fb</span>
</pre></div>
</div>
</section>
<section id="single-core-with-virtio-9pfs-gicv3">
<h4>Single Core with virtio 9pFs (GICv3)<a class="headerlink" href="#single-core-with-virtio-9pfs-gicv3" title="Permalink to this heading"></a></h4>
<p>Configuring NuttX and compile:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>./tools/configure.sh<span class="w"> </span>qemu-armv8a:netnsh
<span class="gp">$ </span>make<span class="w"> </span>-j
</pre></div>
</div>
<p>Running with QEMU:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>qemu-system-aarch64<span class="w"> </span>-cpu<span class="w"> </span>cortex-a53<span class="w"> </span>-nographic<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-machine<span class="w"> </span>virt,virtualization<span class="o">=</span>on,gic-version<span class="o">=</span><span class="m">3</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-fsdev<span class="w"> </span>local,security_model<span class="o">=</span>none,id<span class="o">=</span>fsdev0,path<span class="o">=</span>/mnt/xxx<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-device<span class="w"> </span>virtio-9p-device,id<span class="o">=</span>fs0,fsdev<span class="o">=</span>fsdev0,mount_tag<span class="o">=</span>host<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-chardev<span class="w"> </span>stdio,id<span class="o">=</span>con,mux<span class="o">=</span>on,<span class="w"> </span>-serial<span class="w"> </span>chardev:con<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-mon<span class="w"> </span><span class="nv">chardev</span><span class="o">=</span>con,mode<span class="o">=</span>readline<span class="w">  </span>-kernel<span class="w"> </span>./nuttx

<span class="go">NuttShell (NSH) NuttX-10.4.0</span>
<span class="go">nsh&gt; mkdir mnt</span>
<span class="go">nsh&gt; mount -t v9fs -o trans=virtio,tag=host mnt</span>
<span class="go">nsh&gt; ls</span>
<span class="go">/:</span>
<span class="go"> dev/</span>
<span class="go"> mnt/</span>
<span class="go"> proc/</span>
</pre></div>
</div>
</section>
<section id="single-core-with-mte-expansion-gicv3">
<h4>Single Core with MTE Expansion (GICv3)<a class="headerlink" href="#single-core-with-mte-expansion-gicv3" title="Permalink to this heading"></a></h4>
<p>Configuring NuttX and compile:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>./tools/configure.sh<span class="w"> </span>qemu-armv8a:mte
<span class="gp">$ </span>make<span class="w"> </span>-j
</pre></div>
</div>
<p>Running with QEMU:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>qemu-system-aarch64<span class="w"> </span>-cpu<span class="w"> </span>max<span class="w"> </span>-nographic<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-machine<span class="w"> </span>virt,virtualization<span class="o">=</span>on,gic-version<span class="o">=</span><span class="m">3</span>,mte<span class="o">=</span>on<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-chardev<span class="w"> </span>stdio,id<span class="o">=</span>con,mux<span class="o">=</span>on,<span class="w"> </span>-serial<span class="w"> </span>chardev:con<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-mon<span class="w"> </span><span class="nv">chardev</span><span class="o">=</span>con,mode<span class="o">=</span>readline<span class="w">  </span>-kernel<span class="w"> </span>./nuttx/nuttx

<span class="go">NuttShell (NSH) NuttX-10.4.0</span>
<span class="go">nsh&gt; mtetest</span>
</pre></div>
</div>
</section>
<section id="smp-gicv3">
<h4>SMP (GICv3)<a class="headerlink" href="#smp-gicv3" title="Permalink to this heading"></a></h4>
<p>Configuring NuttX and compile:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>./tools/configure.sh<span class="w"> </span>-l<span class="w"> </span>qemu-armv8a:nsh_smp
<span class="gp">$ </span>make
</pre></div>
</div>
<p>Running with QEMU:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>qemu-system-aarch64<span class="w"> </span>-cpu<span class="w"> </span>cortex-a53<span class="w"> </span>-smp<span class="w"> </span><span class="m">4</span><span class="w"> </span>-nographic<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>-machine<span class="w"> </span>virt,virtualization<span class="o">=</span>on,gic-version<span class="o">=</span><span class="m">3</span><span class="w"> </span><span class="se">\</span>
<span class="w">   </span>-net<span class="w"> </span>none<span class="w"> </span>-chardev<span class="w"> </span>stdio,id<span class="o">=</span>con,mux<span class="o">=</span>on<span class="w"> </span>-serial<span class="w"> </span>chardev:con<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>-mon<span class="w"> </span><span class="nv">chardev</span><span class="o">=</span>con,mode<span class="o">=</span>readline<span class="w"> </span>-kernel<span class="w"> </span>./nuttx
</pre></div>
</div>
</section>
<section id="smp-gicv3-netnsh">
<h4>SMP (GICv3) netnsh<a class="headerlink" href="#smp-gicv3-netnsh" title="Permalink to this heading"></a></h4>
<p>Configuring NuttX and compile:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>./tools/configure.sh<span class="w"> </span>-l<span class="w"> </span>qemu-armv8a:netnsh_smp
<span class="gp">$ </span>make
</pre></div>
</div>
<p>Running with QEMU:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>qemu-system-aarch64<span class="w"> </span>-cpu<span class="w"> </span>cortex-a53<span class="w"> </span>-smp<span class="w"> </span><span class="m">4</span><span class="w"> </span>-nographic<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-machine<span class="w"> </span>virt,virtualization<span class="o">=</span>on,gic-version<span class="o">=</span><span class="m">3</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-chardev<span class="w"> </span>stdio,id<span class="o">=</span>con,mux<span class="o">=</span>on<span class="w"> </span>-serial<span class="w"> </span>chardev:con<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-global<span class="w"> </span>virtio-mmio.force-legacy<span class="o">=</span><span class="nb">false</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-netdev<span class="w"> </span>user,id<span class="o">=</span>u1,hostfwd<span class="o">=</span>tcp:127.0.0.1:10023-10.0.2.15:23,hostfwd<span class="o">=</span>tcp:127.0.0.1:15001-10.0.2.15:5001<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-device<span class="w"> </span>virtio-net-device,netdev<span class="o">=</span>u1,bus<span class="o">=</span>virtio-mmio-bus.0<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-mon<span class="w"> </span><span class="nv">chardev</span><span class="o">=</span>con,mode<span class="o">=</span>readline<span class="w"> </span>-kernel<span class="w"> </span>./nuttx
</pre></div>
</div>
</section>
<section id="single-core-gicv2">
<h4>Single Core (GICv2)<a class="headerlink" href="#single-core-gicv2" title="Permalink to this heading"></a></h4>
<p>Configuring NuttX and compile:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>./tools/configure.sh<span class="w"> </span>-l<span class="w"> </span>qemu-armv8a:nsh_gicv2
<span class="gp">$ </span>make
</pre></div>
</div>
<p>Running with QEMU:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>qemu-system-aarch64<span class="w"> </span>-cpu<span class="w"> </span>cortex-a53<span class="w"> </span>-nographic<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-machine<span class="w"> </span>virt,virtualization<span class="o">=</span>on,gic-version<span class="o">=</span><span class="m">2</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-net<span class="w"> </span>none<span class="w"> </span>-chardev<span class="w"> </span>stdio,id<span class="o">=</span>con,mux<span class="o">=</span>on<span class="w"> </span>-serial<span class="w"> </span>chardev:con<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-mon<span class="w"> </span><span class="nv">chardev</span><span class="o">=</span>con,mode<span class="o">=</span>readline<span class="w"> </span>-kernel<span class="w"> </span>./nuttx
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<ol class="arabic simple">
<li><p>Make sure the <code class="docutils literal notranslate"><span class="pre">aarch64-none-elf</span></code> toolchain install <code class="docutils literal notranslate"><span class="pre">PATH</span></code> has been
added to the environment variables.</p></li>
<li><p>To quit QEMU, type Ctrl + X.</p></li>
<li><p>Nuttx default core number is 4, and Changing <code class="docutils literal notranslate"><span class="pre">CONFIG_SMP_NCPUS</span> <span class="pre">&gt;</span> <span class="pre">4</span></code> and
setting QEMU command option <code class="docutils literal notranslate"><span class="pre">-smp</span></code> will boot more core. For QEMU,
core limit is 32.</p></li>
</ol>
</div>
</section>
<section id="smp-networking-with-hypervisor-gicv2">
<h4>SMP + Networking with hypervisor (GICv2)<a class="headerlink" href="#smp-networking-with-hypervisor-gicv2" title="Permalink to this heading"></a></h4>
<p>Configuring NuttX and compile:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>./tools/configure.sh<span class="w"> </span>-l<span class="w"> </span>qemu-armv8a:netnsh_smp_hv
<span class="gp">$ </span>make
</pre></div>
</div>
<p>Running with QEMU + kvm on raspi3b+ (ubuntu server 20.04)</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>qemu-system-aarch64<span class="w"> </span>-nographic<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-machine<span class="w"> </span>virt<span class="w"> </span>-cpu<span class="w"> </span>host<span class="w"> </span>-smp<span class="w"> </span><span class="m">4</span><span class="w"> </span>-accel<span class="w"> </span>kvm<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-chardev<span class="w"> </span>stdio,id<span class="o">=</span>con,mux<span class="o">=</span>on<span class="w"> </span>-serial<span class="w"> </span>chardev:con<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-global<span class="w"> </span>virtio-mmio.force-legacy<span class="o">=</span><span class="nb">false</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-drive<span class="w"> </span><span class="nv">file</span><span class="o">=</span>./mydisk-1gb.img,if<span class="o">=</span>none,format<span class="o">=</span>raw,id<span class="o">=</span>hd<span class="w"> </span>-device<span class="w"> </span>virtio-blk-device,drive<span class="o">=</span>hd<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-netdev<span class="w"> </span>user,id<span class="o">=</span>u1,hostfwd<span class="o">=</span>tcp:127.0.0.1:10023-10.0.2.15:23,hostfwd<span class="o">=</span>tcp:127.0.0.1:15001-10.0.2.15:5001<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-device<span class="w"> </span>virtio-net-device,netdev<span class="o">=</span>u1,bus<span class="o">=</span>virtio-mmio-bus.0<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-mon<span class="w"> </span><span class="nv">chardev</span><span class="o">=</span>con,mode<span class="o">=</span>readline<span class="w"> </span>-kernel<span class="w"> </span>./nuttx
</pre></div>
</div>
<p>Running with QEMU + hvf on M1/MacBook Pro (macOS 12.6.1)</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>qemu-system-aarch64<span class="w"> </span>-nographic<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-machine<span class="w"> </span>virt<span class="w"> </span>-cpu<span class="w"> </span>host<span class="w"> </span>-smp<span class="w"> </span><span class="m">4</span><span class="w"> </span>-accel<span class="w"> </span>hvf<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-chardev<span class="w"> </span>stdio,id<span class="o">=</span>con,mux<span class="o">=</span>on<span class="w"> </span>-serial<span class="w"> </span>chardev:con<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-global<span class="w"> </span>virtio-mmio.force-legacy<span class="o">=</span><span class="nb">false</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-drive<span class="w"> </span><span class="nv">file</span><span class="o">=</span>./mydisk-1gb.img,if<span class="o">=</span>none,format<span class="o">=</span>raw,id<span class="o">=</span>hd<span class="w"> </span>-device<span class="w"> </span>virtio-blk-device,drive<span class="o">=</span>hd<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-netdev<span class="w"> </span>user,id<span class="o">=</span>u1,hostfwd<span class="o">=</span>tcp:127.0.0.1:10023-10.0.2.15:23,hostfwd<span class="o">=</span>tcp:127.0.0.1:15001-10.0.2.15:5001<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-device<span class="w"> </span>virtio-net-device,netdev<span class="o">=</span>u1,bus<span class="o">=</span>virtio-mmio-bus.0<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-mon<span class="w"> </span><span class="nv">chardev</span><span class="o">=</span>con,mode<span class="o">=</span>readline<span class="w"> </span>-kernel<span class="w"> </span>./nuttx
</pre></div>
</div>
</section>
<section id="single-core-w-xedge">
<h4>Single Core /w Xedge<a class="headerlink" href="#single-core-w-xedge" title="Permalink to this heading"></a></h4>
<p>Configuring NuttX and compile:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>./tools/configure.sh<span class="w"> </span>-l<span class="w"> </span>qemu-armv8a:xedge_demo
<span class="gp">$ </span>make
</pre></div>
</div>
<p>Running with QEMU:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>qemu-system-aarch64<span class="w"> </span>-cpu<span class="w"> </span>cortex-a53<span class="w"> </span>-smp<span class="w"> </span><span class="m">4</span><span class="w"> </span>-nographic<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>-machine<span class="w"> </span>virt,virtualization<span class="o">=</span>on,gic-version<span class="o">=</span><span class="m">3</span><span class="w"> </span><span class="se">\</span>
<span class="w">   </span>-chardev<span class="w"> </span>stdio,id<span class="o">=</span>con,mux<span class="o">=</span>on<span class="w"> </span>-serial<span class="w"> </span>chardev:con<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>-netdev<span class="w"> </span>user,id<span class="o">=</span>u1,hostfwd<span class="o">=</span>tcp:127.0.0.1:8080-10.0.2.15:80,hostfwd<span class="o">=</span>tcp:127.0.0.1:8443-10.0.2.15:443,hostfwd<span class="o">=</span>tcp:127.0.0.1:10023-10.0.2.15:23<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>-device<span class="w"> </span>virtio-net-device,netdev<span class="o">=</span>u1<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>-fsdev<span class="w"> </span>local,security_model<span class="o">=</span>none,id<span class="o">=</span>fsdev0,path<span class="o">=</span>/mnt/xxx<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>-device<span class="w"> </span>virtio-9p-device,id<span class="o">=</span>fs0,fsdev<span class="o">=</span>fsdev0,mount_tag<span class="o">=</span>host<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>-mon<span class="w"> </span><span class="nv">chardev</span><span class="o">=</span>con,mode<span class="o">=</span>readline<span class="w"> </span>-kernel<span class="w"> </span>./nuttx
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Replace <strong>/mnt/xxx</strong> with your actual host directory path. This directory will be shared between your host system and the NuttX environment.</p>
</div>
<p>Before running Xedge, you need to create and mount a filesystem that Xedge will use for storing configuration files and web content:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">nsh&gt; mkdir mnt</span>
<span class="go">nsh&gt; mount -t v9fs -o trans=virtio,tag=host mnt</span>
<span class="go">nsh&gt; mkdir /mnt/lfs</span>
</pre></div>
</div>
<p>Running Xedge in NuttX terminal</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">nsh&gt; xedge_demo</span>
<span class="go">   [   18.490000] [CPU0] Xedge: Server listening on IPv4 port 80</span>
<span class="go">   [   18.500000] [CPU0] Xedge: SharkSSL server listening on IPv4 port 443</span>
<span class="go">   [   18.510000] [CPU0] Xedge: Configuration file: /mnt/lfs/xcfg.bin: enoent</span>
<span class="go">   [   38.240000] [CPU1] 10.0.2.2 GET &quot;rtl/&quot;</span>
<span class="go">   [   38.240000] [CPU1] Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/138</span>
<span class="go">   [   38.240000] [CPU1] .0.0.0 Safari/537.36</span>
<span class="go">   [   38.240000] [CPU1] Host: 127.0.0.1:8080</span>
<span class="go">   [   38.240000] [CPU1] Connection: keep-alive</span>
<span class="go">   [   38.240000] [CPU1] sec-ch-ua: &quot;Not)A;Brand&quot;;v=&quot;8&quot;, &quot;Chromium&quot;;v=&quot;138&quot;, &quot;Google Chrome&quot;;v=&quot;138&quot;</span>
<span class="go">   [   38.240000] [CPU1] sec-ch-ua-mobile: ?0</span>
<span class="go">   [   38.240000] [CPU1] sec-ch-ua-platform: &quot;Linux&quot;</span>
<span class="go">   [   38.240000] [CPU1] Upgrade-Insecure-Requests: 1</span>
<span class="go">   [   38.240000] [CPU1] User-Agent: c</span>
<span class="go">   [   38.240000] [CPU1] Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/138</span>
<span class="go">   [   38.240000] [CPU1] .0.0.0 Safari/537.36</span>
<span class="go">   [   38.240000] [CPU1] Sec-Purpose: prefetch;prerender</span>
<span class="go">   [   38.240000] [CPU1] Purpose: prefetch</span>
<span class="go">   [   38.240000] [CPU1] Accept:</span>
<span class="go">   [   38.240000] [CPU1] text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image</span>
<span class="go">   [   38.240000] [CPU1] /apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span>
<span class="go">   [   38.240000] [CPU1] Sec-Fetch-Site: none</span>
<span class="go">   [   38.240000] [CPU1] Sec-Fetch-Mode: navigate</span>
<span class="go">   [   38.240000] [CPU1] Sec-Fetch-User: ?1</span>
<span class="go">   [   38.240000] [CPU1] Sec-Fetch-Dest: document</span>
<span class="go">   [   38.240000] [CPU1] Accept-Encoding: gzip, deflate, br, zstd</span>
<span class="go">   [   38.240000] [CPU1] Accept-Language: pt,en-US;q=0.9,en;q=0.8</span>
<span class="go">   [   38.240000] [CPU1]</span>
<span class="go">   [   38.240000] [CPU0] 10.0.2.2 Response:</span>
<span class="go">   ,</span>
<span class="go">   [   38.240000] [CPU0] no-store, no-cache, must-revalidate, max-age=0</span>
<span class="go">   Transfer-Encoding: chunked</span>
<span class="go">   Keep-</span>
<span class="go">   [   38.240000] [CPU0] Alive: Keep-Alive</span>
</pre></div>
</div>
<p>Launch your web browser and access 127.0.0.1:8080</p>
<p>You should see the Xedge IDE, which is enabled in developer mode.</p>
<p>For more details about the xedge example, please refer to the <a class="reference external" href="https://nuttx.apache.org/docs/latest/applications/examples/xedge_demo/index.html">xedge_demo documentation</a>.</p>
</section>
</section>
<section id="single-core-w-kernel-mode-gicv3">
<h3>Single Core /w kernel mode (GICv3)<a class="headerlink" href="#single-core-w-kernel-mode-gicv3" title="Permalink to this heading"></a></h3>
<p>Configuring NuttX and compile:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>./tools/configure.sh<span class="w"> </span>-l<span class="w"> </span>qemu-armv8a:knsh
<span class="gp">$ </span>make
<span class="gp">$ </span>make<span class="w"> </span><span class="nb">export</span><span class="w"> </span><span class="nv">V</span><span class="o">=</span><span class="m">1</span>
<span class="gp">$ </span><span class="nb">pushd</span><span class="w"> </span>../apps
<span class="gp">$ </span>./tools/mkimport.sh<span class="w"> </span>-z<span class="w"> </span>-x<span class="w"> </span>../nuttx/nuttx-export-*.tar.gz
<span class="gp">$ </span>make<span class="w"> </span>import<span class="w"> </span><span class="nv">V</span><span class="o">=</span><span class="m">1</span>
<span class="gp">$ </span><span class="nb">popd</span>
</pre></div>
</div>
<p>Running with QEMU:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>qemu-system-aarch64<span class="w"> </span>-semihosting<span class="w"> </span>-cpu<span class="w"> </span>cortex-a53<span class="w"> </span>-nographic<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-machine<span class="w"> </span>virt,virtualization<span class="o">=</span>on,gic-version<span class="o">=</span><span class="m">3</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-net<span class="w"> </span>none<span class="w"> </span>-chardev<span class="w"> </span>stdio,id<span class="o">=</span>con,mux<span class="o">=</span>on<span class="w"> </span>-serial<span class="w"> </span>chardev:con<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-mon<span class="w"> </span><span class="nv">chardev</span><span class="o">=</span>con,mode<span class="o">=</span>readline<span class="w"> </span>-kernel<span class="w"> </span>./nuttx
</pre></div>
</div>
</section>
<section id="inter-vm-share-memory-device-ivshmem">
<h3>Inter-VM share memory Device (ivshmem)<a class="headerlink" href="#inter-vm-share-memory-device-ivshmem" title="Permalink to this heading"></a></h3>
<p>Inter-VM shared memory support support can be found in
<code class="docutils literal notranslate"><span class="pre">drivers/pci/pci_ivshmem.c</span></code>.</p>
<p>This implementation is for <code class="docutils literal notranslate"><span class="pre">ivshmem-v1</span></code> which is compatible with QEMU and ACRN
hypervisor but won’t work with Jailhouse hypervisor which uses <code class="docutils literal notranslate"><span class="pre">ivshmem-v2</span></code>.</p>
<p>Please refer to the official <a class="reference external" href="https://www.qemu.org/docs/master/system/devices/ivshmem.html">Qemu ivshmem documentation</a> for more information.</p>
<p>This is an example implementation for OpenAMP based on the Inter-VM share
memory(ivshmem):</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>rpproxy_ivshmem:  Remote slave(client) proxy process.
rpserver_ivshmem: Remote master(host) server process.
</pre></div>
</div>
<p>Steps for Using NuttX as IVSHMEM host and guest</p>
<ol class="arabic">
<li><p>Build images</p>
<ol class="loweralpha">
<li><p>Build <code class="docutils literal notranslate"><span class="pre">rpserver_ivshmem</span></code></p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>cmake<span class="w"> </span>-B<span class="w"> </span>server<span class="w"> </span>-DBOARD_CONFIG<span class="o">=</span>qemu-armv8a:rpserver_ivshmem<span class="w"> </span>-GNinja
<span class="gp">$ </span>cmake<span class="w"> </span>--build<span class="w"> </span>server
</pre></div>
</div>
</li>
<li><p>Build <code class="docutils literal notranslate"><span class="pre">rpproxy_ivshmem</span></code></p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>cmake<span class="w"> </span>-B<span class="w"> </span>proxy<span class="w"> </span>-DBOARD_CONFIG<span class="o">=</span>qemu-armv8a:rpproxy_ivshmem<span class="w"> </span>-GNinja
<span class="gp">$ </span>cmake<span class="w"> </span>--build<span class="w"> </span>proxy
</pre></div>
</div>
</li>
</ol>
</li>
<li><p>Bringup firmware via Qemu:</p>
<p>The Inter-VM Shared Memory device basic syntax is:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>-device ivshmem-plain,id=shmem0,memdev=shmmem-shmem0,addr=0xb \
-object memory-backend-file,id=shmmem-shmem0,mem-path=/dev/shm/ivshmem0,size=4194304,share=yes
</pre></div>
</div>
<ol class="loweralpha">
<li><p>Start <code class="docutils literal notranslate"><span class="pre">rpserver_ivshmem</span></code></p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>qemu-system-aarch64<span class="w"> </span>-cpu<span class="w"> </span>cortex-a53<span class="w"> </span>-nographic<span class="w"> </span>-machine<span class="w"> </span>virt,virtualization<span class="o">=</span>on,gic-version<span class="o">=</span><span class="m">3</span><span class="w"> </span>-kernel<span class="w"> </span>server/nuttx<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-device<span class="w"> </span>ivshmem-plain,id<span class="o">=</span>shmem0,memdev<span class="o">=</span>shmmem-shmem0,addr<span class="o">=</span>0xb<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-object<span class="w"> </span>memory-backend-file,id<span class="o">=</span>shmmem-shmem0,mem-path<span class="o">=</span>/dev/shm/ivshmem0,size<span class="o">=</span><span class="m">4194304</span>,share<span class="o">=</span>yes
</pre></div>
</div>
</li>
<li><p>Start <code class="docutils literal notranslate"><span class="pre">rpproxy_ivshmem</span></code></p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>qemu-system-aarch64<span class="w"> </span>-cpu<span class="w"> </span>cortex-a53<span class="w"> </span>-nographic<span class="w"> </span>-machine<span class="w"> </span>virt,virtualization<span class="o">=</span>on,gic-version<span class="o">=</span><span class="m">3</span><span class="w"> </span>-kernel<span class="w"> </span>proxy/nuttx<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-device<span class="w"> </span>ivshmem-plain,id<span class="o">=</span>shmem0,memdev<span class="o">=</span>shmmem-shmem0,addr<span class="o">=</span>0xb<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-object<span class="w"> </span>memory-backend-file,discard-data<span class="o">=</span>on,id<span class="o">=</span>shmmem-shmem0,mem-path<span class="o">=</span>/dev/shm/ivshmem0,size<span class="o">=</span><span class="m">4194304</span>,share<span class="o">=</span>yes
</pre></div>
</div>
</li>
<li><p>Check the RPMSG Syslog in rpserver shell:</p>
<p>In the current configuration, the proxy syslog will be sent to the server by default.
You can check whether there is proxy startup log in the server shell.</p>
<p>RpServer bring up</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>qemu-system-aarch64<span class="w"> </span>-cpu<span class="w"> </span>cortex-a53<span class="w"> </span>-nographic<span class="w"> </span>-machine<span class="w"> </span>virt,virtualization<span class="o">=</span>on,gic-version<span class="o">=</span><span class="m">3</span><span class="w"> </span>-kernel<span class="w"> </span>server/nuttx<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-device<span class="w"> </span>ivshmem-plain,id<span class="o">=</span>shmem0,memdev<span class="o">=</span>shmmem-shmem0,addr<span class="o">=</span>0xb<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-object<span class="w"> </span>memory-backend-file,id<span class="o">=</span>shmmem-shmem0,mem-path<span class="o">=</span>/dev/shm/ivshmem0,size<span class="o">=</span><span class="m">4194304</span>,share<span class="o">=</span>yes
<span class="go">[    0.000000] [ 0] [  INFO] [server] pci_register_rptun_ivshmem_driver: Register ivshmem driver, id=0, cpuname=proxy, master=1</span>
<span class="go">...</span>
<span class="go">[    0.033200] [ 3] [  INFO] [server] ivshmem_probe: shmem addr=0x10400000 size=4194304 reg=0x10008000</span>
<span class="go">[    0.033700] [ 3] [  INFO] [server] rptun_ivshmem_probe: shmem addr=0x10400000 size=4194304</span>
</pre></div>
</div>
<p>After <code class="docutils literal notranslate"><span class="pre">rpproxy</span></code> bring up, check the log from <code class="docutils literal notranslate"><span class="pre">rpserver</span></code>:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>NuttShell (NSH) NuttX-10.4.0
server&gt;
[    0.000000] [ 0] [  INFO] [proxy] pci_register_rptun_ivshmem_driver: Register ivshmem driver, id=0, cpuname=server, master=0
...
[    0.031400] [ 3] [  INFO] [proxy] ivshmem_probe: shmem addr=0x10400000 size=4194304 reg=0x10008000
[    0.031800] [ 3] [  INFO] [proxy] rptun_ivshmem_probe: shmem addr=0x10400000 size=4194304
[    0.033100] [ 3] [  INFO] [proxy] rptun_ivshmem_probe: Start the wdog
</pre></div>
</div>
</li>
<li><p>IPC test via RPMSG socket:</p>
<p>Start <code class="docutils literal notranslate"><span class="pre">rpmsg</span></code> socket server:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>server&gt; rpsock_server stream block test
server: create socket SOCK_STREAM nonblock 0
server: bind cpu , name test ...
server: listen ...
server: try accept ...
server: Connection accepted -- 4
server: try accept ...
</pre></div>
</div>
<p>Switch to proxy shell and start <code class="docutils literal notranslate"><span class="pre">rpmsg</span></code> socket client, test start:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>proxy&gt; rpsock_client stream block test server
client: create socket SOCK_STREAM nonblock 0
client: Connecting to server,test...
client: Connected
client send data, cnt 0, total len 64, BUFHEAD process0007, msg0000, name:test
client recv data process0007, msg0000, name:test
...
client recv done, total 4096000, endflags, send total 4096000
client: Terminating
</pre></div>
</div>
<p>Check the log on <code class="docutils literal notranslate"><span class="pre">rpserver</span></code> shell:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>server recv data normal exit
server Complete ret 0, errno 0
</pre></div>
</div>
</li>
</ol>
</li>
</ol>
</section>
<section id="fastboot">
<h3>fastboot<a class="headerlink" href="#fastboot" title="Permalink to this heading"></a></h3>
<p>Fastboot TCP network device configuration with reference to qemu-armv8a:netnsh.
More details about usage of fastboot, please refer to <a class="reference external" href="https://nuttx.apache.org/docs/latest/applications/system/fastboot/index.html">fastbootd — NuttX latest documentation</a>.</p>
<p>You can run the configuration procedure:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ ./tools/configure.sh -l qemu-armv8a:fastboot
$ make
$ dd if=/dev/zero of=./mydisk-1gb.img bs=1M count=1024
</pre></div>
</div>
<p>To test it, there are two example ways:</p>
<ol class="arabic">
<li><p>NAT:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># a. Add &quot;hostfwd=tcp:127.0.0.1:15002-10.0.2.15:5554&quot; for option &quot;-netdev&quot;
qemu-system-aarch64 -cpu cortex-a53 -nographic \
                -machine virt,virtualization=on,gic-version=3 \
                -chardev stdio,id=con,mux=on -serial chardev:con \
                -global virtio-mmio.force-legacy=false \
                -device virtio-serial-device,bus=virtio-mmio-bus.0 \
                -chardev socket,telnet=on,host=127.0.0.1,port=3450,server=on,wait=off,id=foo \
                -device virtconsole,chardev=foo \
                -device virtio-rng-device,bus=virtio-mmio-bus.1 \
                -netdev user,id=u1,hostfwd=tcp:127.0.0.1:10023-10.0.2.15:23,hostfwd=tcp:127.0.0.1:15002-10.0.2.15:5554 \
                -device virtio-net-device,netdev=u1,bus=virtio-mmio-bus.2 \
                -drive file=./mydisk-1gb.img,if=none,format=raw,id=hd \
                -device virtio-blk-device,bus=virtio-mmio-bus.3,drive=hd \
                -mon chardev=con,mode=readline -kernel ./nuttx

# b. Run fastboot daemon on qemu device
fastbootd &amp;

# c. Exec fastboot command on host side with device IP and PORT
fastboot -s tcp:127.0.0.1:15002 getvar version
</pre></div>
</div>
</li>
<li><p>Bridge:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># a. Set option &quot;-netdev&quot; to &quot;-netdev bridge,br=br0,id=u1&quot;
qemu-system-aarch64 -cpu cortex-a53 -nographic \
                -machine virt,virtualization=on,gic-version=3 \
                -chardev stdio,id=con,mux=on -serial chardev:con \
                -global virtio-mmio.force-legacy=false \
                -device virtio-serial-device,bus=virtio-mmio-bus.0 \
                -chardev socket,telnet=on,host=127.0.0.1,port=3450,server=on,wait=off,id=foo \
                -device virtconsole,chardev=foo \
                -device virtio-rng-device,bus=virtio-mmio-bus.1 \
                -netdev bridge,br=br0,id=u1 \
                -device virtio-net-device,netdev=u1,bus=virtio-mmio-bus.2 \
                -drive file=./mydisk-1gb.img,if=none,format=raw,id=hd \
                -device virtio-blk-device,bus=virtio-mmio-bus.3,drive=hd \
                -mon chardev=con,mode=readline -kernel ./nuttx

# b. Init network bridge and ACL for host
sudo ip link add name br0 type bridge
ip addr add 192.168.100.1/24 brd + dev br0
ip link set br0 up
sysctl -w net.ipv4.ip_forward=1
iptables -t filter -A FORWARD -i br0 -j ACCEPT
iptables -t filter -A FORWARD -o br0 -j ACCEPT
echo &quot;allow all&quot; | sudo tee /etc/qemu/${USER}.conf
echo &quot;include /etc/qemu/${USER}.conf&quot; | sudo tee --append /etc/qemu/bridge.conf
sudo chown root:${USER} /etc/qemu/${USER}.conf
sudo chmod 640 /etc/qemu/${USER}.conf

# c. Configure IP address for qemu device, and run fastboot daemon
ifconfig eth0 192.168.100.2
fastbootd &amp;

# d. Exec fastboot command on host side with device IP
fastboot -s tcp:192.168.100.2 getvar version
</pre></div>
</div>
</li>
</ol>
</section>
</section>
<section id="status">
<h2>Status<a class="headerlink" href="#status" title="Permalink to this heading"></a></h2>
<p><strong>2022-11-18:</strong></p>
<ol class="arabic simple">
<li><p>Added support for GICv2.</p></li>
<li><p>Added board configuration for nsh_gicv2.</p></li>
</ol>
<p><strong>2022-10-13:</strong></p>
<ol class="arabic simple">
<li><p>Renamed the board configuration name from qemu-a53 to qemu-v8a.</p></li>
<li><p>Added the configurations for Cortex-A57 and Cortex-A72.</p></li>
</ol>
<p><strong>2022-07-01:</strong></p>
<blockquote>
<div><p>It’s very strange to see that signal testing of ostest is PASSED at Physical
Ubuntu PC rather than an Ubuntu at VMWare. For Physical Ubuntu PC, the ostest
was run for 10 times at least but the crash was never seen again, but it’s
almost crashed every time running the ostest at Virtual Ubuntu in VMWare
Checking for the the fail point. It’s seem at signal routine to access another
CPU’s task context reg will get a NULL pointer, but watch the task context with
GDB, shows everything as OK. So maybe this is a SMP cache synchronize issue?
But synchronize operations have been done at thread switch. It is hard to
explain why the crash is not happening with a Physical Ubuntu PC. So maybe this
is a qemu issue at VMWare. <code class="docutils literal notranslate"><span class="pre">arm64</span></code> should be tested on a real hardware
platform like IMX8 for the above issue.</p>
</div></blockquote>
<p><strong>2022-06-12:</strong></p>
<p>SMP is support at QEMU. Add psci interface, armv8 cache operation(data cache)
and smccc support. The system can run into nsh shell, SMP test is PASSED, but
ostest crash at signal testing</p>
<p><strong>2022-05-22:</strong></p>
<blockquote>
<div><p>Arm64 support version for NuttX is Ready, These Features supported:</p>
</div></blockquote>
<ol class="arabic simple">
<li><p>Cortex-a53 single core support: With the supporting of GICv3,
Arch timer, PL101 UART, The system can run into nsh shell.
Running ostest seem PASSED.</p></li>
<li><p>qemu-a53 board configuration support: qemu-a53 board can configuring
and compiling, And running with qemu-system-aarch64
at Ubuntu 18.04.</p></li>
<li><p>FPU support for armv8-a: FPU context switching in NEON/floating-point
TRAP was supported.  FPU registers saving at vfork and independent
FPU context for signal routine was considered but more testing
needs to be do.</p></li>
</ol>
</section>
<section id="platform-features">
<h2>Platform Features<a class="headerlink" href="#platform-features" title="Permalink to this heading"></a></h2>
<p>The following hardware features are supported:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Interface</p></th>
<th class="head"><p>Controller</p></th>
<th class="head"><p>Driver/Component</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>GIC</p></td>
<td><p>on-chip</p></td>
<td><p>interrupt controller</p></td>
</tr>
<tr class="row-odd"><td><p>PL011 UART</p></td>
<td><p>on-chip</p></td>
<td><p>serial port</p></td>
</tr>
<tr class="row-even"><td><p>ARM TIMER</p></td>
<td><p>on-chip</p></td>
<td><p>system clock</p></td>
</tr>
</tbody>
</table>
<p>The kernel currently does not support other hardware features on this
QEMU platform.</p>
</section>
<section id="debugging-with-qemu">
<h2>Debugging with QEMU<a class="headerlink" href="#debugging-with-qemu" title="Permalink to this heading"></a></h2>
<p>The nuttx ELF image can be debugged with QEMU.</p>
<ol class="arabic simple">
<li><p>To debug the nuttx (ELF) with symbols, make sure the following change have
applied to <code class="docutils literal notranslate"><span class="pre">defconfig</span></code>:</p></li>
</ol>
<div class="highlight-diff notranslate"><div class="highlight"><pre><span></span><span class="gi">+CONFIG_DEBUG_SYMBOLS=y</span>
</pre></div>
</div>
<ol class="arabic" start="2">
<li><p>Run QEMU(at shell terminal 1)</p>
<p><strong>Single Core:</strong></p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>qemu-system-aarch64<span class="w"> </span>-cpu<span class="w"> </span>cortex-a53<span class="w"> </span>-nographic<span class="w"> </span>-machine<span class="w"> </span>virt,virtualization<span class="o">=</span>on,gic-version<span class="o">=</span><span class="m">3</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-net<span class="w"> </span>none<span class="w"> </span>-chardev<span class="w"> </span>stdio,id<span class="o">=</span>con,mux<span class="o">=</span>on<span class="w"> </span>-serial<span class="w"> </span>chardev:con<span class="w"> </span>-mon<span class="w"> </span><span class="nv">chardev</span><span class="o">=</span>con,mode<span class="o">=</span>readline<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-kernel<span class="w"> </span>./nuttx<span class="w"> </span>-S<span class="w"> </span>-s
</pre></div>
</div>
<p><strong>SMP</strong></p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>qemu-system-aarch64<span class="w"> </span>-cpu<span class="w"> </span>cortex-a53<span class="w"> </span>-smp<span class="w"> </span><span class="m">4</span><span class="w"> </span>-nographic<span class="w"> </span>-machine<span class="w"> </span>virt,virtualization<span class="o">=</span>on,gic-version<span class="o">=</span><span class="m">3</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-net<span class="w"> </span>none<span class="w"> </span>-chardev<span class="w"> </span>stdio,id<span class="o">=</span>con,mux<span class="o">=</span>on<span class="w"> </span>-serial<span class="w"> </span>chardev:con<span class="w"> </span>-mon<span class="w"> </span><span class="nv">chardev</span><span class="o">=</span>con,mode<span class="o">=</span>readline<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-kernel<span class="w"> </span>./nuttx<span class="w"> </span>-S<span class="w"> </span>-s
</pre></div>
</div>
</li>
<li><p>Run <code class="docutils literal notranslate"><span class="pre">gdb</span></code> with TUI, connect to QEMU, load nuttx and continue (at shell
terminal 2):</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"> $ </span>aarch64-none-elf-gdb<span class="w"> </span>-tui<span class="w"> </span>--eval-command<span class="o">=</span><span class="s1">&#39;target remote localhost:1234&#39;</span><span class="w"> </span>nuttx
<span class="go"> (gdb) set debug aarch64</span>
<span class="go"> (gdb) c</span>
<span class="go"> Continuing.</span>
<span class="go"> ^C</span>
<span class="go"> Program received signal SIGINT, Interrupt.</span>
<span class="go"> arch_cpu_idle () at common/arm64_cpu_idle.S:37</span>
<span class="go"> (gdb)</span>
<span class="go"> (gdb) where</span>
<span class="gp"> #</span><span class="m">0</span><span class="w">  </span>arch_cpu_idle<span class="w"> </span><span class="o">()</span><span class="w"> </span>at<span class="w"> </span>common/arm64_cpu_idle.S:37
<span class="gp"> #</span><span class="m">1</span><span class="w">  </span>0x00000000402823ec<span class="w"> </span><span class="k">in</span><span class="w"> </span>nx_start<span class="w"> </span><span class="o">()</span><span class="w"> </span>at<span class="w"> </span>init/nx_start.c:742
<span class="gp"> #</span><span class="m">2</span><span class="w">  </span>0x0000000040280148<span class="w"> </span><span class="k">in</span><span class="w"> </span>arm64_boot_primary_c_routine<span class="w"> </span><span class="o">()</span><span class="w"> </span>at<span class="w"> </span>common/arm64_boot.c:184
<span class="gp"> #</span><span class="m">3</span><span class="w">  </span>0x00000000402a5bf8<span class="w"> </span><span class="k">in</span><span class="w"> </span>switch_el<span class="w"> </span><span class="o">()</span><span class="w"> </span>at<span class="w"> </span>common/arm64_head.S:201
<span class="go"> (gdb)</span>
<span class="go"> SMP Case</span>
<span class="go"> Thread 1 received signal SIGINT, Interrupt.</span>
<span class="go">  arch_cpu_idle () at common/arm64_cpu_idle.S:37</span>
<span class="go"> (gdb) info threads</span>
<span class="go">  Id   Target Id                  Frame</span>
<span class="go">* 1    Thread 1 (CPU#0 [halted ]) arch_cpu_idle () at common/arm64_cpu_idle.S:37</span>
<span class="go">  2    Thread 2 (CPU#1 [halted ]) arch_cpu_idle () at common/arm64_cpu_idle.S:37</span>
<span class="go">  3    Thread 3 (CPU#2 [halted ]) arch_cpu_idle () at common/arm64_cpu_idle.S:37</span>
<span class="go">  4    Thread 4 (CPU#3 [halted ]) arch_cpu_idle () at common/arm64_cpu_idle.S:37</span>
<span class="go"> (gdb)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>It will make your debugging more easier in source level if you setting
<code class="docutils literal notranslate"><span class="pre">CONFIG_DEBUG_FULLOPT=n</span></code>. but there is a risk of stack overflow when the
option is disabled. Just enlarging your stack size will avoid the issue
(eg. enlarging <code class="docutils literal notranslate"><span class="pre">CONFIG_DEFAULT_TASK_STACKSIZE</span></code>)</p>
</div>
<div class="admonition-todo admonition" id="id1">
<p class="admonition-title">Todo</p>
<p>ARMv8-A Supporting for <code class="docutils literal notranslate"><span class="pre">tools/nuttx-gdbinit</span></code></p>
</div>
</li>
</ol>
</section>
<section id="fpu-support-and-performance">
<h2>FPU Support and Performance<a class="headerlink" href="#fpu-support-and-performance" title="Permalink to this heading"></a></h2>
<p>The FPU trap was used to handle FPU context switch. For threads accessing the
FPU (FPU instructions or registers), a trap will happen at this thread, the
FPU context will be saved/restore for the thread at the trap handler. It will
improve performance for thread switch since it’s not to save/restore the FPU
context (almost 512 bytes) at the thread switch anymore. But some issue need
to be considered:</p>
<ol class="arabic">
<li><p>Floating point argument passing issue:</p>
<p>In many cases, the FPU trap is triggered by <code class="docutils literal notranslate"><span class="pre">va_start()</span></code> that copies the
content of FP registers used for floating point argument passing into the
va_list object in case there were actual float arguments from the caller.
Adding <code class="docutils literal notranslate"><span class="pre">-mgeneral-regs-only</span></code> option will make compiler not use the FPU
register, we can use the following patch to <code class="docutils literal notranslate"><span class="pre">syslog</span></code>:</p>
<div class="highlight-diff notranslate"><div class="highlight"><pre><span></span><span class="gh">diff --git a/libs/libc/syslog/Make.defs b/libs/libc/syslog/Make.defs</span>
<span class="gh">index c58fb45512..acac6febaa</span>
<span class="gd">--- a/libs/libc/syslog/Make.defs</span>
<span class="gi">+++ b/libs/libc/syslog/Make.defs</span>
<span class="gu">@@ -26,3 +26,4 @@ CSRCS += lib_syslog.c lib_setlogmask.c</span>

<span class="w"> </span>DEPPATH += --dep-path syslog
<span class="w"> </span>VPATH += :syslog
<span class="gi">+syslog/lib_syslog.c_CFLAGS += -mgeneral-regs-only</span>
</pre></div>
</div>
<p>This patch cannot be merged into NuttX mainline because it is a very special
case since ostest is using syslog for lots of information printing. but this
is a clue for FPU performance analysis. <code class="docutils literal notranslate"><span class="pre">va_list</span></code> object is using for many
C code to handle argument passing, but if it’s not passing floating point
argument indeed. Add the option to your code maybe increase FPU performance</p>
</li>
<li><p>memset/memcpy issue:</p>
<p>For improved performance, the memset/memcpy implement for libc will use the
neon/fpu instruction/register. The FPU trap is also triggered in this case.</p>
<p>We can trace this issue with Procfs:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">nsh&gt; cat /proc/arm64fpu</span>
<span class="go">CPU0: save: 7 restore: 8 switch: 62 exedepth: 0</span>
<span class="go">nsh&gt;</span>
</pre></div>
</div>
<p>after ostest:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">nsh&gt; cat /proc/arm64fpu</span>
<span class="go">CPU0: save: 1329 restore: 2262 switch: 4613 exedepth: 0</span>
<span class="go">nsh&gt;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">save</span></code>: the counts of save for task FPU context</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">restore</span></code>: the counts of restore for task FPU context</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">switch</span></code>:  the counts of task switch</p></li>
</ul>
</div>
</li>
</ol>
<ol class="arabic" start="2">
<li><p>FPU trap at IRQ handler:</p>
<p>It’s probably need to handle FPU trap at IRQ routine. Exception_depth is
handling for this case, it will inc/dec at enter/leave exception. If the
exception_depth &gt; 1, that means an exception occurring when another exception
is executing, the present implement is to switch FPU context to idle thread,
it will handle most case for calling printf-like routine at IRQ routine. But
in fact, this case will make uncertainty interrupt processing time sine it’s
uncertainty for trap exception handling. It would be best to add
<code class="docutils literal notranslate"><span class="pre">-mgeneral-regs-only</span></code> option to compile the IRQ code avoiding accessing FP
register. if it’s necessarily for the exception routine to use FPU, calling
function to save/restore FPU context directly maybe become a solution. Linux
kernel introduce kernel_neon_begin/kernel_neon_end function for this case.
Similar function will be add to NuttX if this issue need to be handle.</p>
</li>
<li><p>More reading:</p>
<p>For Linux kernel, please reference
<a class="reference external" href="https://www.kernel.org/doc/html/latest/arm/kernel_mode_neon.html">https://www.kernel.org/doc/html/latest/arm/kernel_mode_neon.html</a></p>
</li>
</ol>
</section>
<section id="smp-support">
<h2>SMP Support<a class="headerlink" href="#smp-support" title="Permalink to this heading"></a></h2>
<ol class="arabic">
<li><p>Booting</p>
<p>Primary core call sequence:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>arm64_start
  -&gt;arm64_boot_primary_c_routine
    -&gt;arm64_chip_boot
      -&gt;set init TBBR and Enable MMU
    -&gt;nx_start
      -&gt;OS component initialize
        -&gt;Initialize GIC: GICD and Primary core GICR
      -&gt;nx_smp_start
        for every CPU core
        -&gt;up_cpu_start
          -&gt;arm64_start_cpu(call PCSI to boot CPU)
          -&gt;waiting for every core to boot
      -&gt;nx_bringup
</pre></div>
</div>
<p>Secondary Core call sequence:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>arm64_start
  -&gt;arm64_boot_secondary_c_routine
    -&gt;Enable MMU
    -&gt;Initialize GIC: Secondary core GICR
    -&gt;Notify Primary core booting is Ready
    -&gt;nx_idle_trampoline
</pre></div>
</div>
</li>
<li><p>Interrupt:</p>
<dl class="simple">
<dt><strong>SGI</strong></dt><dd><p><code class="docutils literal notranslate"><span class="pre">SGI_CPU_PAUSE</span></code>: for core pause request, for every core</p>
</dd>
<dt><strong>PPI</strong></dt><dd><p><code class="docutils literal notranslate"><span class="pre">ARM_ARCH_TIMER_IRQ</span></code>: timer interrupt, handle by primary Core</p>
</dd>
<dt><strong>SPI</strong></dt><dd><p><code class="docutils literal notranslate"><span class="pre">CONFIG_QEMU_UART_IRQ</span></code>: serial driver interrupt, handle by primary Core</p>
</dd>
</dl>
</li>
<li><p>Timer:</p>
<p>The origin design for ARMv8-A timer is assigned private timer to every PE(CPU
core), the <code class="docutils literal notranslate"><span class="pre">ARM_ARCH_TIMER_IRQ</span></code> is a PPI so it’s should be enabled at every
core.</p>
<p>But for NuttX, it’s design only for primary core to handle timer interrupt
and call <code class="docutils literal notranslate"><span class="pre">nxsched_process_timer</span></code> at timer tick mode. So we need only enable
timer for primary core</p>
<p>IMX6 use GPT which is a SPI rather than generic timer to handle timer
interrupt</p>
</li>
</ol>
</section>
<section id="gdbstub-demo">
<h2>Gdbstub demo<a class="headerlink" href="#gdbstub-demo" title="Permalink to this heading"></a></h2>
<p>The Qemu version must be above 9.2 to support two serial ports.</p>
<p>One window:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ ./tools/configure.sh qemu-armv8a:gdbstub; make -j25
$ qemu-system-aarch64 -cpu cortex-a53 -nographic -machine virt,virtualization=on,gic-version=3 -net none -kernel ./nuttx -serial mon:stdio -serial pty
char device redirected to /dev/pts/27 (label serial1)
- Ready to Boot Primary CPU
- Boot from EL2
- Boot from EL1
- Boot to C runtime for OS Initialize
</pre></div>
</div>
<p>Another window:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ gdb-multiarch nuttx -ex &quot;target remote /dev/pts/27&quot;
GNU gdb (Ubuntu 15.0.50.20240403-0ubuntu1) 15.0.50.20240403-git
Copyright (C) 2024 Free Software Foundation, Inc.
License GPLv3+: GNU GPL version 3 or later &lt;http://gnu.org/licenses/gpl.html&gt;
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.
Type &quot;show copying&quot; and &quot;show warranty&quot; for details.
This GDB was configured as &quot;x86_64-linux-gnu&quot;.
Type &quot;show configuration&quot; for configuration details.
For bug reporting instructions, please see:
&lt;https://www.gnu.org/software/gdb/bugs/&gt;.
Find the GDB manual and other documentation resources online at:
&lt;http://www.gnu.org/software/gdb/documentation/&gt;.

For help, type &quot;help&quot;.
Type &quot;apropos word&quot; to search for commands related to &quot;word&quot;...
Reading symbols from nuttx...
Remote debugging using /dev/pts/26
gdb_get_registers (state=0x403e1590) at gdbstub/lib_gdbstub.c:1020
1020              reg = state-&gt;running_regs;
(gdb) c
</pre></div>
</div>
</section>
<section id="references">
<h2>References<a class="headerlink" href="#references" title="Permalink to this heading"></a></h2>
<ol class="arabic simple">
<li><p>(ID050815) ARM® Cortex®-A Series - Programmer’s Guide for ARMv8-A</p></li>
<li><p>(ID020222) Arm® Architecture Reference Manual - for A profile architecture</p></li>
<li><p>(ARM062-948681440-3280) Armv8-A Instruction Set Architecture</p></li>
<li><p>AArch64 Exception and Interrupt Handling</p></li>
<li><p>AArch64 Programmer’s Guides Generic Timer</p></li>
<li><p>Arm Generic Interrupt Controller v3 and v4 Overview</p></li>
<li><p>Arm® Generic Interrupt Controller Architecture Specification GIC architecture version 3 and version 4</p></li>
<li><p>(DEN0022D.b) Arm Power State Coordination Interface Platform Design Document</p></li>
</ol>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../../index.html" class="btn btn-neutral float-left" title="qemu" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../../../rk3399/index.html" class="btn btn-neutral float-right" title="Rockchip rk3399" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, The Apache Software Foundation.</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>