<!--
 Documentation/_templates/layout.html

 Licensed to the Apache Software Foundation (ASF) under one or more
 contributor license agreements.  See the NOTICE file distributed with
 this work for additional information regarding copyright ownership.  The
 ASF licenses this file to you under the Apache License, Version 2.0 (the
 "License"); you may not use this file except in compliance with the
 License.  You may obtain a copy of the License at

   http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
 WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 License for the specific language governing permissions and limitations
 under the License.
-->

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>nand - NAND Flash Device Simulator &mdash; NuttX latest documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/copybutton.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/tabs.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/sphinx_highlight.js"></script>
        <script src="../../../_static/clipboard.min.js"></script>
        <script src="../../../_static/copybutton.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="nist-sts NIST Statistical Test Suite" href="../nist-sts/index.html" />
    <link rel="prev" title="mtd_nvs MTD non-volatile storage Test" href="../mtd_config_fs/index.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
  
    <a href="../../../index.html" class="icon icon-home"> NuttX
  

  
  </a>

  <!-- this version selector is quite ugly, should be probably replaced by something
       more modern -->

  <div class="version-selector">
    <select onchange="javascript:location.href = this.value;">
    
    <option value="../../../../latest" selected="selected">latest</option>
    
    <option value="../../../../10.0.0" >10.0.0</option>
    
    <option value="../../../../10.0.1" >10.0.1</option>
    
    <option value="../../../../10.1.0" >10.1.0</option>
    
    <option value="../../../../10.2.0" >10.2.0</option>
    
    <option value="../../../../10.3.0" >10.3.0</option>
    
    <option value="../../../../11.0.0" >11.0.0</option>
    
    <option value="../../../../12.0.0" >12.0.0</option>
    
    <option value="../../../../12.1.0" >12.1.0</option>
    
    <option value="../../../../12.2.0" >12.2.0</option>
    
    <option value="../../../../12.2.1" >12.2.1</option>
    
    <option value="../../../../12.3.0" >12.3.0</option>
    
    <option value="../../../../12.4.0" >12.4.0</option>
    
    <option value="../../../../12.5.0" >12.5.0</option>
    
    <option value="../../../../12.5.1" >12.5.1</option>
    
    </select>
  </div>

  
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Table of Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../index.html">Home</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../introduction/index.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../quickstart/index.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing/index.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../introduction/inviolables.html">The Inviolable Principles of NuttX</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../platforms/index.html">Supported Platforms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../components/index.html">OS Components</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../index.html">Applications</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../audioutils/index.html">Audio Utility libraries</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../boot/index.html">Bootloader Utilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../benchmarks/index.html">Benchmark Applications</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../canutils/index.html">CAN Utilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../crypto/index.html">Cryptography Library Support</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../fsutils/index.html">File System Utilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../games/index.html">Games</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../graphics/index.html">Graphics Support</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../industry/index.html">Industrial Applications</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../inertial/index.html">Inertial Libraries Support</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../interpreters/index.html">Interpreters</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../logging/index.html">Logging Utilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../lte/index.html">LTE Libraries and NSH Add-Ons</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../math/index.html">Math Library Support</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../mlearing/index.html">Machine Learning Support</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../netutils/index.html">Network Utilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../nsh/index.html">NuttShell (NSH)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../sdr/index.html">Software Define Radio Libraries</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../system/index.html">System Libraries and NSH Add-Ons</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.html">Testing</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../arch_libc/index.html"><code class="docutils literal notranslate"><span class="pre">arch_libc</span></code> Arch-specific libc Test</a></li>
<li class="toctree-l3"><a class="reference internal" href="../atomic/index.html"><code class="docutils literal notranslate"><span class="pre">atomic</span></code> “Test atomic” testing</a></li>
<li class="toctree-l3"><a class="reference internal" href="../batterydump/index.html"><code class="docutils literal notranslate"><span class="pre">batterydump</span></code> Battery dump for test</a></li>
<li class="toctree-l3"><a class="reference internal" href="../cmocka/index.html"><code class="docutils literal notranslate"><span class="pre">cmocka</span></code> libcmocka</a></li>
<li class="toctree-l3"><a class="reference internal" href="../cpuload/index.html"><code class="docutils literal notranslate"><span class="pre">cpuload</span></code> cpuload test</a></li>
<li class="toctree-l3"><a class="reference internal" href="../crypto/index.html"><code class="docutils literal notranslate"><span class="pre">crypto</span></code> crypto test</a></li>
<li class="toctree-l3"><a class="reference internal" href="../cxxtest/index.html"><code class="docutils literal notranslate"><span class="pre">cxxtest</span></code> C++ test program</a></li>
<li class="toctree-l3"><a class="reference internal" href="../drivertest/index.html"><code class="docutils literal notranslate"><span class="pre">drivertest</span></code> vela cmocka driver test</a></li>
<li class="toctree-l3"><a class="reference internal" href="../fatutf8/index.html"><code class="docutils literal notranslate"><span class="pre">fatutf8</span></code> FAT UTF8 test</a></li>
<li class="toctree-l3"><a class="reference internal" href="../fdsantest/index.html"><code class="docutils literal notranslate"><span class="pre">fdsantest</span></code> vela cmocka fdsan test</a></li>
<li class="toctree-l3"><a class="reference internal" href="../fmemopen/index.html"><code class="docutils literal notranslate"><span class="pre">fmemopen</span></code> - fmemopen test tool</a></li>
<li class="toctree-l3"><a class="reference internal" href="../fopencookie/index.html"><code class="docutils literal notranslate"><span class="pre">fopencookie</span></code> fopencookie test tool</a></li>
<li class="toctree-l3"><a class="reference internal" href="../fstest/index.html"><code class="docutils literal notranslate"><span class="pre">fstest</span></code> Generic file system test</a></li>
<li class="toctree-l3"><a class="reference internal" href="../getprime/index.html"><code class="docutils literal notranslate"><span class="pre">getprime</span></code> getprime example</a></li>
<li class="toctree-l3"><a class="reference internal" href="../irtest/index.html"><code class="docutils literal notranslate"><span class="pre">irtest</span></code> IR driver test</a></li>
<li class="toctree-l3"><a class="reference internal" href="../lpt/index.html"><code class="docutils literal notranslate"><span class="pre">ltp</span></code> Linux Test Project</a></li>
<li class="toctree-l3"><a class="reference internal" href="../memstress/index.html"><code class="docutils literal notranslate"><span class="pre">memstress</span></code> memory stress test</a></li>
<li class="toctree-l3"><a class="reference internal" href="../memtester/index.html"><code class="docutils literal notranslate"><span class="pre">memtester</span></code> utils_memtester</a></li>
<li class="toctree-l3"><a class="reference internal" href="../mm/index.html"><code class="docutils literal notranslate"><span class="pre">mm</span></code> Memory management test</a></li>
<li class="toctree-l3"><a class="reference internal" href="../monkey/index.html"><code class="docutils literal notranslate"><span class="pre">monkey</span></code> Monkey test</a></li>
<li class="toctree-l3"><a class="reference internal" href="../mtd_config_fs/index.html"><code class="docutils literal notranslate"><span class="pre">mtd_nvs</span></code> MTD non-volatile storage Test</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#"><code class="docutils literal notranslate"><span class="pre">nand</span></code> - NAND Flash Device Simulator</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#structure-of-nand-flash">Structure of NAND Flash</a></li>
<li class="toctree-l4"><a class="reference internal" href="#ram-to-device-lower-half">RAM to Device (Lower Half)</a></li>
<li class="toctree-l4"><a class="reference internal" href="#upper-half">Upper Half</a></li>
<li class="toctree-l4"><a class="reference internal" href="#wrapper-over-upper-half">Wrapper Over Upper Half</a></li>
<li class="toctree-l4"><a class="reference internal" href="#registering-device-daemon">Registering Device &amp; Daemon</a></li>
<li class="toctree-l4"><a class="reference internal" href="#known-issues">Known Issues</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../nist-sts/index.html"><code class="docutils literal notranslate"><span class="pre">nist-sts</span></code> NIST Statistical Test Suite</a></li>
<li class="toctree-l3"><a class="reference internal" href="../nxfss/index.html"><code class="docutils literal notranslate"><span class="pre">nxffs</span></code> NXFFS file system example</a></li>
<li class="toctree-l3"><a class="reference internal" href="../open_memstream/index.html"><code class="docutils literal notranslate"><span class="pre">open_memstream</span></code> - open_memstream test tool</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ostest/index.html"><code class="docutils literal notranslate"><span class="pre">ostest</span></code> OS test</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ramtest/index.html"><code class="docutils literal notranslate"><span class="pre">ramtest</span></code> RAM Test</a></li>
<li class="toctree-l3"><a class="reference internal" href="../scanftest/index.html"><code class="docutils literal notranslate"><span class="pre">scanftest</span></code> sscanf() test</a></li>
<li class="toctree-l3"><a class="reference internal" href="../sd_bench/index.html"><code class="docutils literal notranslate"><span class="pre">sd_bench</span></code> SD card or mount point bench test</a></li>
<li class="toctree-l3"><a class="reference internal" href="../sd_stress/index.html"><code class="docutils literal notranslate"><span class="pre">sd_stress</span></code> SD card or mount point stress test</a></li>
<li class="toctree-l3"><a class="reference internal" href="../sensortest/index.html"><code class="docutils literal notranslate"><span class="pre">sensortest</span></code> Sensor driver test</a></li>
<li class="toctree-l3"><a class="reference internal" href="../setest/index.html"><code class="docutils literal notranslate"><span class="pre">setest</span></code> Secure Element driver test</a></li>
<li class="toctree-l3"><a class="reference internal" href="../smart/index.html"><code class="docutils literal notranslate"><span class="pre">smart</span></code> SMART File System</a></li>
<li class="toctree-l3"><a class="reference internal" href="../smart_test/index.html"><code class="docutils literal notranslate"><span class="pre">smart_test</span></code> SMART File System</a></li>
<li class="toctree-l3"><a class="reference internal" href="../smp/index.html"><code class="docutils literal notranslate"><span class="pre">smp</span></code> SMP example</a></li>
<li class="toctree-l3"><a class="reference internal" href="../uclibcxx_test/index.html"><code class="docutils literal notranslate"><span class="pre">uclibcxx_test</span></code> uclibcxx test</a></li>
<li class="toctree-l3"><a class="reference internal" href="../unity/index.html"><code class="docutils literal notranslate"><span class="pre">unity</span></code> Unity testing framework</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../tools/index.html">Host Side Tools</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../wireless/index.html">Wireless Libraries and NSH Add-Ons</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../examples/index.html">Examples</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../implementation/index.html">Implementation Details</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../reference/index.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq/index.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/index.html">Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../glossary.html">Glossary</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">NuttX</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Applications</a></li>
          <li class="breadcrumb-item"><a href="../index.html">Testing</a></li>
      <li class="breadcrumb-item active"><code class="docutils literal notranslate"><span class="pre">nand</span></code> - NAND Flash Device Simulator</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../_sources/applications/testing/nand_sim/index.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="nand-nand-flash-device-simulator">
<h1><code class="docutils literal notranslate"><span class="pre">nand</span></code> - NAND Flash Device Simulator<a class="headerlink" href="#nand-nand-flash-device-simulator" title="Permalink to this heading"></a></h1>
<p>In order to test the filesystems that work with NAND flash devices in a
simulator, this exists to provide a virtual NAND flash device, along with its
driver, to allow manual (or scripted) testing, as well as to provide an
option to log the various actions performed under-the-hood along with the
state of the device, which includes the read, write and erase counts of each
page in the device.</p>
<section id="structure-of-nand-flash">
<h2>Structure of NAND Flash<a class="headerlink" href="#structure-of-nand-flash" title="Permalink to this heading"></a></h2>
<p>Most NAND flashes share a common interface, specified by the
<a class="reference external" href="https://www.onfi.org/">Open NAND Flash Interface (ONFI)</a>.</p>
<p>The important part from it, required in this context, is that a NAND Flash is
divided into a lot of blocks. And each blocks are divided into a lot of
pages.</p>
<p>Here’s the peculiar bit. If you want to erase a page, you need to erase
the <em>entire</em> block that it is part of, ie. blocks are the smallest erasable
units in a NAND flash. However, a page is the smallest unit to which you can
write data, or read data from.</p>
<p>Why would you need erase operation? The Program/ Erase (P/E) cycle states
that a page (and thus its block) need to be erased first before data can be
written to it (Erase-Before-Write).</p>
<p>Each page has a data area, and a spare area. Depending on the data area’s
size, the spare area may have different structures (schemes). All the
required schemes are defined in <code class="docutils literal notranslate"><span class="pre">/drivers/mtd/mtd_nandscheme.c</span></code> (in
the <code class="docutils literal notranslate"><span class="pre">g_nand_sparescheme*</span></code> structures).</p>
<p>Due to the nature of NAND flash, upon testing, a manufaturer may decide that
a certain block fails some test(s), and mark it as a <strong>bad block</strong> by
writing a certain value in a certain position in the spare area (depends on
data area’s size, and thus, the spare area’s scheme) of every page in it.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<ul class="simple">
<li><p>While certain blocks may <em>still work</em> even if they are marked as bad,
it’s inadvisable to store any data in it.</p></li>
<li><p>The spare data is the <strong>only</strong> record of a block being bad or not.
Please do not erase it.</p></li>
<li><p>Certain blocks may become bad after continuous usage, and would need
to be marked as such by either the filesystem or the driver.</p></li>
</ul>
</div>
<p>Currently, this simulator supports only 512 B sized pages, which means it
will follow  the <code class="docutils literal notranslate"><span class="pre">g_nand_sparescheme512</span></code> scheme for its spare area, and
thus have a bad block marker at index <code class="docutils literal notranslate"><span class="pre">5</span></code>.</p>
<p>If a block is <em>not</em> bad, it contains a value of <code class="docutils literal notranslate"><span class="pre">0xff</span></code> in the place of a
bad block marker. Any other value denote it’s a bad block.</p>
</section>
<section id="ram-to-device-lower-half">
<h2>RAM to Device (Lower Half)<a class="headerlink" href="#ram-to-device-lower-half" title="Permalink to this heading"></a></h2>
<p>Since this is an emulation, RAM of the host running the simulator is used
to create the device. While the speed of operations won’t be even close to
the original, this being in the RAM, which works multitudes faster than
actual device, the functionality on the other hand has been kept consistent
to the utmost.</p>
<p>First, <code class="docutils literal notranslate"><span class="pre">/include/nuttx/mtd/nand.h</span></code> has a structure <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">nand_dev_s</span></code>
defining a raw NAND MTD device (lowest level). Its field <code class="docutils literal notranslate"><span class="pre">nand_dev_s-&gt;raw</span></code>
is of type <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">nand_raw_s</span> <span class="pre">*</span></code> (defined in
<code class="docutils literal notranslate"><span class="pre">include/nuttx/mtd/nand_raw.h</span></code>), and this is what will hold the methods
for the raw device. There are primarily 3 methods that need to be looked
into:</p>
<ul class="simple">
<li><p>eraseblock</p></li>
<li><p>rawread</p></li>
<li><p>rawwrite</p></li>
</ul>
<p>Conforming to the functionality of NAND flashes, these three were implemented
as <code class="docutils literal notranslate"><span class="pre">nand_ram_*</span></code> in <code class="docutils literal notranslate"><span class="pre">/drivers/mtd/nand_ram.c</span></code> to emulate RAM into a
virtual NAND flash.</p>
<p>While in real devices, the spare area follows the data area (in most schemes)
, since this is virtual, we can get away with keeping the two into two
separate arrays, namely <code class="docutils literal notranslate"><span class="pre">nand_ram_flash_data</span></code> and <code class="docutils literal notranslate"><span class="pre">nand_ram_flash_spare</span></code>
for data and spare respectively. Each array has as many elements as number
of pages in the device.</p>
<p>As the spare areas has some spare bytes we can use, some space is used as
counters for the reads/writes/erases each page faces, thus giving a clear
picture of wear of the virtual device to the tester.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>ECC extension has not been implemented yet, so ECC bits in spare are
yet to be used or initialized properly.</p>
</div>
<p>The method <code class="docutils literal notranslate"><span class="pre">nand_ram_initialize()</span></code> takes in a preallocated space for a
raw device (of type <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">nand_raw_s</span></code> as defined in
<code class="docutils literal notranslate"><span class="pre">include/nuttx/mtd/nand_raw.h</span></code>) and attaches these 3 custom methods as well
as device information like page size, block size, etc. to it. These form
the lower half of the driver.</p>
</section>
<section id="upper-half">
<h2>Upper Half<a class="headerlink" href="#upper-half" title="Permalink to this heading"></a></h2>
<p>The method <code class="docutils literal notranslate"><span class="pre">nand_ram_initialize()</span></code> also initializes a
<code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">mtd_dev_s</span> <span class="pre">*</span></code> (defined in <code class="docutils literal notranslate"><span class="pre">include/nuttx/mtd/mtd.h</span></code>), which it
returns. This structure contains a reference to our custom lower half in
<code class="docutils literal notranslate"><span class="pre">mtd_dev_s-&gt;raw</span></code>, as well as an upper half containing methods <code class="docutils literal notranslate"><span class="pre">nand_*</span></code>
(defined in <code class="docutils literal notranslate"><span class="pre">drivers/mtd/mtd_nand.c</span></code>).</p>
</section>
<section id="wrapper-over-upper-half">
<h2>Wrapper Over Upper Half<a class="headerlink" href="#wrapper-over-upper-half" title="Permalink to this heading"></a></h2>
<p>The upper half, along with the lower half attached to it, received from
<code class="docutils literal notranslate"><span class="pre">nand_ram_initialize()</span></code> contains these 5 methods for the upper half:</p>
<ul class="simple">
<li><p>erase</p></li>
<li><p>bread</p></li>
<li><p>bwrite</p></li>
<li><p>ioctl</p></li>
<li><p>isbad</p></li>
<li><p>markbad</p></li>
</ul>
<p>Each driver’s upper half needs to be registered with NuttX before it can
appear in the list of devices (in <code class="docutils literal notranslate"><span class="pre">/dev</span></code>). Instead of the previously
acquired upper-half, we’ll be registering a wrapper over it, to improve
logging. The wrapper methods are defined as <code class="docutils literal notranslate"><span class="pre">nand_wrapper_*</span></code> in
<code class="docutils literal notranslate"><span class="pre">drivers/mtd/mtd_nandwrapper.c</span></code>.</p>
<p>Here’s a complicated bit. The actual upper half is an MTD device, but
more specifically, it is a NAND MTD device, which is represented by
<code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">nand_dev_s</span></code>. Due to how it is defined, <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">mtd_dev_s</span></code> forms
the very start of <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">nand_dev_s</span></code>, and hence they can be type-casted
to each other (provided required memory is accessible). Our wrapper, being a
wrapper over an MTD device, is an MTD device itself as well. MTD device
methods take in a <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">mtd_dev_s</span> <span class="pre">*dev</span></code> which describe the device
itself (which is the actual device that is registered using
<code class="docutils literal notranslate"><span class="pre">register_mtddriver</span></code>), which includes its methods. Our wrapper methods
receive such a device as well, which contains the wrapper device including
the wrapper functions. But, this way, there is no way of accessing the
methods of the actual upper half itself. Thus, instead of <code class="docutils literal notranslate"><span class="pre">dev</span></code> being
of type <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">nand_dev_s</span></code>, it is actually of type
<code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">nand_wrapper_dev_s</span></code> which is a superset of <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">nand_dev_s</span></code>,
who itself is a superset of <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">mtd_dev_s</span></code>. Similar to previous case,
<code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">mtd_dev_s</span></code> forms the very start of <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">nand_wrapper_dev_s</span></code>,
and thus the types are inter-changeable.</p>
<p>The methods <code class="docutils literal notranslate"><span class="pre">nand_wrapper_*</span></code> in <code class="docutils literal notranslate"><span class="pre">drivers/mtd/mtd_nandwrapper.c</span></code> all
pass the parameters to corresponding method of the actual upper half
after logging it. <em>But, the device passed on to the actual upper half
is still the wrapper, not the actual upper half, as the upper half methods
may call the other methods as well internally and we might want to log
them as well</em>.</p>
</section>
<section id="registering-device-daemon">
<h2>Registering Device &amp; Daemon<a class="headerlink" href="#registering-device-daemon" title="Permalink to this heading"></a></h2>
<p>This wrapper is then registered using <code class="docutils literal notranslate"><span class="pre">register_mtddriver</span></code>, and this
whole thing is converted to be a daemon, so that the device can keep running
in the background.</p>
<p>Making it a daemon is achieved by using <code class="docutils literal notranslate"><span class="pre">fork()</span></code>, killing the parent, and
using <code class="docutils literal notranslate"><span class="pre">daemon()</span></code> in child.</p>
</section>
<section id="known-issues">
<h2>Known Issues<a class="headerlink" href="#known-issues" title="Permalink to this heading"></a></h2>
<ul class="simple">
<li><p>ECC is not implemented yet.</p></li>
<li><p>MLC NAND Flash is not implemented yet.</p></li>
<li><p>Due to the fixed name of the device, there can’t be more than one instance
of this virtual device.</p></li>
</ul>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../mtd_config_fs/index.html" class="btn btn-neutral float-left" title="mtd_nvs MTD non-volatile storage Test" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../nist-sts/index.html" class="btn btn-neutral float-right" title="nist-sts NIST Statistical Test Suite" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, The Apache Software Foundation.</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>