<!--
 Documentation/_templates/layout.html

 Licensed to the Apache Software Foundation (ASF) under one or more
 contributor license agreements.  See the NOTICE file distributed with
 this work for additional information regarding copyright ownership.  The
 ASF licenses this file to you under the Apache License, Version 2.0 (the
 "License"); you may not use this file except in compliance with the
 License.  You may obtain a copy of the License at

   http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
 WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 License for the specific language governing permissions and limitations
 under the License.
-->



<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>smf State Machine Framework &mdash; NuttX latest documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css" />
      <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css" />
      <link rel="stylesheet" type="text/css" href="../../../_static/sphinx_collapse.css" />
      <link rel="stylesheet" type="text/css" href="../../../_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css" />
      <link rel="stylesheet" type="text/css" href="../../../_static/custom.css" />

  
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
      <script src="../../../_static/jquery.js"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
      <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
      <script src="../../../_static/doctools.js"></script>
      <script src="../../../_static/sphinx_highlight.js"></script>
      <script src="../../../_static/clipboard.min.js"></script>
      <script src="../../../_static/copybutton.js"></script>
      <script src="../../../_static/design-tabs.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="spi SPI Tool" href="../spi/index.html" />
    <link rel="prev" title="setlogmask “setlogmask” command" href="../setlogmask/index.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
  
    <a href="../../../index.html" class="icon icon-home"> NuttX
  

  
  </a>

  <!-- this version selector is quite ugly, should be probably replaced by something
       more modern -->

  <div class="version-selector">
    <select onchange="javascript:location.href = this.value;">
    
    <option value="../../../../latest" selected="selected">latest</option>
    
    <option value="../../../../10.0.0" >10.0.0</option>
    
    <option value="../../../../10.0.1" >10.0.1</option>
    
    <option value="../../../../10.1.0" >10.1.0</option>
    
    <option value="../../../../10.2.0" >10.2.0</option>
    
    <option value="../../../../10.3.0" >10.3.0</option>
    
    <option value="../../../../11.0.0" >11.0.0</option>
    
    <option value="../../../../12.0.0" >12.0.0</option>
    
    <option value="../../../../12.1.0" >12.1.0</option>
    
    <option value="../../../../12.2.0" >12.2.0</option>
    
    <option value="../../../../12.2.1" >12.2.1</option>
    
    <option value="../../../../12.3.0" >12.3.0</option>
    
    <option value="../../../../12.4.0" >12.4.0</option>
    
    <option value="../../../../12.5.0" >12.5.0</option>
    
    <option value="../../../../12.5.1" >12.5.1</option>
    
    <option value="../../../../12.6.0" >12.6.0</option>
    
    <option value="../../../../12.7.0" >12.7.0</option>
    
    <option value="../../../../12.8.0" >12.8.0</option>
    
    <option value="../../../../12.9.0" >12.9.0</option>
    
    <option value="../../../../12.10.0" >12.10.0</option>
    
    <option value="../../../../12.11.0" >12.11.0</option>
    
    <option value="../../../../12.12.0" >12.12.0</option>
    
    </select>
  </div>

  
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Table of Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../index.html">Home</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../introduction/index.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../quickstart/index.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing/index.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../introduction/inviolables.html">The Inviolable Principles of NuttX</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../platforms/index.html">Supported Platforms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../components/index.html">OS Components</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../index.html">Applications</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../audioutils/index.html">Audio Utility libraries</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../boot/index.html">Bootloader Utilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../benchmarks/index.html">Benchmark Applications</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../canutils/index.html">CAN Utilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../crypto/index.html">Cryptography Library Support</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../fsutils/index.html">File System Utilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../games/index.html">Games</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../graphics/index.html">Graphics Support</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../industry/index.html">Industrial Applications</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../inertial/index.html">Inertial Libraries Support</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../interpreters/index.html">Interpreters</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../logging/index.html">Logging Utilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../lte/index.html">LTE Libraries and NSH Add-Ons</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../math/index.html">Math Library Support</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../mlearing/index.html">Machine Learning Support</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../netutils/index.html">Network Utilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../nsh/index.html">NuttShell (NSH)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../sdr/index.html">Software Defined Radio Libraries</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.html">System Libraries and NSH Add-Ons</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../adb/index.html"><code class="docutils literal notranslate"><span class="pre">adb</span></code> ADB daemon application</a></li>
<li class="toctree-l3"><a class="reference internal" href="../argtable3/index.html"><code class="docutils literal notranslate"><span class="pre">argtable3</span></code> ARGTABLE3 library</a></li>
<li class="toctree-l3"><a class="reference internal" href="../cdcacm/index.html"><code class="docutils literal notranslate"><span class="pre">cdcacm</span></code> USB CDC/ACM Device Commands</a></li>
<li class="toctree-l3"><a class="reference internal" href="../cfgdata/index.html"><code class="docutils literal notranslate"><span class="pre">cfgdata</span></code> Cfgdata Command</a></li>
<li class="toctree-l3"><a class="reference internal" href="../cle/index.html"><code class="docutils literal notranslate"><span class="pre">cle</span></code> EMACS-like Command Line Editor</a></li>
<li class="toctree-l3"><a class="reference internal" href="../composite/index.html"><code class="docutils literal notranslate"><span class="pre">composite</span></code> USB Composite Device Commands</a></li>
<li class="toctree-l3"><a class="reference internal" href="../coredump/index.html"><code class="docutils literal notranslate"><span class="pre">coredump</span></code> Coredump tool capture system status</a></li>
<li class="toctree-l3"><a class="reference internal" href="../crimon/index.html"><code class="docutils literal notranslate"><span class="pre">critmon</span></code> Critical Section Monitor</a></li>
<li class="toctree-l3"><a class="reference internal" href="../cu/index.html"><code class="docutils literal notranslate"><span class="pre">cu</span></code> CU minimal serial terminal</a></li>
<li class="toctree-l3"><a class="reference internal" href="../dd/index.html"><code class="docutils literal notranslate"><span class="pre">dd</span></code> system ‘dd’ command</a></li>
<li class="toctree-l3"><a class="reference internal" href="../debugpoint/index.html"><code class="docutils literal notranslate"><span class="pre">debugpoint</span></code> Debug Utility</a></li>
<li class="toctree-l3"><a class="reference internal" href="../dhcp6c/index.html"><code class="docutils literal notranslate"><span class="pre">dhcp6c</span></code> DHCP IPv6 Address Renewal</a></li>
<li class="toctree-l3"><a class="reference internal" href="../dhcpc/index.html"><code class="docutils literal notranslate"><span class="pre">dhcpc</span></code> DHCP Address Renewal</a></li>
<li class="toctree-l3"><a class="reference internal" href="../dumpstack/index.html"><code class="docutils literal notranslate"><span class="pre">dumpstack</span></code> Task Call Stack Backtrace</a></li>
<li class="toctree-l3"><a class="reference internal" href="../fastboot/index.html"><code class="docutils literal notranslate"><span class="pre">fastboot</span></code> fastbootd</a></li>
<li class="toctree-l3"><a class="reference internal" href="../fdt/index.html"><code class="docutils literal notranslate"><span class="pre">fdt</span></code> fdt utility tools</a></li>
<li class="toctree-l3"><a class="reference internal" href="../flash_eraseall/index.html"><code class="docutils literal notranslate"><span class="pre">flash_eraseall</span></code> FLASH Erase-all Command</a></li>
<li class="toctree-l3"><a class="reference internal" href="../gcov/index.html"><code class="docutils literal notranslate"><span class="pre">gcov</span></code> gcov tool</a></li>
<li class="toctree-l3"><a class="reference internal" href="../gdbstub/index.html"><code class="docutils literal notranslate"><span class="pre">gdbstub</span></code> GDBSTUB</a></li>
<li class="toctree-l3"><a class="reference internal" href="../gprof/index.html"><code class="docutils literal notranslate"><span class="pre">gprof</span></code> GNU Profile tool</a></li>
<li class="toctree-l3"><a class="reference internal" href="../hex2bin/index.html"><code class="docutils literal notranslate"><span class="pre">hex2bin</span></code> Intel HEX to binary conversion</a></li>
<li class="toctree-l3"><a class="reference internal" href="../hexed/index.html"><code class="docutils literal notranslate"><span class="pre">hexed</span></code> Hex editor</a></li>
<li class="toctree-l3"><a class="reference internal" href="../hostname/index.html"><code class="docutils literal notranslate"><span class="pre">hostname</span></code> “hostname” command</a></li>
<li class="toctree-l3"><a class="reference internal" href="../i2c/index.html"><code class="docutils literal notranslate"><span class="pre">i2c</span></code> I2C Tool</a></li>
<li class="toctree-l3"><a class="reference internal" href="../input/index.html"><code class="docutils literal notranslate"><span class="pre">input</span></code> input tool</a></li>
<li class="toctree-l3"><a class="reference internal" href="../iptables/index.html"><code class="docutils literal notranslate"><span class="pre">iptables</span></code> “iptables” command</a></li>
<li class="toctree-l3"><a class="reference internal" href="../libuv/index.html"><code class="docutils literal notranslate"><span class="pre">libuv</span></code> libuv asynchronous I/O Library</a></li>
<li class="toctree-l3"><a class="reference internal" href="../lm75/index.html"><code class="docutils literal notranslate"><span class="pre">lm75</span></code> LM75 Temperature</a></li>
<li class="toctree-l3"><a class="reference internal" href="../lzf/index.html"><code class="docutils literal notranslate"><span class="pre">lzf</span></code> LZF compression tool</a></li>
<li class="toctree-l3"><a class="reference internal" href="../mdio/index.html"><code class="docutils literal notranslate"><span class="pre">mdio</span></code> PHY MDIO tool</a></li>
<li class="toctree-l3"><a class="reference internal" href="../netdb/index.html"><code class="docutils literal notranslate"><span class="pre">netdb</span></code> netdb interface</a></li>
<li class="toctree-l3"><a class="reference internal" href="../nsh/index.html"><code class="docutils literal notranslate"><span class="pre">nsh</span></code> NuttShell (NSH) example</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ntpc/index.html"><code class="docutils literal notranslate"><span class="pre">ntpc</span></code> NTP Daemon Commands</a></li>
<li class="toctree-l3"><a class="reference internal" href="../nxcamera/index.html"><code class="docutils literal notranslate"><span class="pre">nxcamera</span></code> NxCamera video test application</a></li>
<li class="toctree-l3"><a class="reference internal" href="../nxcodec/index.html"><code class="docutils literal notranslate"><span class="pre">nxcodec</span></code> NxCodec video codec test application</a></li>
<li class="toctree-l3"><a class="reference internal" href="../nxdiag/index.html"><code class="docutils literal notranslate"><span class="pre">nxdiag</span></code> NuttX Diagnostic Tool</a></li>
<li class="toctree-l3"><a class="reference internal" href="../nxlooper/index.html"><code class="docutils literal notranslate"><span class="pre">nxlooper</span></code> NxLooper audio test application</a></li>
<li class="toctree-l3"><a class="reference internal" href="../nxplayer/index.html"><code class="docutils literal notranslate"><span class="pre">nxplayer</span></code> NxPlayer Media Player</a></li>
<li class="toctree-l3"><a class="reference internal" href="../nxrecorder/index.html"><code class="docutils literal notranslate"><span class="pre">nxrecorder</span></code> NxRecorder pcm raw data Recorder</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ofloader/index.html"><code class="docutils literal notranslate"><span class="pre">ofloader</span></code> Open flash loader</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ping/index.html"><code class="docutils literal notranslate"><span class="pre">ping</span></code> ICMP “ping” command</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ping6/index.html"><code class="docutils literal notranslate"><span class="pre">ping6</span></code> ICMPv6 “ping6” command</a></li>
<li class="toctree-l3"><a class="reference internal" href="../popen/index.html"><code class="docutils literal notranslate"><span class="pre">popen</span></code> popen()/pclose() Functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="../psmq/index.html"><code class="docutils literal notranslate"><span class="pre">psmq</span></code> Publish Subscribe Message Queue</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ptpd/index.html"><code class="docutils literal notranslate"><span class="pre">ptpd</span></code> PTP daemon commands</a></li>
<li class="toctree-l3"><a class="reference internal" href="../readline/index.html"><code class="docutils literal notranslate"><span class="pre">readline</span></code> readline() Support</a></li>
<li class="toctree-l3"><a class="reference internal" href="../sched_note/index.html"><code class="docutils literal notranslate"><span class="pre">sched_note</span></code> Scheduler monitor</a></li>
<li class="toctree-l3"><a class="reference internal" href="../setlogmask/index.html"><code class="docutils literal notranslate"><span class="pre">setlogmask</span></code> “setlogmask” command</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#"><code class="docutils literal notranslate"><span class="pre">smf</span></code> State Machine Framework</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l4"><a class="reference internal" href="#architecture">Architecture</a></li>
<li class="toctree-l4"><a class="reference internal" href="#state-model">State Model</a></li>
<li class="toctree-l4"><a class="reference internal" href="#state-machine-creation">State Machine Creation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#state-machine-execution">State Machine Execution</a></li>
<li class="toctree-l4"><a class="reference internal" href="#state-machine-termination">State Machine Termination</a></li>
<li class="toctree-l4"><a class="reference internal" href="#retrieving-current-state">Retrieving Current State</a></li>
<li class="toctree-l4"><a class="reference internal" href="#uml-state-machines">UML State Machines</a></li>
<li class="toctree-l4"><a class="reference internal" href="#state-machine-examples">State Machine Examples</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#flat-state-machine-example">Flat State Machine Example</a></li>
<li class="toctree-l5"><a class="reference internal" href="#hierarchical-state-machine-hsm">Hierarchical State Machine (HSM)</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="#initial-transitions">Initial Transitions</a></li>
<li class="toctree-l4"><a class="reference internal" href="#state-execution-model">State Execution Model</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#state-run-semantics">State Run Semantics</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="#state-transitions">State Transitions</a></li>
<li class="toctree-l4"><a class="reference internal" href="#termination">Termination</a></li>
<li class="toctree-l4"><a class="reference internal" href="#state-introspection">State Introspection</a></li>
<li class="toctree-l4"><a class="reference internal" href="#uml-compliance">UML Compliance</a></li>
<li class="toctree-l4"><a class="reference internal" href="#notes-and-constraints">Notes and Constraints</a></li>
<li class="toctree-l4"><a class="reference internal" href="#configuration-options">Configuration Options</a></li>
<li class="toctree-l4"><a class="reference internal" href="#code-location">Code Location</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../spi/index.html"><code class="docutils literal notranslate"><span class="pre">spi</span></code> SPI Tool</a></li>
<li class="toctree-l3"><a class="reference internal" href="../stackmonitor/index.html"><code class="docutils literal notranslate"><span class="pre">stackmonitor</span></code> Stack Monitor</a></li>
<li class="toctree-l3"><a class="reference internal" href="../syslogd/index.html"><code class="docutils literal notranslate"><span class="pre">syslogd</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../system/index.html"><code class="docutils literal notranslate"><span class="pre">system</span></code> System Command</a></li>
<li class="toctree-l3"><a class="reference internal" href="../taskset/index.html"><code class="docutils literal notranslate"><span class="pre">taskset</span></code> Taskset Command</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tcpdump/index.html"><code class="docutils literal notranslate"><span class="pre">tcpdump</span></code> tcpdump command</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tee/index.html"><code class="docutils literal notranslate"><span class="pre">tee</span></code> Tee Command</a></li>
<li class="toctree-l3"><a class="reference internal" href="../telnet/index.html"><code class="docutils literal notranslate"><span class="pre">telnet</span></code> Telnet chat daemon</a></li>
<li class="toctree-l3"><a class="reference internal" href="../telnetd/index.html"><code class="docutils literal notranslate"><span class="pre">telnetd</span></code> Telnet daemon application</a></li>
<li class="toctree-l3"><a class="reference internal" href="../termcurses/index.html"><code class="docutils literal notranslate"><span class="pre">termcurses</span></code> Terminal Curses control support</a></li>
<li class="toctree-l3"><a class="reference internal" href="../trace/index.html"><code class="docutils literal notranslate"><span class="pre">trace</span></code> Trace command</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ubloxmodem/index.html"><code class="docutils literal notranslate"><span class="pre">ubloxmodem</span></code> u-blox modem configuration tool</a></li>
<li class="toctree-l3"><a class="reference internal" href="../uniqueid/index.html"><code class="docutils literal notranslate"><span class="pre">uniqueid</span></code> “uniqueid” command</a></li>
<li class="toctree-l3"><a class="reference internal" href="../uorb/index.html"><code class="docutils literal notranslate"><span class="pre">uorb</span></code> uorb(micro object request broker)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../usbmsc/index.html"><code class="docutils literal notranslate"><span class="pre">usbmsc</span></code> USB Mass Storage Device Commands</a></li>
<li class="toctree-l3"><a class="reference internal" href="../vi/index.html"><code class="docutils literal notranslate"><span class="pre">vi</span></code> VI Work-Alike Text Editor</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ymodem/index.html"><code class="docutils literal notranslate"><span class="pre">ymodem</span></code> YMODEM</a></li>
<li class="toctree-l3"><a class="reference internal" href="../zlib/index.html"><code class="docutils literal notranslate"><span class="pre">zlib</span></code> zlib data compression library</a></li>
<li class="toctree-l3"><a class="reference internal" href="../zmodem/index.html"><code class="docutils literal notranslate"><span class="pre">zmodem</span></code> Zmodem Commands</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../testing/index.html">Testing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tools/index.html">Host Side Tools</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../wireless/index.html">Wireless Libraries and NSH Add-Ons</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../examples/index.html">Examples</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../implementation/index.html">Implementation Details</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../reference/index.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq/index.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../debugging/index.html">Debugging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../testing/index.html">Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/index.html">Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../standards/index.html">Standards</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../security.html">Security</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../logos/index.html">NuttX Logos</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../_tags/tagsindex.html">Tags</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">NuttX</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Applications</a></li>
          <li class="breadcrumb-item"><a href="../index.html">System Libraries and NSH Add-Ons</a></li>
      <li class="breadcrumb-item active"><code class="docutils literal notranslate"><span class="pre">smf</span></code> State Machine Framework</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/apache/nuttx/blob/master/Documentation/applications/system/smf/index.rst" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="smf-state-machine-framework">
<span id="smf"></span><h1><code class="docutils literal notranslate"><span class="pre">smf</span></code> State Machine Framework<a class="headerlink" href="#smf-state-machine-framework" title="Permalink to this heading"></a></h1>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this heading"></a></h2>
<p>The State Machine Framework (SMF) is a lightweight, application-agnostic
framework for implementing finite and hierarchical state machines in NuttX.</p>
<p>SMF provides:
- Deterministic state transition semantics
- Optional hierarchical state machine (HSM) support
- Explicit entry, run, and exit actions
- No dynamic memory allocation
- Full control over the event loop by the application</p>
<p>The framework is suitable for deeply embedded systems where predictability,
low overhead, and explicit control flow are required.</p>
<p>Conceptually, this implementation is a direct port of the SMF originally
introduced in Zephyr RTOS, adapted to NuttX coding standards, build system,
and documentation conventions.</p>
</section>
<section id="architecture">
<h2>Architecture<a class="headerlink" href="#architecture" title="Permalink to this heading"></a></h2>
<p>SMF separates responsibilities clearly:</p>
<ul class="simple">
<li><p><strong>Framework responsibilities</strong>
- State transitions
- Entry/exit sequencing
- Hierarchy resolution (LCA)
- Termination handling</p></li>
<li><p><strong>Application responsibilities</strong>
- Event acquisition
- Event dispatching
- State machine scheduling
- Data model ownership</p></li>
</ul>
<p>This separation ensures that SMF remains fully reusable across applications
and execution models.</p>
</section>
<section id="state-model">
<h2>State Model<a class="headerlink" href="#state-model" title="Permalink to this heading"></a></h2>
<p>Each state is defined by up to three optional callbacks:</p>
<ul class="simple">
<li><p><strong>Entry action</strong></p></li>
<li><p><strong>Run action</strong></p></li>
<li><p><strong>Exit action</strong></p></li>
</ul>
<p>All actions operate on a user-defined object whose first member is
<code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">smf_ctx</span></code>.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span><span class="w"> </span><span class="nc">app_object</span>
<span class="p">{</span>
<span class="w">  </span><span class="k">struct</span><span class="w"> </span><span class="nc">smf_ctx</span><span class="w"> </span><span class="n">ctx</span><span class="p">;</span>
<span class="w">  </span><span class="cm">/* Application-specific data */</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">counter</span><span class="p">;</span>
<span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="n">error</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<p>This layout enables zero-cost casting using the <code class="docutils literal notranslate"><span class="pre">SMF_CTX()</span></code> macro.</p>
</section>
<section id="state-machine-creation">
<h2>State Machine Creation<a class="headerlink" href="#state-machine-creation" title="Permalink to this heading"></a></h2>
<p>A state machine is created by defining a table of states that’s indexed by an enum.
For example, the following creates three flat states:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">enum</span><span class="w"> </span><span class="n">demo_state</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">STATE_IDLE</span><span class="p">,</span>
<span class="w">  </span><span class="n">STATE_ACTIVE</span><span class="p">,</span>
<span class="w">  </span><span class="n">STATE_ERROR</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">smf_state</span><span class="w"> </span><span class="n">demo_states</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="p">[</span><span class="n">STATE_IDLE</span><span class="p">]</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">SMF_CREATE_STATE</span><span class="p">(</span><span class="n">idle_entry</span><span class="p">,</span><span class="w"> </span><span class="n">idle_run</span><span class="p">,</span><span class="w"> </span><span class="n">idle_exit</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">),</span>
<span class="w">  </span><span class="p">[</span><span class="n">STATE_ACTIVE</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SMF_CREATE_STATE</span><span class="p">(</span><span class="n">active_entry</span><span class="p">,</span><span class="w"> </span><span class="n">active_run</span><span class="p">,</span><span class="w"> </span><span class="n">active_exit</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">),</span>
<span class="w">  </span><span class="p">[</span><span class="n">STATE_ERROR</span><span class="p">]</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">SMF_CREATE_STATE</span><span class="p">(</span><span class="n">error_entry</span><span class="p">,</span><span class="w"> </span><span class="n">error_run</span><span class="p">,</span><span class="w"> </span><span class="n">error_exit</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">),</span>
<span class="p">};</span>
</pre></div>
</div>
<p>The example below creates three hierarchical states:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">enum</span><span class="w"> </span><span class="n">demo_state</span>
<span class="p">{</span>
<span class="w">   </span><span class="n">STATE_IDLE</span><span class="p">,</span>
<span class="w">   </span><span class="n">STATE_ACTIVE</span><span class="p">,</span>
<span class="w">   </span><span class="n">STATE_ERROR</span><span class="p">,</span>
<span class="w"> </span><span class="p">};</span>

<span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">smf_state</span><span class="w"> </span><span class="n">demo_states</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span>
<span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="p">[</span><span class="n">STATE_IDLE</span><span class="p">]</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">SMF_CREATE_STATE</span><span class="p">(</span><span class="n">idle_entry</span><span class="p">,</span><span class="w"> </span><span class="n">idle_run</span><span class="p">,</span><span class="w"> </span><span class="n">idle_exit</span><span class="p">,</span><span class="w"> </span><span class="n">parent_idle</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">),</span>
<span class="w">   </span><span class="p">[</span><span class="n">STATE_ACTIVE</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SMF_CREATE_STATE</span><span class="p">(</span><span class="n">active_entry</span><span class="p">,</span><span class="w"> </span><span class="n">active_run</span><span class="p">,</span><span class="w"> </span><span class="n">active_exit</span><span class="p">,</span><span class="w"> </span><span class="n">parent_active</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">),</span>
<span class="w">   </span><span class="p">[</span><span class="n">STATE_ERROR</span><span class="p">]</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">SMF_CREATE_STATE</span><span class="p">(</span><span class="n">error_entry</span><span class="p">,</span><span class="w"> </span><span class="n">error_run</span><span class="p">,</span><span class="w"> </span><span class="n">error_exit</span><span class="p">,</span><span class="w"> </span><span class="n">parent_error</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">),</span>
<span class="w"> </span><span class="p">};</span>
</pre></div>
</div>
<p>The next example creates a three-level hierarchical state machine with initial transitions from
parent state idle to child state error:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">enum</span><span class="w"> </span><span class="n">demo_state</span>
<span class="p">{</span>
<span class="w">   </span><span class="n">STATE_IDLE</span><span class="p">,</span>
<span class="w">   </span><span class="n">STATE_ACTIVE</span><span class="p">,</span>
<span class="w">   </span><span class="n">STATE_ERROR</span><span class="p">,</span>
<span class="w"> </span><span class="p">};</span>

<span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">smf_state</span><span class="w"> </span><span class="n">demo_states</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span>
<span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="p">[</span><span class="n">STATE_IDLE</span><span class="p">]</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">SMF_CREATE_STATE</span><span class="p">(</span><span class="n">idle_entry</span><span class="p">,</span><span class="w"> </span><span class="n">idle_run</span><span class="p">,</span><span class="w"> </span><span class="n">idle_exit</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">demo_states</span><span class="p">[</span><span class="n">STATE_ERROR</span><span class="p">]),</span>
<span class="w">   </span><span class="p">[</span><span class="n">STATE_ACTIVE</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SMF_CREATE_STATE</span><span class="p">(</span><span class="n">active_entry</span><span class="p">,</span><span class="w"> </span><span class="n">active_run</span><span class="p">,</span><span class="w"> </span><span class="n">active_exit</span><span class="p">,</span><span class="w"> </span><span class="n">demo_states</span><span class="p">[</span><span class="n">STATE_IDLE</span><span class="p">],</span><span class="w"> </span><span class="nb">NULL</span><span class="p">),</span>
<span class="w">   </span><span class="p">[</span><span class="n">STATE_ERROR</span><span class="p">]</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">SMF_CREATE_STATE</span><span class="p">(</span><span class="n">error_entry</span><span class="p">,</span><span class="w"> </span><span class="n">error_run</span><span class="p">,</span><span class="w"> </span><span class="n">error_exit</span><span class="p">,</span><span class="w"> </span><span class="n">demo_states</span><span class="p">[</span><span class="n">STATE_IDLE</span><span class="p">],</span><span class="w"> </span><span class="nb">NULL</span><span class="p">),</span>
<span class="w"> </span><span class="p">};</span>
</pre></div>
</div>
<p>To set the initial state of the state machine, call <code class="docutils literal notranslate"><span class="pre">smf_set_initial()</span></code>.
To transition between states, call <code class="docutils literal notranslate"><span class="pre">smf_set_state()</span></code> from entry or run actions.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If <code class="docutils literal notranslate"><span class="pre">CONFIG_SYSTEM_SMF_INITIAL_TRANSITION</span></code> is not set, <code class="docutils literal notranslate"><span class="pre">smf_set_initial()</span></code> and <code class="docutils literal notranslate"><span class="pre">smf_set_state()</span></code> function
should not be passed a parent state as the parent state does not know which child state to transition to.
Transitioning to a parent state is OK if an initial transition to a child state is defined.
A well-formed HSM should have initial transitions defined for all parent states.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>While the state machine is running, <code class="docutils literal notranslate"><span class="pre">smf_set_state()</span></code> should only be called
from the Entry or Run function. Calling <code class="docutils literal notranslate"><span class="pre">smf_set_state()</span></code> from Exit functions will generate a warning
in the log and no transition will occur.</p>
</div>
</section>
<section id="state-machine-execution">
<h2>State Machine Execution<a class="headerlink" href="#state-machine-execution" title="Permalink to this heading"></a></h2>
<p>To run the state machine, <code class="docutils literal notranslate"><span class="pre">smf_run_state()</span></code> function should be called in some application dependent way.
An application should cease calling smf_run_state if it returns a non-zero value.</p>
</section>
<section id="state-machine-termination">
<h2>State Machine Termination<a class="headerlink" href="#state-machine-termination" title="Permalink to this heading"></a></h2>
<p>To terminate the state machine, the <code class="docutils literal notranslate"><span class="pre">smf_set_terminate()</span></code> function should be called.
It can be called from the entry, run, or exit actions.
The function takes a non-zero user defined value that will be returned by the <code class="docutils literal notranslate"><span class="pre">smf_run_state()</span></code> function.</p>
</section>
<section id="retrieving-current-state">
<h2>Retrieving Current State<a class="headerlink" href="#retrieving-current-state" title="Permalink to this heading"></a></h2>
<p><strong>Leaf State</strong>: In the context of a hierarchical state machine, a leaf state is a state that does not contain
any child states. It represents the most granular level of state in the hierarchy,
where no further decomposition is possible.</p>
<p><strong>Executing State</strong>: The executing state refers to the state whose entry, run, or exit action is currently
being executed by the state machine. This may be a parent or leaf state, depending on the current operation.</p>
<p>To retrieve the current leaf state, the <code class="docutils literal notranslate"><span class="pre">smf_get_current_leaf_state()</span></code> function should be called.
For example:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">smf_state</span><span class="w"> </span><span class="o">*</span><span class="n">leaf_state</span><span class="p">;</span>
<span class="n">leaf_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">smf_get_current_leaf_state</span><span class="p">(</span><span class="n">SMF_CTX</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s_obj</span><span class="p">));</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If <code class="docutils literal notranslate"><span class="pre">CONFIG_SYSTEM_SMF_INITIAL_TRANSITION</span></code> is not enabled, or if the initial state of a parent state is not
defined, always set the state to a leaf state. Otherwise, the state machine may enter a parent state
directly, and <code class="docutils literal notranslate"><span class="pre">smf_get_current_leaf_state()</span></code> may return a parent state instead of a leaf state.
Ensure initial transitions are properly configured for all parent states to avoid malformed
hierarchical state machines.</p>
</div>
<p>To retrieve the state whose entry, run, or exit action is currently being executed,
use the <code class="docutils literal notranslate"><span class="pre">smf_get_current_executing_state()</span></code> function.</p>
</section>
<section id="uml-state-machines">
<h2>UML State Machines<a class="headerlink" href="#uml-state-machines" title="Permalink to this heading"></a></h2>
<p>SMF follows UML hierarchical state machine rules for transitions i.e., the entry and exit actions of the least
common ancestor are not executed on transition, unless said transition is a transition to self.</p>
<p>The UML Specification for StateMachines may be found in chapter 14 of the UML specification,
available here: <a class="reference external" href="https://www.omg.org/spec/UML/">https://www.omg.org/spec/UML/</a></p>
<p>SMF breaks from UML rules in:</p>
<ol class="arabic simple">
<li><p>Transition actions execute in the source state context, rather than after the exit actions are performed.</p></li>
<li><p>Only allowing external transitions to self, not to sub-states. A transition from a superstate to a child state is treated as a local transition.</p></li>
<li><p>Prohibiting transitions using <code class="docutils literal notranslate"><span class="pre">smf_set_state()</span></code> in exit actions.</p></li>
</ol>
<p>SMF also does not provide any pseudostates except the Initial Pseudostate.
Terminate pseudostates can be modelled by calling <code class="docutils literal notranslate"><span class="pre">smf_set_terminate()</span></code> from the entry action of a
‘terminate’ state. Orthogonal regions are modelled by calling <code class="docutils literal notranslate"><span class="pre">smf_run_state()</span></code> for each region.</p>
</section>
<section id="state-machine-examples">
<h2>State Machine Examples<a class="headerlink" href="#state-machine-examples" title="Permalink to this heading"></a></h2>
<section id="flat-state-machine-example">
<h3>Flat State Machine Example<a class="headerlink" href="#flat-state-machine-example" title="Permalink to this heading"></a></h3>
<p>This example turns the following state diagram into code using the SMF, where the initial state is STATE_IDLE.</p>
<figure class="align-center" id="id1">
<a class="reference internal image-reference" href="../../../_images/Flat-state-machine-diagram.png"><img alt="Flat State Machine Diagram" src="../../../_images/Flat-state-machine-diagram.png" style="width: 30%;" /></a>
<figcaption>
<p><span class="caption-text">Flat state machine example implemented using SMF.</span><a class="headerlink" href="#id1" title="Permalink to this image"></a></p>
</figcaption>
</figure>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;system/smf.h&gt;</span>

<span class="cm">/* Forward declaration of state table */</span>
<span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">smf_state</span><span class="w"> </span><span class="n">demo_states</span><span class="p">[];</span>

<span class="cm">/* List of demo states */</span>
<span class="w">   </span><span class="k">enum</span><span class="w"> </span><span class="n">demo_state</span>
<span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="n">STATE_IDLE</span><span class="p">,</span>
<span class="w">   </span><span class="n">STATE_ACTIVE</span><span class="p">,</span>
<span class="w">   </span><span class="n">STATE_ERROR</span><span class="p">,</span>
<span class="w"> </span><span class="p">};</span>

<span class="cm">/* User defined object */</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">s_object</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="cm">/* This must be first */</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">smf_ctx</span><span class="w"> </span><span class="n">ctx</span><span class="p">;</span>

<span class="w">        </span><span class="cm">/* Other state specific data add here */</span>
<span class="p">}</span><span class="w"> </span><span class="n">s_obj</span><span class="p">;</span>

<span class="cm">/* State idle */</span>
<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">idle_entry</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">o</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="cm">/* Do something */</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="k">enum</span><span class="w"> </span><span class="n">smf_state_result</span><span class="w"> </span><span class="nf">idle_run</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">o</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">smf_set_state</span><span class="p">(</span><span class="n">SMF_CTX</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s_obj</span><span class="p">),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">demo_states</span><span class="p">[</span><span class="n">STATE_ACTIVE</span><span class="p">]);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">SMF_EVENT_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">idle_exit</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">o</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="cm">/* Do something */</span>
<span class="p">}</span>

<span class="cm">/* State active */</span>
<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">active_entry</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">o</span><span class="p">)</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="cm">/* Do something */</span>
<span class="w">  </span><span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="k">enum</span><span class="w"> </span><span class="n">smf_state_result</span><span class="w"> </span><span class="nf">active_run</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">o</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">smf_set_state</span><span class="p">(</span><span class="n">SMF_CTX</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s_obj</span><span class="p">),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">demo_states</span><span class="p">[</span><span class="n">STATE_ERROR</span><span class="p">]);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">SMF_EVENT_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">active_exit</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">o</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="cm">/* Do something */</span>
<span class="p">}</span>

<span class="cm">/* State error */</span>
<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">error_entry</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">o</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="cm">/* Do something */</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="k">enum</span><span class="w"> </span><span class="n">smf_state_result</span><span class="w"> </span><span class="nf">error_run</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">o</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">smf_set_state</span><span class="p">(</span><span class="n">SMF_CTX</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s_obj</span><span class="p">),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">demo_states</span><span class="p">[</span><span class="n">STATE_IDLE</span><span class="p">]);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">SMF_EVENT_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">error_exit</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">o</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="cm">/* Do something */</span>
<span class="p">}</span>

<span class="cm">/* Populate state table */</span>
<span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">smf_state</span><span class="w"> </span><span class="n">demo_states</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="p">[</span><span class="n">STATE_IDLE</span><span class="p">]</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">SMF_CREATE_STATE</span><span class="p">(</span><span class="n">idle_entry</span><span class="p">,</span><span class="w"> </span><span class="n">idle_run</span><span class="p">,</span><span class="w"> </span><span class="n">idle_exit</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">),</span>
<span class="w">  </span><span class="cm">/* State ACTIVE does not have an entry action */</span>
<span class="w">  </span><span class="p">[</span><span class="n">STATE_ACTIVE</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SMF_CREATE_STATE</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">active_run</span><span class="p">,</span><span class="w"> </span><span class="n">active_exit</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">),</span>
<span class="w">  </span><span class="cm">/* State ERROR does not have an exit action */</span>
<span class="w">  </span><span class="p">[</span><span class="n">STATE_ERROR</span><span class="p">]</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">SMF_CREATE_STATE</span><span class="p">(</span><span class="n">error_entry</span><span class="p">,</span><span class="w"> </span><span class="n">error_run</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">),</span>
<span class="p">};</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="kt">int32_t</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>

<span class="w">  </span><span class="cm">/* Set initial state */</span>
<span class="w">  </span><span class="n">smf_set_initial</span><span class="p">(</span><span class="n">SMF_CTX</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s_obj</span><span class="p">),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">demo_states</span><span class="p">[</span><span class="n">STATE_IDLE</span><span class="p">]);</span>

<span class="w">  </span><span class="cm">/* Run the state machine */</span>
<span class="w">  </span><span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="cm">/* State machine terminates if a non-zero value is returned */</span>
<span class="w">    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">smf_run_state</span><span class="p">(</span><span class="n">SMF_CTX</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s_obj</span><span class="p">));</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="cm">/* handle return code and terminate state machine */</span>
<span class="w">      </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="hierarchical-state-machine-hsm">
<h3>Hierarchical State Machine (HSM)<a class="headerlink" href="#hierarchical-state-machine-hsm" title="Permalink to this heading"></a></h3>
<p>When <code class="docutils literal notranslate"><span class="pre">CONFIG_SYSTEM_SMF_ANCESTOR_SUPPORT</span></code> is enabled, states may define a parent.
The example below turns the following state diagram into code using SMF, where IDLE and ACTIVE share a parent
state and IDLE is the initial state.</p>
<figure class="align-center" id="id2">
<a class="reference internal image-reference" href="../../../_images/Hierarchical-state-machine-diagram.png"><img alt="Hierarchical State Machine Diagram" src="../../../_images/Hierarchical-state-machine-diagram.png" style="width: 40%;" /></a>
<figcaption>
<p><span class="caption-text">Hierarchical state machine example implemented using SMF.</span><a class="headerlink" href="#id2" title="Permalink to this image"></a></p>
</figcaption>
</figure>
<p>Code</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;system/smf.h&gt;</span>

<span class="cm">/* Forward declaration of state table */</span>
<span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">smf_state</span><span class="w"> </span><span class="n">demo_states</span><span class="p">[];</span>

<span class="cm">/* List of demo states */</span>
<span class="k">enum</span><span class="w"> </span><span class="n">demo_state</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">PARENT</span><span class="p">,</span><span class="w"> </span><span class="n">IDLE</span><span class="p">,</span><span class="w"> </span><span class="n">ACTIVE</span><span class="p">,</span><span class="w"> </span><span class="n">ERROR</span><span class="w"> </span><span class="p">};</span>

<span class="cm">/* User defined object */</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">s_object</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="cm">/* This must be first */</span>
<span class="w">  </span><span class="k">struct</span><span class="w"> </span><span class="nc">smf_ctx</span><span class="w"> </span><span class="n">ctx</span><span class="p">;</span>

<span class="w">  </span><span class="cm">/* Other state specific data add here */</span>
<span class="p">}</span><span class="w"> </span><span class="n">s_obj</span><span class="p">;</span>

<span class="cm">/* Parent State */</span>
<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">parent_entry</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">o</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="cm">/* Do something */</span>
<span class="p">}</span>
<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">parent_exit</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">o</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="cm">/* Do something */</span>
<span class="p">}</span>

<span class="cm">/* State IDLE */</span>
<span class="k">static</span><span class="w"> </span><span class="k">enum</span><span class="w"> </span><span class="n">smf_state_result</span><span class="w"> </span><span class="nf">idle_run</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">o</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">smf_set_state</span><span class="p">(</span><span class="n">SMF_CTX</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s_obj</span><span class="p">),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">demo_states</span><span class="p">[</span><span class="n">ACTIVE</span><span class="p">]);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">SMF_EVENT_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* State ACTIVE */</span>
<span class="k">static</span><span class="w"> </span><span class="k">enum</span><span class="w"> </span><span class="n">smf_state_result</span><span class="w"> </span><span class="nf">active_run</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">o</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">smf_set_state</span><span class="p">(</span><span class="n">SMF_CTX</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s_obj</span><span class="p">),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">demo_states</span><span class="p">[</span><span class="n">ERROR</span><span class="p">]);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">SMF_EVENT_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* State ERROR */</span>
<span class="k">static</span><span class="w"> </span><span class="k">enum</span><span class="w"> </span><span class="n">smf_state_result</span><span class="w"> </span><span class="nf">error_run</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">o</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">smf_set_state</span><span class="p">(</span><span class="n">SMF_CTX</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s_obj</span><span class="p">),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">demo_states</span><span class="p">[</span><span class="n">IDLE</span><span class="p">]);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">SMF_EVENT_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Populate state table */</span>
<span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">smf_state</span><span class="w"> </span><span class="n">demo_states</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="cm">/* Parent state does not have a run action */</span>
<span class="w">  </span><span class="p">[</span><span class="n">PARENT</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SMF_CREATE_STATE</span><span class="p">(</span><span class="n">parent_entry</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">parent_exit</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">),</span>
<span class="w">  </span><span class="cm">/* Child states do not have entry or exit actions */</span>
<span class="w">  </span><span class="p">[</span><span class="n">IDLE</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SMF_CREATE_STATE</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">idle_run</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">demo_states</span><span class="p">[</span><span class="n">PARENT</span><span class="p">],</span><span class="w"> </span><span class="nb">NULL</span><span class="p">),</span>
<span class="w">  </span><span class="p">[</span><span class="n">ACTIVE</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SMF_CREATE_STATE</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">active_run</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">demo_states</span><span class="p">[</span><span class="n">PARENT</span><span class="p">],</span><span class="w"> </span><span class="nb">NULL</span><span class="p">),</span>
<span class="w">  </span><span class="cm">/* State ERROR do not have entry or exit actions and no parent */</span>
<span class="w">  </span><span class="p">[</span><span class="n">ERROR</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SMF_CREATE_STATE</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">error_run</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">),</span>
<span class="p">};</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="kt">int32_t</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>

<span class="w">  </span><span class="cm">/* Set initial state */</span>
<span class="w">  </span><span class="n">smf_set_initial</span><span class="p">(</span><span class="n">SMF_CTX</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s_obj</span><span class="p">),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">demo_states</span><span class="p">[</span><span class="n">IDLE</span><span class="p">]);</span>

<span class="w">  </span><span class="cm">/* Run the state machine */</span>
<span class="w">  </span><span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="cm">/* State machine terminates if a non-zero value is returned */</span>
<span class="w">    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">smf_run_state</span><span class="p">(</span><span class="n">SMF_CTX</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s_obj</span><span class="p">));</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="cm">/* handle return code and terminate state machine */</span>
<span class="w">      </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>When designing hierarchical state machines, the following should be considered:</p>
<ul class="simple">
<li><p>Ancestor entry actions are executed before the sibling entry actions. For example,
the parent_entry function is called before the <code class="docutils literal notranslate"><span class="pre">idle_entry</span></code> function.</p></li>
<li><p>Transitioning from one sibling to another with a shared ancestry does not re-execute the ancestor’s entry
action or execute the exit action. For example, the parent_entry function is not called when transitioning
from IDLE to ACTIVE, nor is the parent_exit function called.</p></li>
<li><p>Ancestor exit actions are executed after the exit action of the current state.
For example, the idle_exit function is called before the parent_exit function is called.</p></li>
<li><p>The parent_run function only executes if the child_run function does not call either <code class="docutils literal notranslate"><span class="pre">smf_set_state()</span></code>
or return <code class="docutils literal notranslate"><span class="pre">SMF_EVENT_HANDLED</span></code>.</p></li>
<li><p>Avoid malformed hierarchical state machines by ensuring the state always transitions to a leaf state when
<code class="docutils literal notranslate"><span class="pre">CONFIG_SYSTEM_SMF_INITIAL_TRANSITION</span></code> is not enabled, or when a parent state’s initial state is undefined.</p></li>
</ul>
</section>
</section>
<section id="initial-transitions">
<h2>Initial Transitions<a class="headerlink" href="#initial-transitions" title="Permalink to this heading"></a></h2>
<p>If <code class="docutils literal notranslate"><span class="pre">CONFIG_SYSTEM_SMF_INITIAL_TRANSITION</span></code> is enabled, a parent state may define an
initial child state.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">smf_state</span><span class="w"> </span><span class="n">demo_states</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span>
<span class="p">{</span>
<span class="w">  </span><span class="p">[</span><span class="n">STATE_PARENT</span><span class="p">]</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">SMF_CREATE_STATE</span><span class="p">(</span><span class="n">parent_entry</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">parent_exit</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">demo_states</span><span class="p">[</span><span class="n">STATE_CHILD_A</span><span class="p">]),</span>
<span class="w">  </span><span class="p">[</span><span class="n">STATE_CHILD_A</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SMF_CREATE_STATE</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">child_a_run</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">demo_states</span><span class="p">[</span><span class="n">STATE_PARENT</span><span class="p">],</span><span class="w"> </span><span class="nb">NULL</span><span class="p">),</span>
<span class="p">};</span>
</pre></div>
</div>
<p>When entering <code class="docutils literal notranslate"><span class="pre">STATE_PARENT</span></code>, the framework automatically transitions to
<code class="docutils literal notranslate"><span class="pre">STATE_CHILD_A</span></code>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Without initial transition support enabled, applications must always
transition directly to a leaf state.</p>
</div>
</section>
<section id="state-execution-model">
<h2>State Execution Model<a class="headerlink" href="#state-execution-model" title="Permalink to this heading"></a></h2>
<p>The application controls execution explicitly.</p>
<ol class="arabic simple">
<li><p>Set the initial state using <code class="docutils literal notranslate"><span class="pre">smf_set_initial()</span></code></p></li>
<li><p>Call <code class="docutils literal notranslate"><span class="pre">smf_run_state()</span></code> from an event loop</p></li>
<li><p>Stop execution when a non-zero value is returned</p></li>
</ol>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">smf_set_initial</span><span class="p">(</span><span class="n">SMF_CTX</span><span class="p">(</span><span class="o">&amp;</span><span class="n">app</span><span class="p">),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">demo_states</span><span class="p">[</span><span class="n">STATE_IDLE</span><span class="p">]);</span>

<span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int32_t</span><span class="w"> </span><span class="n">rc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">smf_run_state</span><span class="p">(</span><span class="n">SMF_CTX</span><span class="p">(</span><span class="o">&amp;</span><span class="n">app</span><span class="p">));</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rc</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">    </span><span class="cm">/* Block, poll, or wait for an event */</span>
<span class="w">  </span><span class="p">}</span>
</pre></div>
</div>
<section id="state-run-semantics">
<h3>State Run Semantics<a class="headerlink" href="#state-run-semantics" title="Permalink to this heading"></a></h3>
<p>The run action returns:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">SMF_EVENT_HANDLED</span></code> – event consumed</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">SMF_EVENT_PROPAGATE</span></code> – propagate to parent (HSM only)</p></li>
</ul>
<p>If <code class="docutils literal notranslate"><span class="pre">smf_set_state()</span></code> is called, propagation stops immediately.</p>
</section>
</section>
<section id="state-transitions">
<h2>State Transitions<a class="headerlink" href="#state-transitions" title="Permalink to this heading"></a></h2>
<p>Transitions are requested explicitly by calling <code class="docutils literal notranslate"><span class="pre">smf_set_state()</span></code> from
entry or run actions.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="k">enum</span><span class="w"> </span><span class="n">smf_state_result</span><span class="w"> </span><span class="nf">active_run</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">obj</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="k">struct</span><span class="w"> </span><span class="nc">s_object</span><span class="w"> </span><span class="o">*</span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">s_object</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">obj</span><span class="p">;</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="n">smf_set_state</span><span class="p">(</span><span class="n">SMF_CTX</span><span class="p">(</span><span class="n">s</span><span class="p">),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">demo_states</span><span class="p">[</span><span class="n">STATE_ERROR</span><span class="p">]);</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">SMF_EVENT_HANDLED</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">SMF_EVENT_HANDLED</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Calling <code class="docutils literal notranslate"><span class="pre">smf_set_state()</span></code> from exit actions is rejected by design.</p>
</section>
<section id="termination">
<h2>Termination<a class="headerlink" href="#termination" title="Permalink to this heading"></a></h2>
<p>To terminate a state machine, call <code class="docutils literal notranslate"><span class="pre">smf_set_terminate()</span></code>.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">smf_set_terminate</span><span class="p">(</span><span class="n">SMF_CTX</span><span class="p">(</span><span class="o">&amp;</span><span class="n">app</span><span class="p">),</span><span class="w"> </span><span class="o">-</span><span class="n">ECANCELED</span><span class="p">);</span>
</pre></div>
</div>
<p>The value passed is returned by <code class="docutils literal notranslate"><span class="pre">smf_run_state()</span></code> and can be used to signal
the termination reason.</p>
</section>
<section id="state-introspection">
<h2>State Introspection<a class="headerlink" href="#state-introspection" title="Permalink to this heading"></a></h2>
<p>SMF exposes two helper APIs:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">smf_get_current_leaf_state()</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">smf_get_current_executing_state()</span></code></p></li>
</ul>
<p>These functions are primarily intended for diagnostics, logging, and testing.</p>
</section>
<section id="uml-compliance">
<h2>UML Compliance<a class="headerlink" href="#uml-compliance" title="Permalink to this heading"></a></h2>
<p>SMF follows UML hierarchical state machine semantics:</p>
<ul class="simple">
<li><p>Entry/exit actions execute according to the least common ancestor (LCA)</p></li>
<li><p>Self-transitions execute full exit/entry sequences</p></li>
<li><p>Local transitions are supported implicitly</p></li>
</ul>
<p>Differences from UML:</p>
<ol class="arabic simple">
<li><p>Transition actions execute in the source state context</p></li>
<li><p>Only external self-transitions are supported</p></li>
<li><p>No explicit terminate pseudostate</p></li>
</ol>
</section>
<section id="notes-and-constraints">
<h2>Notes and Constraints<a class="headerlink" href="#notes-and-constraints" title="Permalink to this heading"></a></h2>
<ul class="simple">
<li><p>SMF performs no dynamic allocation</p></li>
<li><p>State tables are typically <code class="docutils literal notranslate"><span class="pre">static</span> <span class="pre">const</span></code></p></li>
<li><p>Thread safety is the responsibility of the application</p></li>
<li><p>One SMF instance represents one execution region</p></li>
<li><p>Orthogonal regions require multiple SMF instances</p></li>
</ul>
</section>
<section id="configuration-options">
<h2>Configuration Options<a class="headerlink" href="#configuration-options" title="Permalink to this heading"></a></h2>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">CONFIG_SYSTEM_SMF</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">CONFIG_SYSTEM_SMF_ANCESTOR_SUPPORT</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">CONFIG_SYSTEM_SMF_INITIAL_TRANSITION</span></code></p></li>
</ul>
</section>
<section id="code-location">
<h2>Code Location<a class="headerlink" href="#code-location" title="Permalink to this heading"></a></h2>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">apps/system/smf</span></code> – Framework implementation</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">apps/include/system/smf.h</span></code> – Public API</p></li>
</ul>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../setlogmask/index.html" class="btn btn-neutral float-left" title="setlogmask “setlogmask” command" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../spi/index.html" class="btn btn-neutral float-right" title="spi SPI Tool" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, The Apache Software Foundation.</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>