<!--
 Documentation/_templates/layout.html

 Licensed to the Apache Software Foundation (ASF) under one or more
 contributor license agreements.  See the NOTICE file distributed with
 this work for additional information regarding copyright ownership.  The
 ASF licenses this file to you under the Apache License, Version 2.0 (the
 "License"); you may not use this file except in compliance with the
 License.  You may obtain a copy of the License at

   http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
 WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 License for the specific language governing permissions and limitations
 under the License.
-->

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Block Device Drivers &mdash; NuttX latest documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/copybutton.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/tabs.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/sphinx_highlight.js"></script>
        <script src="../../../_static/clipboard.min.js"></script>
        <script src="../../../_static/copybutton.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Specialized Device Drivers" href="../special/index.html" />
    <link rel="prev" title="dev_null.c and dev_zero.c" href="../character/nullzero.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
  
    <a href="../../../index.html" class="icon icon-home"> NuttX
  

  
  </a>

  <!-- this version selector is quite ugly, should be probably replaced by something
       more modern -->

  <div class="version-selector">
    <select onchange="javascript:location.href = this.value;">
    
    <option value="../../../../latest" selected="selected">latest</option>
    
    <option value="../../../../10.0.0" >10.0.0</option>
    
    <option value="../../../../10.0.1" >10.0.1</option>
    
    <option value="../../../../10.1.0" >10.1.0</option>
    
    <option value="../../../../10.2.0" >10.2.0</option>
    
    <option value="../../../../10.3.0" >10.3.0</option>
    
    <option value="../../../../11.0.0" >11.0.0</option>
    
    <option value="../../../../12.0.0" >12.0.0</option>
    
    <option value="../../../../12.1.0" >12.1.0</option>
    
    <option value="../../../../12.2.0" >12.2.0</option>
    
    <option value="../../../../12.2.1" >12.2.1</option>
    
    <option value="../../../../12.3.0" >12.3.0</option>
    
    </select>
  </div>

  
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Table of Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../index.html">Home</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../introduction/index.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../quickstart/index.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing/index.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../introduction/inviolables.html">The Inviolable Principles of NuttX</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../platforms/index.html">Supported Platforms</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../index.html">OS Components</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../power.html">Power Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../binfmt.html">Binary Loader</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.html">Device Drivers</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../character/index.html">Character Device Drivers</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Block Device Drivers</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#ramdisk-c"><code class="docutils literal notranslate"><span class="pre">ramdisk.c</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#eeprom">EEPROM</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#eeprom-device-support">EEPROM Device Support</a></li>
<li class="toctree-l5"><a class="reference internal" href="#file-systems">File Systems</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../special/index.html">Specialized Device Drivers</a></li>
<li class="toctree-l3"><a class="reference internal" href="../index.html#lower-half-and-upper-half">Lower-half and upper-half</a></li>
<li class="toctree-l3"><a class="reference internal" href="../index.html#subdirectories-of-nuttx-drivers">Subdirectories of <cite>nuttx/drivers</cite></a></li>
<li class="toctree-l3"><a class="reference internal" href="../index.html#skeleton-files">Skeleton Files</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../nxflat.html">NXFLAT</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../nxgraphics/index.html">NX Graphics Subsystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../nxwidgets.html">NxWidgets</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../paging.html">On-Demand Paging</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../audio/index.html">Audio subsystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../filesystem/index.html">NuttX File System</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../libs/index.html">NuttX libraries</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../net/index.html">Network Support</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../mm/index.html">Memory Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../syscall.html">Syscall Layer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tools/index.html"><code class="docutils literal notranslate"><span class="pre">/tools</span></code> Host Tools</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../arch/index.html">Architecture-Specific Code</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../boards.html">Boards support</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../applications/index.html">Applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../reference/index.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq/index.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/index.html">Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../glossary.html">Glossary</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">NuttX</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">OS Components</a></li>
          <li class="breadcrumb-item"><a href="../index.html">Device Drivers</a></li>
      <li class="breadcrumb-item active">Block Device Drivers</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../_sources/components/drivers/block/index.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="block-device-drivers">
<h1>Block Device Drivers<a class="headerlink" href="#block-device-drivers" title="Permalink to this heading"></a></h1>
<p>Block device drivers have these properties:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">include/nuttx/fs/fs.h</span></code>. All structures and APIs needed
to work with block drivers are provided in this header file.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">block_operations</span></code>. Each block device driver must
implement an instance of <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">block_operations</span></code>. That
structure defines a call table with the following methods:</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">int</span> <span class="pre">register_blockdriver(const</span> <span class="pre">char</span> <span class="pre">*path,</span> <span class="pre">const</span> <span class="pre">struct</span> <span class="pre">block_operations</span> <span class="pre">*bops,</span> <span class="pre">mode_t</span> <span class="pre">mode,</span> <span class="pre">void</span> <span class="pre">*priv);</span></code>.
Each block driver registers itself by calling
<code class="docutils literal notranslate"><span class="pre">register_blockdriver()</span></code>, passing it the <code class="docutils literal notranslate"><span class="pre">path</span></code> where it
will appear in the <a class="reference internal" href="../../../reference/user/10_filesystem.html#file-system-overview"><span class="std std-ref">pseudo file system</span></a> and
it’s initialized instance of <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">block_operations</span></code>.</p></li>
<li><p><strong>User Access</strong>. Users do not normally access block drivers
directly, rather, they access block drivers indirectly through
the <code class="docutils literal notranslate"><span class="pre">mount()</span></code> API. The <code class="docutils literal notranslate"><span class="pre">mount()</span></code> API binds a block driver
instance with a file system and with a mountpoint. Then the
user may use the block driver to access the file system on the
underlying media. <em>Example</em>: See the <code class="docutils literal notranslate"><span class="pre">cmd_mount()</span></code>
implementation in <code class="docutils literal notranslate"><span class="pre">apps/nshlib/nsh_fscmds.c</span></code>.</p></li>
<li><p><strong>Accessing a Character Driver as a Block Device</strong>. See the
loop device at <code class="docutils literal notranslate"><span class="pre">drivers/loop.c</span></code>. <em>Example</em>: See the
<code class="docutils literal notranslate"><span class="pre">cmd_losetup()</span></code> implementation in
<code class="docutils literal notranslate"><span class="pre">apps/nshlib/nsh_fscmds.c</span></code>.</p></li>
<li><p><strong>Accessing a Block Driver as Character Device</strong>. See the
Block-to-Character (BCH) conversion logic in <code class="docutils literal notranslate"><span class="pre">drivers/bch/</span></code>.
<em>Example</em>: See the <code class="docutils literal notranslate"><span class="pre">cmd_dd()</span></code> implementation in
<code class="docutils literal notranslate"><span class="pre">apps/nshlib/nsh_ddcmd.c</span></code>.</p></li>
<li><p><strong>Examples</strong>. <code class="docutils literal notranslate"><span class="pre">drivers/loop.c</span></code>,
<code class="docutils literal notranslate"><span class="pre">drivers/mmcsd/mmcsd_spi.c</span></code>, <code class="docutils literal notranslate"><span class="pre">drivers/ramdisk.c</span></code>, etc.</p></li>
</ul>
<section id="ramdisk-c">
<h2><code class="docutils literal notranslate"><span class="pre">ramdisk.c</span></code><a class="headerlink" href="#ramdisk-c" title="Permalink to this heading"></a></h2>
<p>Can be used to set up a block of memory or (read-only) FLASH as
a block driver that can be mounted as a file system.  See
include/nuttx/drivers/ramdisk.h.</p>
</section>
<section id="eeprom">
<h2>EEPROM<a class="headerlink" href="#eeprom" title="Permalink to this heading"></a></h2>
<dl class="simple">
<dt>EEPROMs are a form of Memory</dt><dd><p>Technology Device (MTD).  EEPROMs are non-volatile memory like FLASH, but
differ in underlying memory technology and differ in usage in many respects:
They may not be organized into blocks (at least from the standpoint of the
user) and it is not necessary to erase the EEPROM memory before re-writing
it.  In addition, EEPROMs tend to be much smaller than FLASH parts, usually
only a few kilobytes vs megabytes for FLASH.  EEPROM tends to be used to
retain a small amount of device configuration information; FLASH tends
to be used for program or massive data storage. For these reasons, it may
not be convenient to use the more complex MTD interface but instead use
the simple character interface provided by the EEPROM drivers.</p>
</dd>
</dl>
<section id="eeprom-device-support">
<h3>EEPROM Device Support<a class="headerlink" href="#eeprom-device-support" title="Permalink to this heading"></a></h3>
<section id="drivers-eeprom-spi-xx25xx-c">
<h4>drivers/eeprom/spi_xx25xx.c<a class="headerlink" href="#drivers-eeprom-spi-xx25xx-c" title="Permalink to this heading"></a></h4>
<p>This is a driver for SPI EEPROMs that use the same commands as the
25AA160:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Manufacturer Device     Bytes PgSize AddrLen
Microchip
             25xx010A     128   16     1
             25xx020A     256   16     1
             25AA02UID    256   16     1
             25AA02E48    256   16     1
             25AA02E64    256   16     1
             25xx040      512   16     1+bit
             25xx040A     512   16     1+bit
             25xx080     1024   16     1
             25xx080A    1024   16     2
             25xx080B    1024   32     2
             25xx080C    1024   16     x
             25xx080D    1024   32     x
             25xx160     2048   16     2
             25xx160A/C  2048   16     2    TESTED
             25xx160B/D  2048   32     2
             25xx160C    2048   16     2
             25xx160D    2048   32     2
             25xx320     4096   32     2
             25xx320A    4096   32     2
             25xx640     8192   32     2
             25xx640A    8192   32     2
             25xx128    16384   64     2
             25xx256    32768   64     2
             25xx512    65536  128     2
             25xx1024  131072  256     3
Atmel
             AT25010B     128    8     1
             AT25020B     256    8     1
             AT25040B     512    8     1+bit
             AT25080B    1024   32     2
             AT25160B    2048   32     2
             AT25320B    4096   32     2
             AT25640B    8192   32     2
             AT25128B   16384   64     2
             AT25256B   32768   64     2
             AT25512    65536  128     2
             AT25M01   131072  256     3
</pre></div>
</div>
</section>
<section id="drivers-mtd-at24xx-c">
<h4>drivers/mtd/at24xx.c<a class="headerlink" href="#drivers-mtd-at24xx-c" title="Permalink to this heading"></a></h4>
<p>This is a driver for I2C-based at24cxx EEPROM (at24c32, at24c64, at24c128,
at24c256, at24c512).  This driver is currently provided as an MTD driver
but could easily be modified to support the character driver interface.</p>
</section>
</section>
<section id="file-systems">
<h3>File Systems<a class="headerlink" href="#file-systems" title="Permalink to this heading"></a></h3>
<p>Most EEPROM parts are too small to be candidates for use with a file
system.  The character driver interface is optimal for these small parts
because you can open and access the EEPROM part as if it were a single,
fixed size file.</p>
<p>It is also possible to use these character drivers with a file system.
The character driver can converted to a block device using the NuttX loop
device.  The loop device can be found the file drivers/loop.c.  Interface
function prototypes can be found in include/nuttx/fs/fs.h:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>int losetup(FAR const char *devname, FAR const char *filename,
            uint16_t sectsize, off_t offset, bool readonly);
</pre></div>
</div>
<p>Given a file or character devices at ‘filename’, losetup will create the
block device ‘devname’ using a bogus sector size of sectsize.  ‘offset’ is
normally zero but can be used to provide an offset into the EEPROM where
the block driver data starts;  The EEPROM block driver can also be read-
only.</p>
<p>There is a corresponding function that will destroy the loop device:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>int loteardown(FAR const char *devname);
</pre></div>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../character/nullzero.html" class="btn btn-neutral float-left" title="dev_null.c and dev_zero.c" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../special/index.html" class="btn btn-neutral float-right" title="Specialized Device Drivers" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020, The Apache Software Foundation.</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>