<!--
 Documentation/_templates/layout.html

 Licensed to the Apache Software Foundation (ASF) under one or more
 contributor license agreements.  See the NOTICE file distributed with
 this work for additional information regarding copyright ownership.  The
 ASF licenses this file to you under the Apache License, Version 2.0 (the
 "License"); you may not use this file except in compliance with the
 License.  You may obtain a copy of the License at

   http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
 WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 License for the specific language governing permissions and limitations
 under the License.
-->



<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sensor “uORB” Drivers &mdash; NuttX latest documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/css/theme.css" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/copybutton.css" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/sphinx_collapse.css" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/custom.css" />

  
    <link rel="shortcut icon" href="../../../../_static/favicon.ico"/>
      <script src="../../../../_static/jquery.js"></script>
      <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
      <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
      <script src="../../../../_static/doctools.js"></script>
      <script src="../../../../_static/sphinx_highlight.js"></script>
      <script src="../../../../_static/clipboard.min.js"></script>
      <script src="../../../../_static/copybutton.js"></script>
      <script src="../../../../_static/design-tabs.js"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
    <link rel="next" title="Sensor Legacy Drivers" href="sensors_legacy.html" />
    <link rel="prev" title="Sensor Drivers" href="../sensors.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
  
    <a href="../../../../index.html" class="icon icon-home"> NuttX
  

  
  </a>

  <!-- this version selector is quite ugly, should be probably replaced by something
       more modern -->

  <div class="version-selector">
    <select onchange="javascript:location.href = this.value;">
    
    <option value="../../../../../latest" selected="selected">latest</option>
    
    <option value="../../../../../10.0.0" >10.0.0</option>
    
    <option value="../../../../../10.0.1" >10.0.1</option>
    
    <option value="../../../../../10.1.0" >10.1.0</option>
    
    <option value="../../../../../10.2.0" >10.2.0</option>
    
    <option value="../../../../../10.3.0" >10.3.0</option>
    
    <option value="../../../../../11.0.0" >11.0.0</option>
    
    <option value="../../../../../12.0.0" >12.0.0</option>
    
    <option value="../../../../../12.1.0" >12.1.0</option>
    
    <option value="../../../../../12.2.0" >12.2.0</option>
    
    <option value="../../../../../12.2.1" >12.2.1</option>
    
    <option value="../../../../../12.3.0" >12.3.0</option>
    
    <option value="../../../../../12.4.0" >12.4.0</option>
    
    <option value="../../../../../12.5.0" >12.5.0</option>
    
    <option value="../../../../../12.5.1" >12.5.1</option>
    
    <option value="../../../../../12.6.0" >12.6.0</option>
    
    <option value="../../../../../12.7.0" >12.7.0</option>
    
    <option value="../../../../../12.8.0" >12.8.0</option>
    
    <option value="../../../../../12.9.0" >12.9.0</option>
    
    <option value="../../../../../12.10.0" >12.10.0</option>
    
    </select>
  </div>

  
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Table of Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../../index.html">Home</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../introduction/index.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../quickstart/index.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../contributing/index.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../introduction/inviolables.html">The Inviolable Principles of NuttX</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../platforms/index.html">Supported Platforms</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../../index.html">OS Components</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../../binfmt.html">Binary Loader</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../../index.html">Device Drivers</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../../character/index.html">Character Device Drivers</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../block/index.html">Block Device Drivers</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="../index.html">Specialized Device Drivers</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="../audio.html">Audio Device Drivers</a></li>
<li class="toctree-l4"><a class="reference internal" href="../clk.html">Clock management (CLK)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../devicetree.html">Device Tree support</a></li>
<li class="toctree-l4"><a class="reference internal" href="../devmem.html">DEVMEM Drivers</a></li>
<li class="toctree-l4"><a class="reference internal" href="../dma.html">DMA Drivers</a></li>
<li class="toctree-l4"><a class="reference internal" href="../framebuffer.html">Frame Buffer Drivers</a></li>
<li class="toctree-l4"><a class="reference internal" href="../i2c.html">I2C Device Drivers</a></li>
<li class="toctree-l4"><a class="reference internal" href="../i2c.html#i2c-slave-device-drivers">I2C Slave Device Drivers</a></li>
<li class="toctree-l4"><a class="reference internal" href="../i3c.html">I3C Device Drivers</a></li>
<li class="toctree-l4"><a class="reference internal" href="../ioexpander.html">IO Expander Device Drivers</a></li>
<li class="toctree-l4"><a class="reference internal" href="../lcd.html">LCD Character Drivers</a></li>
<li class="toctree-l4"><a class="reference internal" href="../mtd.html">Memory Technology Device Drivers</a></li>
<li class="toctree-l4"><a class="reference internal" href="../regmap.html">drivers/regmap</a></li>
<li class="toctree-l4"><a class="reference internal" href="../reset.html">Reset Driver</a></li>
<li class="toctree-l4"><a class="reference internal" href="../rptun.html">Remote Proc Tunnel Drivers</a></li>
<li class="toctree-l4"><a class="reference internal" href="../rwbuffer.html"><code class="docutils literal notranslate"><span class="pre">rwbuffer.c</span></code></a></li>
<li class="toctree-l4 current"><a class="reference internal" href="../sensors.html">Sensor Drivers</a><ul class="current">
<li class="toctree-l5 current"><a class="current reference internal" href="#">Sensor “uORB” Drivers</a></li>
<li class="toctree-l5"><a class="reference internal" href="sensors_legacy.html">Sensor Legacy Drivers</a></li>
<li class="toctree-l5"><a class="reference internal" href="sensors_cluster.html">Sensor Cluster (Obsolete)</a></li>
<li class="toctree-l5"><a class="reference internal" href="adt7320.html">ADT7320</a></li>
<li class="toctree-l5"><a class="reference internal" href="adxl345.html">ADXL345</a></li>
<li class="toctree-l5"><a class="reference internal" href="adxl362.html">ADXL362</a></li>
<li class="toctree-l5"><a class="reference internal" href="adxl372.html">ADXL372</a></li>
<li class="toctree-l5"><a class="reference internal" href="aht10.html">AHT10</a></li>
<li class="toctree-l5"><a class="reference internal" href="ak09912.html">AK09912</a></li>
<li class="toctree-l5"><a class="reference internal" href="lsm330.html">LSM330_SPI</a></li>
<li class="toctree-l5"><a class="reference internal" href="mcp9600.html">MCP9600</a></li>
<li class="toctree-l5"><a class="reference internal" href="mpl115a.html">MPL115A</a></li>
<li class="toctree-l5"><a class="reference internal" href="nau7802.html">NAU7802</a></li>
<li class="toctree-l5"><a class="reference internal" href="sht4x.html">SHT4X</a></li>
<li class="toctree-l5"><a class="reference internal" href="lsm6dso32.html">LSM6DSO32</a></li>
<li class="toctree-l5"><a class="reference internal" href="lis2mdl.html">LIS2MDL</a></li>
<li class="toctree-l5"><a class="reference internal" href="l86xxx.html">L86-XXX</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../segger.html">Segger RTT drivers</a></li>
<li class="toctree-l4"><a class="reference internal" href="../spi.html">SPI Device Drivers</a></li>
<li class="toctree-l4"><a class="reference internal" href="../syslog.html">SYSLOG</a></li>
<li class="toctree-l4"><a class="reference internal" href="../sdio.html">SDIO Device Drivers</a></li>
<li class="toctree-l4"><a class="reference internal" href="../usbdev.html">USB Device-Side Drivers</a></li>
<li class="toctree-l4"><a class="reference internal" href="../usbhost.html">USB Host-Side Drivers</a></li>
<li class="toctree-l4"><a class="reference internal" href="../usbmisc.html">USB Miscellaneous Drivers</a></li>
<li class="toctree-l4"><a class="reference internal" href="../usbmonitor.html">USB Monitor support</a></li>
<li class="toctree-l4"><a class="reference internal" href="../usrsock.html">Usrsock Driver</a></li>
<li class="toctree-l4"><a class="reference internal" href="../mmcsd.html">MMCSD Device Drivers</a></li>
<li class="toctree-l4"><a class="reference internal" href="../net/index.html">Network interface drivers</a></li>
<li class="toctree-l4"><a class="reference internal" href="../pci/index.html">PCI(e) Bus Drivers</a></li>
<li class="toctree-l4"><a class="reference internal" href="../pinctrl.html">Pinctrl Device Drivers</a></li>
<li class="toctree-l4"><a class="reference internal" href="../pipes.html">FIFO and named pipe drivers</a></li>
<li class="toctree-l4"><a class="reference internal" href="../power/index.html">Power-related Drivers</a></li>
<li class="toctree-l4"><a class="reference internal" href="../virtio.html">Virtio Device Drivers</a></li>
<li class="toctree-l4"><a class="reference internal" href="../video.html">Video Device Drivers</a></li>
<li class="toctree-l4"><a class="reference internal" href="../wireless.html">Wireless Drivers</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../thermal/index.html">Thermal Framework</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../index.html#lower-half-and-upper-half">Lower-half and upper-half</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../index.html#subdirectories-of-nuttx-drivers">Subdirectories of <code class="docutils literal notranslate"><span class="pre">nuttx/drivers</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../index.html#skeleton-files">Skeleton Files</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../index.html#drivers-early-initialization">Drivers Early Initialization</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../nxflat.html">NXFLAT</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../nxgraphics/index.html">NX Graphics Subsystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../paging.html">On-Demand Paging</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../audio/index.html">Audio Subsystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../filesystem/index.html">NuttX File System</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../libs/index.html">NuttX libraries</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../net/index.html">Network Support</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../mm/index.html">Memory Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../syscall.html">Syscall Layer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../tools/index.html"><code class="docutils literal notranslate"><span class="pre">/tools</span></code> Host Tools</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../arch/index.html">Architecture-Specific Code</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../boards.html">Boards Support</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../cmake.html">CMake Support</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../openamp.html">OpenAMP Support</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../video.html">Video Subsystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../crypto.html">Crypto API Subsystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../wireless.html">Wireless Subsystem</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../applications/index.html">Applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../implementation/index.html">Implementation Details</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../reference/index.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../faq/index.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../debugging/index.html">Debugging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../guides/index.html">Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../standards/index.html">Standards</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../logos/index.html">NuttX Logos</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../_tags/tagsindex.html">Tags</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">NuttX</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../index.html">OS Components</a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Device Drivers</a></li>
          <li class="breadcrumb-item"><a href="../index.html">Specialized Device Drivers</a></li>
          <li class="breadcrumb-item"><a href="../sensors.html">Sensor Drivers</a></li>
      <li class="breadcrumb-item active">Sensor “uORB” Drivers</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/apache/nuttx/blob/master/Documentation/components/drivers/special/sensors/sensors_uorb.rst" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="sensor-uorb-drivers">
<span id="new-sensor-framework"></span><h1>Sensor “uORB” Drivers<a class="headerlink" href="#sensor-uorb-drivers" title="Permalink to this heading"></a></h1>
<p>NuttX, in order to uniformly manage all sensors, reuse common code, and
reduce space occupation, extracts the common parts of all sensor drivers
into an <strong>upper half layer</strong> that provides general functionalities.
The <strong>lower half layer</strong> is responsible for the actual interaction with sensor
registers.</p>
<p>NuttX sensor drivers focus more on physical sensors. For virtually fused
sensors generated through integration, they are automatically created through
application advertisements or subscriptions. For devices like IMUs, which integrate
multiple sensors into one unit, multiple lower halves need to be instantiated
within the driver, and device nodes are registered separately through the API
(sensor_register) provided by the upper half.</p>
<section id="naming">
<h2>Naming<a class="headerlink" href="#naming" title="Permalink to this heading"></a></h2>
<p>The name used for this component in NuttX may be misleading because this sensor
framework is not dependent on “uORB” in any way. Sensors implemented in this way
can be used as general character drivers with a standardized interface.</p>
</section>
<section id="driver-model">
<h2><strong>Driver Model</strong><a class="headerlink" href="#driver-model" title="Permalink to this heading"></a></h2>
<p>The NuttX Sensor Upperhalf Driver is primarily responsible for registering device
nodes, implementing the struct file_operations, multi-user access, ring buffer
management, low power consumption, and downsampling logic. The Lowerhalf Driver
is divided into rpmsg half and a general lower half. The rpmsg half is responsible
for cross-core subscription and publication with remote CPUs, while the general
lower half is responsible for interacting with sensor hardware. The main actions
performed by the general lower half include a set of sensor operations such as
<code class="docutils literal notranslate"><span class="pre">activate</span></code>, <code class="docutils literal notranslate"><span class="pre">set_interval</span></code>, <code class="docutils literal notranslate"><span class="pre">batch</span></code>, <code class="docutils literal notranslate"><span class="pre">selftest</span></code>, <code class="docutils literal notranslate"><span class="pre">set_calibvalue</span></code>,
<code class="docutils literal notranslate"><span class="pre">calibrate</span></code>, and <code class="docutils literal notranslate"><span class="pre">control</span></code>. Under interrupt or polling mechanisms,
sensor events are sent to the ring buffer in the upper layer.</p>
<a class="reference internal image-reference" href="../../../../_images/sensor_driver_model.png"><img alt="../../../../_images/sensor_driver_model.png" class="align-center" src="../../../../_images/sensor_driver_model.png" style="width: 800px;" /></a>
</section>
<section id="problems-to-solve">
<h2>Problems to solve<a class="headerlink" href="#problems-to-solve" title="Permalink to this heading"></a></h2>
<p>The current implementation uses the <code class="docutils literal notranslate"><span class="pre">float</span></code> type which may make it difficult
to use on platforms without FPU support.</p>
</section>
<section id="code">
<h2><strong>Code</strong><a class="headerlink" href="#code" title="Permalink to this heading"></a></h2>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>nuttx/driver/sensor/sensor.c               sensor upperhalf implementation
nuttx/driver/sensor/sensor_rpmsg.c         sensor rpmsg lowerhalf implementation
nuttx/driver/sensor/usensor.c              userspace sensor register implementation
nuttx/include/nuttx/sensors/sensor.h       sensor unify structure header file
nuttx/include/nuttx/sensors/ioctl.h        sensor ioctl cmd header file

CONFIG_SENSORS                             open sensor driver config
CONFIG_USENSORS                            open user sensor driver config
CONFIG_SENSORS_RPMSG                       open rpmsg sensor driver config
</pre></div>
</div>
</section>
<section id="data-structures">
<h2><strong>Data Structures</strong><a class="headerlink" href="#data-structures" title="Permalink to this heading"></a></h2>
<section id="sensor-types">
<h3><strong>Sensor Types</strong><a class="headerlink" href="#sensor-types" title="Permalink to this heading"></a></h3>
<p>NuttX defines 50+ types of sensors, covering most physical sensors. All type
definitions are located in include/nuttx/uorb.h. If a new type needs to be added,
a comment must be provided for the new type, explaining the purpose and units of
the sensor.</p>
<p><strong>SENSOR_TYPE_CUSTOM</strong></p>
<p>This is a custom type used for irregular sensor devices where the event structure
changes or is dynamically altered. It is registered using <code class="docutils literal notranslate"><span class="pre">sensor_custom_register</span></code>.</p>
<p><strong>SENSOR_TYPE_ACCELEROMETER</strong></p>
<p>Accelerometer, used to measure the acceleration vector of the device. Units: m/s=2.
Event data structure: (This indicates that there is a specific data structure for
accelerometer events, but the actual structure is not provided in the text you gave.)</p>
<p>(won’t introduce them one by one since there are many)</p>
</section>
<section id="sensor-topic-definition">
<h3><strong>Sensor Topic Definition</strong><a class="headerlink" href="#sensor-topic-definition" title="Permalink to this heading"></a></h3>
<p>The data structure for sensors, which is also the topic structure for uORB, is
defined in <code class="docutils literal notranslate"><span class="pre">include/nuttx/uorb.h</span></code>.</p>
</section>
<section id="lower-half-structure">
<h3><strong>Lower Half Structure</strong><a class="headerlink" href="#lower-half-structure" title="Permalink to this heading"></a></h3>
<p>This structure serves as a bridge between the sensor driver’s upper half and
lower half. Both the upper half and lower half populate this structure, with
the lower half responsible for synchronizing configuration information and
the upper half for exposing data reporting interfaces.</p>
<p>The lower part highlighted in red is filled by the lower half driver, while
the rest is filled by the upper half.</p>
<p><code class="docutils literal notranslate"><span class="pre">type</span></code> indicates the sensor type: <code class="docutils literal notranslate"><span class="pre">SENSOR_TYPE_XXX</span></code></p>
<p><code class="docutils literal notranslate"><span class="pre">nbuffer</span></code> specifies the length of the ring buffer in the upper half driver;</p>
<p><code class="docutils literal notranslate"><span class="pre">ops</span></code> represents the set of sensor operations implemented by the lower half driver.</p>
<p><code class="docutils literal notranslate"><span class="pre">push_event</span></code> and <code class="docutils literal notranslate"><span class="pre">notify_event</span></code> are not used simultaneously and are filled
by the upper half.</p>
<p><code class="docutils literal notranslate"><span class="pre">push_event</span></code> works in conjunction with the ring buffer for the lower half to
report data to the ring buffer;</p>
<p><code class="docutils literal notranslate"><span class="pre">notify_event</span></code> is used in conjunction with fetch to notify the upper half that
data is ready when actively
pulling data in a blocking operation.</p>
<p><code class="docutils literal notranslate"><span class="pre">sensor_lock</span></code> and <code class="docutils literal notranslate"><span class="pre">sensor_unlock</span></code> are filled by the upper half and exported
to the lower half to avoid recursive deadlock issues. Currently, they are only
used for sensor_rpmsg.</p>
<p><code class="docutils literal notranslate"><span class="pre">priv</span></code> is filled by the upper half and represents the upper context.</p>
<p><code class="docutils literal notranslate"><span class="pre">persist</span></code> indicates whether the topic is a notification-type topic.</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span><span class="w"> </span><span class="nc">sensor_lowerhalf_s</span>
<span class="p">{</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">type</span><span class="p">;</span>
<span class="w">  </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">nbuffer</span><span class="p">;</span>
<span class="w">  </span><span class="n">FAR</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">sensor_ops_s</span><span class="w"> </span><span class="o">*</span><span class="n">ops</span><span class="p">;</span>

<span class="w">  </span><span class="k">union</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="n">sensor_push_event_t</span><span class="w"> </span><span class="n">push_event</span><span class="p">;</span>
<span class="w">      </span><span class="n">sensor_notify_event_t</span><span class="w"> </span><span class="n">notify_event</span><span class="p">;</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">  </span><span class="n">CODE</span><span class="w"> </span><span class="nf">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">sensor_lock</span><span class="p">)(</span><span class="n">FAR</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">priv</span><span class="p">);</span>
<span class="w">  </span><span class="n">CODE</span><span class="w"> </span><span class="nf">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">sensor_unlock</span><span class="p">)(</span><span class="n">FAR</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">priv</span><span class="p">);</span>

<span class="w">  </span><span class="n">FAR</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">priv</span><span class="p">;</span>
<span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="n">persist</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
</section>
<section id="api">
<h3><strong>API</strong><a class="headerlink" href="#api" title="Permalink to this heading"></a></h3>
<p>The NuttX Sensor UpperHalf Driver provides a set of APIs for the lower half,
including registration and timestamp acquisition.</p>
<section id="registration-and-deregistration">
<h4><strong>Registration and Deregistration</strong><a class="headerlink" href="#registration-and-deregistration" title="Permalink to this heading"></a></h4>
<p>For the 50+ types of sensors, the sensor_register function can be used to register
a character device. The parameter dev represents the handle of the lower half,
and devno is the index of the device name. If the registration is successful,
a node will be created under <code class="docutils literal notranslate"><span class="pre">/dev/{topic}</span></code>, for example: <code class="docutils literal notranslate"><span class="pre">/dev/topic/sensor_accel0</span></code>.
If it fails, an error code will be returned.</p>
<p>For custom special-type drivers, the <code class="docutils literal notranslate"><span class="pre">sensor_custom_register</span></code> function needs
to be used to register a character device. The parameter dev is the handle of
the lower half, path is the path of the character device, and esize is
the element size of the data reported by the sensor. If the registration is
successful, a character device node will be created at the specified path.
If it fails, an error code will be returned.</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">sensor_register</span><span class="p">(</span><span class="n">FAR</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">sensor_lowerhalf_s</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">devno</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">sensor_unregister</span><span class="p">(</span><span class="n">FAR</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">sensor_lowerhalf_s</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">devno</span><span class="p">);</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">sensor_custom_register</span><span class="p">(</span><span class="n">FAR</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">sensor_lowerhalf_s</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">,</span>
<span class="w">                           </span><span class="n">FAR</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">esize</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">sensor_custom_unregister</span><span class="p">(</span><span class="n">FAR</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">sensor_lowerhalf_s</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">,</span>
<span class="w">                              </span><span class="n">FAR</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">path</span><span class="p">);</span>
</pre></div>
</div>
</section>
<section id="acquiring-timestamps">
<h4><strong>Acquiring Timestamps</strong><a class="headerlink" href="#acquiring-timestamps" title="Permalink to this heading"></a></h4>
<p>The function returns a timestamp with microsecond precision.</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="kt">uint64_t</span><span class="w"> </span><span class="nf">sensor_get_timestamp</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
</pre></div>
</div>
</section>
</section>
<section id="sensor-driver-operation-set">
<h3><strong>Sensor Driver Operation Set</strong><a class="headerlink" href="#sensor-driver-operation-set" title="Permalink to this heading"></a></h3>
<p>Sensor driver frameworks for different systems and platforms always revolve
around sensor characteristics, and the NuttX Sensor is no exception. For sensors,
common operations include: opening/closing, initializing range/resolution/filtering,
setting the sampling rate (ODR)/hardware FIFO/operating mode, and interrupt control.
Based on practical applications and references from other systems, several key
points have been selected to form the sensor operation set. For those without
the need for dynamic changes, they can simply be passed as parameters to the
initialization function.</p>
<section id="opening-closing">
<h4><strong>Opening/Closing</strong><a class="headerlink" href="#opening-closing" title="Permalink to this heading"></a></h4>
<p>When the caller invokes open and close, the corresponding open and close
in the lower half will be called, with parameters being lower and filep
respectively. filep contains user information, so the driver can differentiate
between different users. Currently, this interface is only used by the sensor_rpmsg
lower half.</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="n">CODE</span><span class="w"> </span><span class="nf">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">open</span><span class="p">)(</span><span class="n">FAR</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">sensor_lowerhalf_s</span><span class="w"> </span><span class="o">*</span><span class="n">lower</span><span class="p">,</span>
<span class="w">                 </span><span class="n">FAR</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="n">filep</span><span class="p">);</span>

<span class="n">CODE</span><span class="w"> </span><span class="nf">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">close</span><span class="p">)(</span><span class="n">FAR</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">sensor_lowerhalf_s</span><span class="w"> </span><span class="o">*</span><span class="n">lower</span><span class="p">,</span>
<span class="w">                  </span><span class="n">FAR</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="n">filep</span><span class="p">);</span>
</pre></div>
</div>
</section>
<section id="activating-deactivating-the-sensor">
<h4><strong>Activating/Deactivating the Sensor</strong><a class="headerlink" href="#activating-deactivating-the-sensor" title="Permalink to this heading"></a></h4>
<p>When the caller invokes open, if it is a subscriber, it will call activate in
the lower half to activate the sensor. When close is called, deactivate is
invoked to turn off the sensor.</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="n">CODE</span><span class="w"> </span><span class="nf">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">activate</span><span class="p">)(</span><span class="n">FAR</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">sensor_lowerhalf_s</span><span class="w"> </span><span class="o">*</span><span class="n">lower</span><span class="p">,</span>
<span class="w">                     </span><span class="n">FAR</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="n">filep</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">enable</span><span class="p">);</span>
</pre></div>
</div>
</section>
<section id="setting-the-sampling-rate">
<h4><strong>Setting the Sampling Rate</strong><a class="headerlink" href="#setting-the-sampling-rate" title="Permalink to this heading"></a></h4>
<p>Applications (including the Sensor service) set the sampling rate of the sensor
through the system call ioctl.</p>
<p>Call flow:</p>
<blockquote>
<div><ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">ioctl(fd,</span> <span class="pre">SNIOC_SET_INTERVAL,</span> <span class="pre">&amp;interval)</span></code></p></li>
<li><p>vfs</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sensor_ioctl</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">set_interval()</span></code>.</p></li>
</ol>
</div></blockquote>
<p>The sampling interval between consecutive samples of the sensor is set in
microseconds. If period_us exceeds the range of min_delay and max_delay, it
will be adjusted. When modifying the sampling rate, it should be ensured that
the data that has already been prepared is not lost.</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="n">CODE</span><span class="w"> </span><span class="nf">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">batch</span><span class="p">)(</span><span class="n">FAR</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">sensor_lowerhalf_s</span><span class="w"> </span><span class="o">*</span><span class="n">lower</span><span class="p">,</span>
<span class="w">                  </span><span class="n">FAR</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="n">filep</span><span class="p">,</span>
<span class="w">                  </span><span class="n">FAR</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="o">*</span><span class="n">latency_us</span><span class="p">);</span>
</pre></div>
</div>
</section>
<section id="proactively-pulling-data">
<h4><strong>Proactively Pulling Data</strong><a class="headerlink" href="#proactively-pulling-data" title="Permalink to this heading"></a></h4>
<p>To proactively obtain sensor data, set to NULL if using interrupt or polling methods.</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="n">CODE</span><span class="w"> </span><span class="nf">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">fetch</span><span class="p">)(</span><span class="n">FAR</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">sensor_lowerhalf_s</span><span class="w"> </span><span class="o">*</span><span class="n">lower</span><span class="p">,</span>
<span class="w">                  </span><span class="n">FAR</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="n">filep</span><span class="p">,</span>
<span class="w">                  </span><span class="n">FAR</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">buflen</span><span class="p">);</span>
</pre></div>
</div>
</section>
<section id="self-test">
<h4><strong>Self-Test</strong><a class="headerlink" href="#self-test" title="Permalink to this heading"></a></h4>
<p>The sensor self-test is mainly used for factory testing and aging purposes.</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="n">CODE</span><span class="w"> </span><span class="nf">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">selftest</span><span class="p">)(</span><span class="n">FAR</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">sensor_lowerhalf_s</span><span class="w"> </span><span class="o">*</span><span class="n">lower</span><span class="p">,</span>
<span class="w">                     </span><span class="n">FAR</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="n">filep</span><span class="p">,</span>
<span class="w">                     </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">arg</span><span class="p">);</span>
</pre></div>
</div>
</section>
<section id="calibration">
<h4><strong>Calibration</strong><a class="headerlink" href="#calibration" title="Permalink to this heading"></a></h4>
<p>Trigger calibration with calibrate and return calibration data to arg.
Use set_calibvalue to set calibration data to the underlying sensor.</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="n">CODE</span><span class="w"> </span><span class="nf">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">calibrate</span><span class="p">)(</span><span class="n">FAR</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">sensor_lowerhalf_s</span><span class="w"> </span><span class="o">*</span><span class="n">lower</span><span class="p">,</span>
<span class="w">                      </span><span class="n">FAR</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="n">filep</span><span class="p">,</span>
<span class="w">                      </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">arg</span><span class="p">);</span>


<span class="n">CODE</span><span class="w"> </span><span class="nf">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">set_calibvalue</span><span class="p">)(</span><span class="n">FAR</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">sensor_lowerhalf_s</span><span class="w"> </span><span class="o">*</span><span class="n">lower</span><span class="p">,</span>
<span class="w">                           </span><span class="n">FAR</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="n">filep</span><span class="p">,</span>
<span class="w">                           </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">arg</span><span class="p">);</span>
</pre></div>
</div>
</section>
<section id="sensor-information">
<h4><strong>Sensor Information</strong><a class="headerlink" href="#sensor-information" title="Permalink to this heading"></a></h4>
<p>Use get_info to proactively obtain sensor information data, with the return value
being <code class="docutils literal notranslate"><span class="pre">sensor_device_info_s</span></code>.</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span><span class="w"> </span><span class="nc">sensor_device_info_s</span>
<span class="p">{</span>
<span class="w">  </span><span class="kt">uint32_t</span><span class="w">      </span><span class="n">version</span><span class="p">;</span>
<span class="w">  </span><span class="kt">float</span><span class="w">         </span><span class="n">power</span><span class="p">;</span>
<span class="w">  </span><span class="kt">float</span><span class="w">         </span><span class="n">max_range</span><span class="p">;</span>
<span class="w">  </span><span class="kt">float</span><span class="w">         </span><span class="n">resolution</span><span class="p">;</span>
<span class="w">  </span><span class="kt">int32_t</span><span class="w">       </span><span class="n">min_delay</span><span class="p">;</span>
<span class="w">  </span><span class="kt">int32_t</span><span class="w">       </span><span class="n">max_delay</span><span class="p">;</span>
<span class="w">  </span><span class="kt">uint32_t</span><span class="w">      </span><span class="n">fifo_reserved_event_count</span><span class="p">;</span>
<span class="w">  </span><span class="kt">uint32_t</span><span class="w">      </span><span class="n">fifo_max_event_count</span><span class="p">;</span>
<span class="w">  </span><span class="kt">char</span><span class="w">          </span><span class="n">name</span><span class="p">[</span><span class="n">SENSOR_INFO_NAME_SIZE</span><span class="p">];</span>
<span class="w">  </span><span class="kt">char</span><span class="w">          </span><span class="n">vendor</span><span class="p">[</span><span class="n">SENSOR_INFO_NAME_SIZE</span><span class="p">];</span>
<span class="p">};</span>

<span class="n">CODE</span><span class="w"> </span><span class="nf">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">get_info</span><span class="p">)(</span><span class="n">FAR</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">sensor_lowerhalf_s</span><span class="w"> </span><span class="o">*</span><span class="n">lower</span><span class="p">,</span>
<span class="w">                     </span><span class="n">FAR</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="n">filep</span><span class="p">,</span>
<span class="w">                     </span><span class="n">FAR</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">sensor_device_info_s</span><span class="w"> </span><span class="o">*</span><span class="n">info</span><span class="p">);</span>
</pre></div>
</div>
</section>
<section id="custom-control">
<h4><strong>Custom Control</strong><a class="headerlink" href="#custom-control" title="Permalink to this heading"></a></h4>
<p>In addition to the above controls, if certain sensor control requirements are
still not met, the control command with custom controls can be used.</p>
<p>Call flow:</p>
<blockquote>
<div><ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">ioctl(fd,</span> <span class="pre">custom</span> <span class="pre">macro</span> <span class="pre">cmd,</span> <span class="pre">custom</span> <span class="pre">parameters)</span></code></p></li>
<li><p>vfs</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sensor_ioctl</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">control()</span></code>.</p></li>
</ol>
</div></blockquote>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="n">CODE</span><span class="w"> </span><span class="nf">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">control</span><span class="p">)(</span><span class="n">FAR</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="n">filep</span><span class="p">,</span>
<span class="w">                    </span><span class="n">FAR</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">sensor_lowerhalf_s</span><span class="w"> </span><span class="o">*</span><span class="n">lower</span><span class="p">,</span>
<span class="w">                    </span><span class="kt">int</span><span class="w"> </span><span class="n">cmd</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">arg</span><span class="p">);</span>
</pre></div>
</div>
</section>
</section>
<section id="downsampling">
<h3><strong>Downsampling</strong><a class="headerlink" href="#downsampling" title="Permalink to this heading"></a></h3>
<p>The downsampling capability of Vela Sensor is provided by the sensor upper half
at the driver layer, supporting both aligned and unaligned downsampling mechanisms.
When the publisher pushes the main line index each time, the subscriber retrieves
data from its own index. If the difference between the two indexes exceeds the
length of the internal queue, data will be lost. Otherwise, the next theoretical
data point is calculated based on the subscription frequency, the publication
frequency factor, and the current index.</p>
</section>
<section id="multi-core-mechanism">
<h3><strong>Multi-Core Mechanism</strong><a class="headerlink" href="#multi-core-mechanism" title="Permalink to this heading"></a></h3>
<p>The cross-core capability of Vela Sensor is provided by the sensor rpmsg lower
half at the driver layer, which is primarily responsible for sending or receiving
subscription and broadcast messages from other cores.</p>
</section>
<section id="publishing-topics">
<h3><strong>Publishing Topics</strong><a class="headerlink" href="#publishing-topics" title="Permalink to this heading"></a></h3>
<p>When a local application publishes a topic for the first time, it broadcasts
the message to all cores. If there are subscriptions on other cores, they bind
with each other. A stub is created locally to represent the subscription on a
remote core, and a proxy is created on the remote core to represent the local
publisher. All subsequent communication between them is determined by the
context of the stub and proxy.</p>
</section>
<section id="subscribing-to-topics">
<h3><strong>Subscribing to Topics</strong><a class="headerlink" href="#subscribing-to-topics" title="Permalink to this heading"></a></h3>
<p>When a local application subscribes to a topic for the first time, if the message
is broadcast to all cores and there are publishers on other cores, they bind with
each other and communicate through stubs and proxies.</p>
</section>
<section id="remote-control">
<h3><strong>Remote Control</strong><a class="headerlink" href="#remote-control" title="Permalink to this heading"></a></h3>
<p>When a local subscriber modifies the sampling rate and the publisher of that
topic is remote, the local proxy will publish this sampling rate to the remote
stub. Upon receiving this control information, the stub sets it for the actual
physical hardware. The same applies to other controls.</p>
</section>
<section id="remote-message-publishing">
<h3><strong>Remote Message Publishing</strong><a class="headerlink" href="#remote-message-publishing" title="Permalink to this heading"></a></h3>
<p>When local data is published, the sensor rpmsg lower half collects all messages
within a sampling interval that does not exceed half of the fastest topic’s
interval and sends them to other cores together, reducing IPC occurrences and
saving power consumption.</p>
</section>
<section id="subscription-and-publication-order">
<h3><strong>Subscription and Publication Order</strong><a class="headerlink" href="#subscription-and-publication-order" title="Permalink to this heading"></a></h3>
<p>There is no order restriction for advertising and subscribing to topics.
For notification-type topics, even if the advertisement is canceled immediately
after data publication, other cores can still successfully obtain the latest data.
For general-purpose topics, subscribing after publication will only allow reading
of data published after the subscription.</p>
</section>
</section>
<section id="programming-modes">
<h2><strong>Programming Modes</strong><a class="headerlink" href="#programming-modes" title="Permalink to this heading"></a></h2>
<p>NuttX Sensor drivers support three data retrieval methods: proactive,
interrupt-driven, and polling. The proactive method allows filling sensor events
using a buffer passed in by the app, reducing memory copy operations.
The interrupt-driven and polling methods open an internal circular buffer, where
each event is automatically pushed upon generation. The size of the buffer is set
by sensor_lowerhalf_s::buffer_size. For sensors with high sampling rates, it is
recommended to set the buffer size for 2-3 events, while for sensors with low
sampling rates, setting it for 1 event is sufficient.</p>
<section id="proactive-retrieval">
<h3><strong>Proactive Retrieval</strong><a class="headerlink" href="#proactive-retrieval" title="Permalink to this heading"></a></h3>
<p>This method is recommended for sensors with low sampling rates and small data
volumes. The <code class="docutils literal notranslate"><span class="pre">sensor_ops_s::fetch</span></code> function must be implemented.</p>
<p>The call flow is:</p>
<blockquote>
<div><ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">read(fd,</span> <span class="pre">buf,</span> <span class="pre">len)</span></code></p></li>
<li><p>vfs</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sensor_read</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">fetch()</span></code></p></li>
</ol>
</div></blockquote>
<p>It is not advisable to use the fetch method to retrieve sensor data. When the
caller invokes read, accessing the bus to obtain data has two disadvantages:
the bus speed is low, which may block the upper layer; and the retrieved data
may be old and not representative of the current state.</p>
<p>When using the fetch function, the upper layer will automatically disable
the circular buffer and can directly use the user-space buffer to store register
data, reducing memory copy operations. When the character device node is opened
in non-blocking mode, the fetch operation will directly read the registers via
the I2C/SPI bus, and the poll operation will always succeed. When opened in
blocking mode, if there is no ready data when read is called, the poll function
can be used to monitor it. If a POLLIN event occurs, the read function should
be called immediately to retrieve the data.</p>
</section>
<section id="interrupt-driven-retrieval">
<h3><strong>Interrupt-Driven Retrieval</strong><a class="headerlink" href="#interrupt-driven-retrieval" title="Permalink to this heading"></a></h3>
<p>For sensors with hardware interrupts, sensor data can be read via the bus in
the interrupt’s bottom half, and the event can be pushed to the upper layer’s
circular buffer using <code class="docutils literal notranslate"><span class="pre">sensor_lowerhalf_s::push_event</span></code>. When using the internal
circular buffer, data generated in each interrupt’s bottom half is pushed to
the upper layer’s circular buffer. Upper-layer applications read data directly
from the buffer. When the buffer has no data, it will depend on the blocking
flag in f_oflags to determine whether to wait. Common sensors operate in
interrupt mode. When an interrupt occurs, a worker is scheduled to start
the bottom half, which then retrieves sensor data via buses such as
I2C or SPI and calls the push_event interface to push the data to the upper
half’s buffer. It is recommended to configure an interrupt pin for sensors
with a sampling rate higher than 25Hz.</p>
</section>
<section id="polling-retrieval">
<h3><strong>Polling Retrieval</strong><a class="headerlink" href="#polling-retrieval" title="Permalink to this heading"></a></h3>
<p>For sensors without hardware interrupts, data generated by the sensor can be
collected through periodic polling, with the polling period typically varying
based on the sampling rate.</p>
</section>
</section>
<section id="implemented-drivers">
<h2>Implemented Drivers<a class="headerlink" href="#implemented-drivers" title="Permalink to this heading"></a></h2>
<ul class="simple">
<li><p><a class="reference internal" href="adxl362.html"><span class="doc">ADXL362</span></a></p></li>
<li><p><a class="reference internal" href="adxl372.html"><span class="doc">ADXL372</span></a></p></li>
<li><p>bh1749nuc</p></li>
<li><p>bme680</p></li>
<li><p>bmi088</p></li>
<li><p>bmi160</p></li>
<li><p>bmi270</p></li>
<li><p>bmm150</p></li>
<li><p>bmp180</p></li>
<li><p>bmp280</p></li>
<li><p>ds18b20</p></li>
<li><p>fakesensor</p></li>
<li><p>fs3000</p></li>
<li><p>gnss</p></li>
<li><p>goldfish_gnss</p></li>
<li><p>goldfish_sensor</p></li>
<li><p>hyt271</p></li>
<li><p>l3gd20</p></li>
<li><p><a class="reference internal" href="lis2mdl.html"><span class="doc">LIS2MDL</span></a></p></li>
<li><p>lsm9ds1</p></li>
<li><p>ltr308</p></li>
<li><p>mpu9250</p></li>
<li><p>ms56xx</p></li>
<li><p><a class="reference internal" href="nau7802.html"><span class="doc">NAU7802</span></a></p></li>
<li><p><a class="reference internal" href="sht4x.html"><span class="doc">SHT4X</span></a></p></li>
<li><p><a class="reference internal" href="lsm6dso32.html"><span class="doc">LSM6DSO32</span></a></p></li>
<li><p>wtgahrs2</p></li>
</ul>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../sensors.html" class="btn btn-neutral float-left" title="Sensor Drivers" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="sensors_legacy.html" class="btn btn-neutral float-right" title="Sensor Legacy Drivers" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, The Apache Software Foundation.</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>