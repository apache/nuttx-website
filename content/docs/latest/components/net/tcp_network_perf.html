<!--
 Documentation/_templates/layout.html

 Licensed to the Apache Software Foundation (ASF) under one or more
 contributor license agreements.  See the NOTICE file distributed with
 this work for additional information regarding copyright ownership.  The
 ASF licenses this file to you under the Apache License, Version 2.0 (the
 "License"); you may not use this file except in compliance with the
 License.  You may obtain a copy of the License at

   http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
 WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 License for the specific language governing permissions and limitations
 under the License.
-->



<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TCP Network Performance &mdash; NuttX latest documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css" />
      <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
      <link rel="stylesheet" type="text/css" href="../../_static/sphinx_collapse.css" />
      <link rel="stylesheet" type="text/css" href="../../_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css" />
      <link rel="stylesheet" type="text/css" href="../../_static/custom.css" />

  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
      <script src="../../_static/jquery.js"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
      <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
      <script src="../../_static/doctools.js"></script>
      <script src="../../_static/sphinx_highlight.js"></script>
      <script src="../../_static/clipboard.min.js"></script>
      <script src="../../_static/copybutton.js"></script>
      <script src="../../_static/design-tabs.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Delayed ACK and TCP Performance" href="delay_act_and_tcp_perf.html" />
    <link rel="prev" title="Work Queue Deadlocks" href="wqueuedeadlocks.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
  
    <a href="../../index.html" class="icon icon-home"> NuttX
  

  
  </a>

  <!-- this version selector is quite ugly, should be probably replaced by something
       more modern -->

  <div class="version-selector">
    <select onchange="javascript:location.href = this.value;">
    
    <option value="../../../latest" selected="selected">latest</option>
    
    <option value="../../../10.0.0" >10.0.0</option>
    
    <option value="../../../10.0.1" >10.0.1</option>
    
    <option value="../../../10.1.0" >10.1.0</option>
    
    <option value="../../../10.2.0" >10.2.0</option>
    
    <option value="../../../10.3.0" >10.3.0</option>
    
    <option value="../../../11.0.0" >11.0.0</option>
    
    <option value="../../../12.0.0" >12.0.0</option>
    
    <option value="../../../12.1.0" >12.1.0</option>
    
    <option value="../../../12.2.0" >12.2.0</option>
    
    <option value="../../../12.2.1" >12.2.1</option>
    
    <option value="../../../12.3.0" >12.3.0</option>
    
    <option value="../../../12.4.0" >12.4.0</option>
    
    <option value="../../../12.5.0" >12.5.0</option>
    
    <option value="../../../12.5.1" >12.5.1</option>
    
    <option value="../../../12.6.0" >12.6.0</option>
    
    <option value="../../../12.7.0" >12.7.0</option>
    
    <option value="../../../12.8.0" >12.8.0</option>
    
    <option value="../../../12.9.0" >12.9.0</option>
    
    <option value="../../../12.10.0" >12.10.0</option>
    
    <option value="../../../12.11.0" >12.11.0</option>
    
    </select>
  </div>

  
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Table of Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../index.html">Home</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../introduction/index.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quickstart/index.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing/index.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../introduction/inviolables.html">The Inviolable Principles of NuttX</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../platforms/index.html">Supported Platforms</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">OS Components</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../binfmt.html">Binary Loader</a></li>
<li class="toctree-l2"><a class="reference internal" href="../concurrency/index.html">Concurrency</a></li>
<li class="toctree-l2"><a class="reference internal" href="../drivers/index.html">Device Drivers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../nxflat.html">NXFLAT</a></li>
<li class="toctree-l2"><a class="reference internal" href="../nxgraphics/index.html">NX Graphics Subsystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../paging.html">On-Demand Paging</a></li>
<li class="toctree-l2"><a class="reference internal" href="../audio/index.html">Audio Subsystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../filesystem/index.html">NuttX File System</a></li>
<li class="toctree-l2"><a class="reference internal" href="../libs/index.html">NuttX libraries</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">Network Support</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="sixlowpan.html">6LoWPAN</a></li>
<li class="toctree-l3"><a class="reference internal" href="socketcan.html">SocketCAN</a></li>
<li class="toctree-l3"><a class="reference internal" href="pkt.html">“Raw” packet socket support</a></li>
<li class="toctree-l3"><a class="reference internal" href="ipfilter.html">IP Packet Filter</a></li>
<li class="toctree-l3"><a class="reference internal" href="nat.html">Network Address Translation (NAT)</a></li>
<li class="toctree-l3"><a class="reference internal" href="netdev.html">Network Devices</a></li>
<li class="toctree-l3"><a class="reference internal" href="netdriver.html">Network Drivers</a></li>
<li class="toctree-l3"><a class="reference internal" href="mdio.html">MDIO Bus Driver</a></li>
<li class="toctree-l3"><a class="reference internal" href="netguardsize.html">CONFIG_NET_GUARDSIZE</a></li>
<li class="toctree-l3"><a class="reference internal" href="netlink.html">Netlink Route support</a></li>
<li class="toctree-l3"><a class="reference internal" href="slip.html">SLIP</a></li>
<li class="toctree-l3"><a class="reference internal" href="wqueuedeadlocks.html">Work Queue Deadlocks</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">TCP Network Performance</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#question">Question</a></li>
<li class="toctree-l4"><a class="reference internal" href="#answer">Answer</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#source-of-performance-bottlenecks">Source of Performance Bottlenecks</a></li>
<li class="toctree-l5"><a class="reference internal" href="#rfc-1122">RFC 1122</a></li>
<li class="toctree-l5"><a class="reference internal" href="#tcpblaster">TCPBlaster</a></li>
<li class="toctree-l5"><a class="reference internal" href="#what-about-receive-performance">What about Receive Performance?</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="delay_act_and_tcp_perf.html">Delayed ACK and TCP Performance</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../mm/index.html">Memory Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="../syscall.html">Syscall Layer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tools/index.html"><code class="docutils literal notranslate"><span class="pre">/tools</span></code> Host Tools</a></li>
<li class="toctree-l2"><a class="reference internal" href="../arch/index.html">Architecture-Specific Code</a></li>
<li class="toctree-l2"><a class="reference internal" href="../boards.html">Boards Support</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cmake.html">CMake Support</a></li>
<li class="toctree-l2"><a class="reference internal" href="../openamp.html">OpenAMP Support</a></li>
<li class="toctree-l2"><a class="reference internal" href="../video.html">Video Subsystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../crypto.html">Crypto API Subsystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../wireless.html">Wireless Subsystem</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../applications/index.html">Applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../implementation/index.html">Implementation Details</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reference/index.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../faq/index.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../debugging/index.html">Debugging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guides/index.html">Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../standards/index.html">Standards</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../logos/index.html">NuttX Logos</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../_tags/tagsindex.html">Tags</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">NuttX</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">OS Components</a></li>
          <li class="breadcrumb-item"><a href="index.html">Network Support</a></li>
      <li class="breadcrumb-item active">TCP Network Performance</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/apache/nuttx/blob/master/Documentation/components/net/tcp_network_perf.rst" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="tcp-network-performance">
<h1>TCP Network Performance<a class="headerlink" href="#tcp-network-performance" title="Permalink to this heading"></a></h1>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Migrated from:
<a class="reference external" href="https://cwiki.apache.org/confluence/display/NUTTX/TCP+Network+Performance">https://cwiki.apache.org/confluence/display/NUTTX/TCP+Network+Performance</a></p>
</div>
<p>(Abstracted and extended from a discussion from the NuttX Google group)</p>
<section id="question">
<h2>Question<a class="headerlink" href="#question" title="Permalink to this heading"></a></h2>
<p>For some unknown reason, I am seeing poor TCP network performance.</p>
</section>
<section id="answer">
<h2>Answer<a class="headerlink" href="#answer" title="Permalink to this heading"></a></h2>
<p>First let’s talk about TCP send performance.</p>
<section id="source-of-performance-bottlenecks">
<h3>Source of Performance Bottlenecks<a class="headerlink" href="#source-of-performance-bottlenecks" title="Permalink to this heading"></a></h3>
<p>General TCP send performance is not determined by the TCP stack as much
as it is by the network device driver. Bad network performance is due
to time lost <cite>BETWEEN</cite> packet transfers. The packet transfers themselves
go at the wire speed*. So if you want to improve performance on a
given network, you have to reduce time lost between transfers.
There is no other way.</p>
<p>Ignoring Ethernet issues like collisions, back-off delays,
inter-packet gaps (IPG), etc.</p>
<p>The time between packets is limited primarily by the buffering
design of the network driver. If you want to improve performance,
then you must improve the buffering at the network driver.
You need to support many full size (1500 byte) packet buffers.
You must be able to query the network for new data to transfer,
and queue those transfers in packet buffers. In order to reach
peak performance, the network driver must have the next transfer
buffered and ready-to-go before the previous transfer is finished
to minimize the GAP between packet transfers.</p>
<p>Different network devices also support more or less efficient
interfaces: The worst performing support interfaces that can
handle only one packet at a time, the best performing are able
to retain linked lists of packet buffers in memory and perform
scatter-gather DMA for a sequence of packets.</p>
<p>In the NuttX TCP stack, you can also improve performance by
enabling TCP write buffering. But the driver is the real key.</p>
<p>It would be good to have a real in-depth analysis of the
network stack performance to identify bottlenecks and
generate ideas for performance improvement. No one has
ever done that. If I were aware of any stack related
performance issue, I would certainly address it.</p>
</section>
<section id="rfc-1122">
<h3>RFC 1122<a class="headerlink" href="#rfc-1122" title="Permalink to this heading"></a></h3>
<p>There is one important feature missing the NuttX TCP that
can help when there is no write buffering: Without write
buffering send() will not return until the transfer has
been ACKed by the recipient. But under RFC 1122, the host
need not ACK each packet immediately; the host may wait
for 500 MS before ACKing. This combination can cause very
slow performance when small, non-buffered transfers are
made to an RFC 1122 client. However, the RFC 1122 must
ACK at least every second (odd) packet so sequences of
packets with write buffering enabled do not suffer from
this problem.</p>
<p><cite>Update:  RFC 1122 support was added to the NuttX TCP
stack with commit 66ef6d143a627738ad7f3ce1c065f9b1f3f303b0
in December of 2019.  That, however, that affects only
received packet ACK behavior and has no impact on transmitted
packet performance; write buffering is still recommended.</cite></p>
</section>
<section id="tcpblaster">
<h3>TCPBlaster<a class="headerlink" href="#tcpblaster" title="Permalink to this heading"></a></h3>
<p>I created a new test application at <code class="docutils literal notranslate"><span class="pre">apps/examples/tcpblaster</span></code> to
measure TCP performance and collected some data for the
configuration that happens to be on my desk. The <cite>tcpblaster</cite>
test gives you the read and write transfer rates in <code class="docutils literal notranslate"><span class="pre">Kb/sec</span></code>
(I won’t mention the numbers because I don’t believe they
would translate any other setup and, hence, would be
misleading).</p>
<p>There is a nifty <a class="reference external" href="https://www.switch.ch/network/tools/tcp_throughput/">TCP Throughput Tool</a>
that gives some theoretical upper limits on performance.
The tool needs to know the <code class="docutils literal notranslate"><span class="pre">MSS</span></code> (which is the Ethernet
packet size that you configured minus the size of the
Ethernet header, 14), the round-trip time (<code class="docutils literal notranslate"><span class="pre">RTT</span></code>)in
milliseconds (which you can
get from the Linux host ping), and a loss constant (which
I left at the default). With these values, I can determine
that the throughput for the NuttX TCP stack is approximately
at the theoretical limits. You should not be able to do
better any better than that (actually, it performs above
the theoretical limit, but I suppose that is why it is
“theoretical”).</p>
<p>So, If you are unhappy with your network performance, the I
suggest you run the <cite>tcpblaster</cite> test, use that data
(along with the <code class="docutils literal notranslate"><span class="pre">RTT</span></code> from ping) with the
<a class="reference external" href="https://www.switch.ch/network/tools/tcp_throughput/">TCP Throughput Tool</a>.
If you are still unhappy with the performance, don’t go
immediately pointing fingers at the stack (which everyone does).
Instead, you should focus on optimizing your network
configuration settings and reviewing the buffer handling
of the Ethernet driver in you MCU.</p>
<p>If you do discover any significant performance issues
with the stack I will of course gladly help you resolve
them. Or if you have ideas for improved performance,
I would also be happy to hear those.</p>
</section>
<section id="what-about-receive-performance">
<h3>What about Receive Performance?<a class="headerlink" href="#what-about-receive-performance" title="Permalink to this heading"></a></h3>
<p>All of the above discussion concerns <cite>transmit performance</cite>,
i.e., “How fast can we send data over the network?” The other
side is receive performance. Receive performance is very
different thing. In this case it is the remote peer who is
in complete control of the rate at which packets appear on
the network and, hence, responsible for all of the raw bit
transfer rates.</p>
<p>However, we might also redefine performance as the number of
bytes that were <cite>successfully</cite> transferred. In order for the
bytes to be successfully transferred they must be successfully
received and processed on the NuttX target. If we fail in
this if the packet is <cite>lost</cite> or <cite>dropped</cite>. A packet is lost if
the network driver is not prepared to receive the packet when
it was sent. A packet is dropped by the network if it is
received but could not be processed either because there
is some logical issue with the packet (not the case here)
or if we have no space to buffer the newly received packet.</p>
<p>If a TCP packet is lost or dropped, then the penalty is big:
The packet will not be ACKed, the remote peer may send a
few more out-of-sequence packets which will also be dropped.
Eventually, the remote peer will time out and retransmit
the data from the point of the lost packet.</p>
<p>There is logic in the TCP protocol to help manage these data
overruns. The TCP header includes a TCP <cite>receive window</cite> which
tells the remote peer how much data the receiver is able to
buffer. This value is sent in the ACK to each received
packet. If well tuned, this receive window could possibly
prevent packets from being lost due to the lack of
read-ahead storage. This is a little better. The remote
peer will hold off sending data instead of timing out and
re-transmitting. But this is still a loss of performance;
the gap between the transfer of packets caused by the hold-off
will result in a reduced transfer rate.</p>
<p>So the issues for good reception are buffering and processing
time. Buffering again applies to handling within the driver
but unlike the transmit performance, this is not typically
the bottleneck. And there is also a NuttX configuration
option that controls <cite>read-ahead</cite> buffering of TCP packets.
The buffering in the driver must be optimized to avoid lost
packets; the ` buffering can be tuned to minimize
the number packets dropped because we have no space to buffer them.</p>
<p>But the key to receive perform is management of processing
delays. Small processing delays can occur in the network
driver or in the TCP stack. But the major source of
processing delay is the application which is the ultimate
consumer of the incoming data. Imagine, for example,
and FTP application that is receiving a file over a
TCP and writing the file into FLASH memory. The primary
bottleneck here will be the write to FLASH memory which
is out of the control of software.</p>
<p>We obtain optimal receive performance when the processing
delays keep up with the rate of the incoming packets.
If the processing data rate is even slightly slower
then the receive data rate, then there will be a
growing <cite>backlog</cite> of buffered, incoming data to be
processed. If this backlog continues to grow then
eventually our ability to buffer data will be exhausted,
packets will be held off or dropped, and performance
will deteriorate. In an environment where a high-end,
remote peer is interacting with the low-end, embedded
system, that remote peer can easily overrun the
embedded system due to the embedded system’s limited
buffering space, its much lower processing capability,
and its slower storage peripherals.</p>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="wqueuedeadlocks.html" class="btn btn-neutral float-left" title="Work Queue Deadlocks" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="delay_act_and_tcp_perf.html" class="btn btn-neutral float-right" title="Delayed ACK and TCP Performance" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, The Apache Software Foundation.</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>