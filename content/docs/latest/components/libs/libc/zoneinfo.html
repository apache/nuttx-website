<!--
 Documentation/_templates/layout.html

 Licensed to the Apache Software Foundation (ASF) under one or more
 contributor license agreements.  See the NOTICE file distributed with
 this work for additional information regarding copyright ownership.  The
 ASF licenses this file to you under the Apache License, Version 2.0 (the
 "License"); you may not use this file except in compliance with the
 License.  You may obtain a copy of the License at

   http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
 WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 License for the specific language governing permissions and limitations
 under the License.
-->

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>libs/libc/zoneinfo &mdash; NuttX latest documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/copybutton.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/tabs.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/sphinx_highlight.js"></script>
        <script src="../../../_static/clipboard.min.js"></script>
        <script src="../../../_static/copybutton.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="libdsp" href="../libdsp.html" />
    <link rel="prev" title="libc" href="index.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
  
    <a href="../../../index.html" class="icon icon-home"> NuttX
  

  
  </a>

  <!-- this version selector is quite ugly, should be probably replaced by something
       more modern -->

  <div class="version-selector">
    <select onchange="javascript:location.href = this.value;">
    
    <option value="../../../../latest" selected="selected">latest</option>
    
    <option value="../../../../10.0.0" >10.0.0</option>
    
    <option value="../../../../10.0.1" >10.0.1</option>
    
    <option value="../../../../10.1.0" >10.1.0</option>
    
    <option value="../../../../10.2.0" >10.2.0</option>
    
    <option value="../../../../10.3.0" >10.3.0</option>
    
    <option value="../../../../11.0.0" >11.0.0</option>
    
    <option value="../../../../12.0.0" >12.0.0</option>
    
    <option value="../../../../12.1.0" >12.1.0</option>
    
    <option value="../../../../12.2.0" >12.2.0</option>
    
    <option value="../../../../12.2.1" >12.2.1</option>
    
    <option value="../../../../12.3.0" >12.3.0</option>
    
    </select>
  </div>

  
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Table of Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../index.html">Home</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../introduction/index.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../quickstart/index.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing/index.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../introduction/inviolables.html">The Inviolable Principles of NuttX</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../platforms/index.html">Supported Platforms</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../index.html">OS Components</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../binfmt.html">Binary Loader</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../drivers/index.html">Device Drivers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../nxflat.html">NXFLAT</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../nxgraphics/index.html">NX Graphics Subsystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../paging.html">On-Demand Paging</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../audio/index.html">Audio Subsystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../filesystem/index.html">NuttX File System</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.html">NuttX libraries</a><ul class="current">
<li class="toctree-l3 current"><a class="reference internal" href="index.html">libc</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="index.html#sub-directories">Sub-Directories</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#library-database">Library Database</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#symtab">symtab</a></li>
<li class="toctree-l4 current"><a class="reference internal" href="index.html#implementation-details">Implementation Details</a><ul class="current">
<li class="toctree-l5 current"><a class="current reference internal" href="#">libs/libc/zoneinfo</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../libdsp.html">libdsp</a></li>
<li class="toctree-l3"><a class="reference internal" href="../libm.html">libm</a></li>
<li class="toctree-l3"><a class="reference internal" href="../libxx.html">libxx</a></li>
<li class="toctree-l3"><a class="reference internal" href="../libnx/index.html">libnx</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../net/index.html">Network Support</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../mm/index.html">Memory Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../syscall.html">Syscall Layer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tools/index.html"><code class="docutils literal notranslate"><span class="pre">/tools</span></code> Host Tools</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../arch/index.html">Architecture-Specific Code</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../boards.html">Boards Support</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cmake.html">CMake Support</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../openamp.html">OpenAMP Support</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../video.html">Video Subsystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../crypto.html">Crypto API Subsystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../wireless.html">Wireless Subsystem</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../applications/index.html">Applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../reference/index.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq/index.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/index.html">Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../glossary.html">Glossary</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">NuttX</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">OS Components</a></li>
          <li class="breadcrumb-item"><a href="../index.html">NuttX libraries</a></li>
          <li class="breadcrumb-item"><a href="index.html">libc</a></li>
      <li class="breadcrumb-item active">libs/libc/zoneinfo</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../_sources/components/libs/libc/zoneinfo.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="libs-libc-zoneinfo">
<h1>libs/libc/zoneinfo<a class="headerlink" href="#libs-libc-zoneinfo" title="Permalink to this heading"></a></h1>
<p>Author: Gregory Nutt &lt;<a class="reference external" href="mailto:gnutt&#37;&#52;&#48;nuttx&#46;org">gnutt<span>&#64;</span>nuttx<span>&#46;</span>org</a>&gt;</p>
<section id="directory-contents">
<h2>Directory Contents<a class="headerlink" href="#directory-contents" title="Permalink to this heading"></a></h2>
<p>This directory contains logic to create a version of the TZ/Olson database.
This database is required if localtime() support is selected via
CONFIG_LIBC_LOCALTIME.  This logic in this directory does the following:</p>
<ul class="simple">
<li><p>It downloads the current TZ database from the IANA website</p></li>
<li><p>It downloads the current timezone tools from the same location</p></li>
<li><p>It builds the tools and constructs the binary TZ database</p></li>
<li><p>It will then, optionally, build a ROMFS filesystem image containing
the data base.</p></li>
</ul>
</section>
<section id="creating-and-mounting-a-romfs-tz-database">
<h2>Creating and Mounting a ROMFS TZ Database<a class="headerlink" href="#creating-and-mounting-a-romfs-tz-database" title="Permalink to this heading"></a></h2>
<p>The ROMFS filesystem image can that be mounted during the boot-up sequence
so that it is available for the localtime() logic.  There are two steps to
doing this:</p>
<ul>
<li><p>First, a ROM disk device must be created.  This is done by calling
the function romdisk_register() as described in
nuttx/include/nuttx/drivers/ramdisk.h.  This is an OS level operation
and must be done in the board-level logic before your application
starts.</p>
<p>romdisk_register() will create a block driver at /dev/ramN where N
is the device minor number that was provided to romdisk_register.</p>
</li>
<li><p>The second step is to mount the file system.  This step can be
performed either in your board configuration logic or by your
application using the mount() interface described in
nuttx/include/sys/mount.h.</p>
<p>These steps, however, must be done very early in initialization,
before there is any need for time-related services.</p>
</li>
</ul>
<p>Both of these steps are shown together in the following code sample at the
end of this page.</p>
</section>
<section id="example-configuration">
<h2>Example Configuration<a class="headerlink" href="#example-configuration" title="Permalink to this heading"></a></h2>
<p>I have tested this using the sim/nsh configuration.  Here are the
modifications to the configuration that I used for testing:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>CONFIG_BOARD_LATE_INITIALIZE=y

CONFIG_LIBC_LOCALTIME=y
CONFIG_LIBC_TZDIR=&quot;/share/zoneinfo&quot;
CONFIG_LIBC_TZ_MAX_TIMES=370
CONFIG_LIBC_TZ_MAX_TYPES=20

CONFIG_LIBC_ZONEINFO=y
CONFIG_LIBC_ZONEINFO_ROMFS=y
</pre></div>
</div>
<p>NOTE:  The full TZ database is quite large.  To create a reasonable sized
ROMFS image, I had to trim some of the files like this:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>cd nuttx
tools/configure.sh sim:nsh
make menuconfig
</pre></div>
</div>
<p>Select the above localtime() and nuttx/zoneinfo configuration settings.
Then:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>make context
cd ../nuttx/libs/libc/zoneinfo/tzbin/usr/share/zoneinfo
</pre></div>
</div>
<p>Remove as many timezone files as you can.  Do not remove the GMT, localtime,
or posixrules files.  Those might be needed in any event.  Then you can
force rebuilding of the ROMFS filesystem be removing some files:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>cd ../../..
rm romfs_zoneinfo.*
rm *.o
cd ../../nuttx
make
</pre></div>
</div>
<p>If you have problems building the simulator on your platform, check out
<a class="reference internal" href="../../../platforms/sim/sim/boards/sim/index.html"><span class="doc">SIM</span></a>.
You might find some help there.</p>
<p>Here is a sample run.  I have not seen any errors in single stepping through
the logic but neither am I certain that everything is working properly:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>NuttShell (NSH)
nsh&gt; date
Jul 01 00:00:02 2008
nsh&gt; set TZ US/Mountain
nsh&gt; date -s &quot;Apr 11 11:53:00 2015&quot;
nsh&gt; date
Apr 11 17:53:00 2015
</pre></div>
</div>
<p>NOTE: Because of daylight savings time, US/Mountain is GMT-6 on Apr 11.  The
above suggests that perhaps the NSH data command may be setting local time,
but printing GMT time?</p>
</section>
<section id="sample-code-to-mount-the-romfs-filesystem">
<h2>Sample Code to Mount the ROMFS Filesystem<a class="headerlink" href="#sample-code-to-mount-the-romfs-filesystem" title="Permalink to this heading"></a></h2>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="cm">/****************************************************************************</span>
<span class="cm"> * Included Files</span>
<span class="cm"> ****************************************************************************/</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;nuttx/config.h&gt;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;sys/mount.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdlib.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;errno.h&gt;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;nuttx/drivers/ramdisk.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;nuttx/zoneinfo.h&gt;</span>

<span class="cm">/****************************************************************************</span>
<span class="cm"> * Pre-processor Definitions</span>
<span class="cm"> ****************************************************************************/</span>

<span class="cp">#ifndef CONFIG_LIBC_TZDIR</span>
<span class="cp">#  error CONFIG_LIBC_TZDIR is not defined</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_DISABLE_MOUNTPOINT</span>
<span class="cp">#  error &quot;Mountpoint support is disabled&quot;</span>
<span class="cp">#endif</span>

<span class="cp">#ifndef CONFIG_FS_ROMFS</span>
<span class="cp">#  error &quot;ROMFS support not enabled&quot;</span>
<span class="cp">#endif</span>

<span class="cp">#define SECTORSIZE  64</span>
<span class="cp">#define NSECTORS(b) (((b)+SECTORSIZE-1)/SECTORSIZE)</span>

<span class="cm">/****************************************************************************</span>
<span class="cm"> * Public Functions</span>
<span class="cm"> ****************************************************************************/</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">mount_zoneinfo</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">minor</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">   </span><span class="kt">char</span><span class="w"> </span><span class="n">devname</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
<span class="w">   </span><span class="kt">int</span><span class="w">  </span><span class="n">ret</span><span class="p">;</span>

<span class="w">  </span><span class="cm">/* Create a RAM disk for the test */</span>

<span class="w">  </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">romdisk_register</span><span class="p">(</span><span class="n">minor</span><span class="p">,</span><span class="w"> </span><span class="n">romfs_zoneinfo_img</span><span class="p">,</span>
<span class="w">                         </span><span class="n">NSECTORS</span><span class="p">(</span><span class="n">romfs_zoneinfo_img_len</span><span class="p">),</span><span class="w"> </span><span class="n">SECTORSIZE</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;ERROR: Failed to create RAM disk</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">  </span><span class="cm">/* Use the minor number to create a name for the ROM disk block device */</span>

<span class="w">  </span><span class="n">snprintf</span><span class="p">(</span><span class="n">devname</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/dev/ram%d&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">minor</span><span class="p">);</span>

<span class="w">  </span><span class="cm">/* Mount the ROMFS file system */</span>

<span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Mounting ROMFS filesystem at target=%s with source=%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
<span class="w">         </span><span class="n">CONFIG_LIBC_TZDIR</span><span class="p">,</span><span class="w"> </span><span class="n">devname</span><span class="p">);</span>

<span class="w">  </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mount</span><span class="p">(</span><span class="n">devname</span><span class="p">,</span><span class="w"> </span><span class="n">CONFIG_LIBC_TZDIR</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;romfs&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">MS_RDONLY</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;ERROR: Mount failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">errno</span><span class="p">);</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;TZ database mounted at %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">CONFIG_LIBC_TZDIR</span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">OK</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="index.html" class="btn btn-neutral float-left" title="libc" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../libdsp.html" class="btn btn-neutral float-right" title="libdsp" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, The Apache Software Foundation.</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>