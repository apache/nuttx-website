<!--
 Documentation/_templates/layout.html

 Licensed to the Apache Software Foundation (ASF) under one or more
 contributor license agreements.  See the NOTICE file distributed with
 this work for additional information regarding copyright ownership.  The
 ASF licenses this file to you under the Apache License, Version 2.0 (the
 "License"); you may not use this file except in compliance with the
 License.  You may obtain a copy of the License at

   http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
 WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 License for the specific language governing permissions and limitations
 under the License.
-->

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Network Address Translation (NAT) &mdash; NuttX latest documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/tabs.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
  
    <a href="../../index.html" class="icon icon-home"> NuttX
  

  
    
    <img src="../../_static/NuttX.png" class="logo" alt="Logo"/>
  
  </a>

  <!-- this version selector is quite ugly, should be probably replaced by something
       more modern -->

  <div class="version-selector">
    <select onchange="javascript:location.href = this.value;">
    
    <option value="../../../latest" selected="selected">latest</option>
    
    <option value="../../../10.0.0" >10.0.0</option>
    
    <option value="../../../10.0.1" >10.0.1</option>
    
    <option value="../../../10.1.0" >10.1.0</option>
    
    <option value="../../../10.2.0" >10.2.0</option>
    
    <option value="../../../10.3.0" >10.3.0</option>
    
    <option value="../../../11.0.0" >11.0.0</option>
    
    <option value="../../../12.0.0" >12.0.0</option>
    
    </select>
  </div>

  
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Table of Contents</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../index.html">Home</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../introduction/index.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quickstart/index.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing/index.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../introduction/inviolables.html">The Inviolable Principles of NuttX</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../platforms/index.html">Supported Platforms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../components/index.html">OS Components</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../applications/index.html">Applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../index.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../faq/index.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guides/index.html">Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../glossary.html">Glossary</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">NuttX</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Network Address Translation (NAT)</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/reference/os/nat.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="network-address-translation-nat">
<h1>Network Address Translation (NAT)<a class="headerlink" href="#network-address-translation-nat" title="Permalink to this headline"></a></h1>
<p>NuttX supports full cone NAT logic, which currently supports</p>
<ul class="simple">
<li><p>TCP</p></li>
<li><p>UDP</p></li>
<li><p>ICMP</p>
<ul>
<li><p>ECHO (REQUEST &amp; REPLY)</p></li>
<li><p>Error Messages (DEST_UNREACHABLE &amp; TIME_EXCEEDED &amp; PARAMETER_PROBLEM)</p></li>
</ul>
</li>
</ul>
<section id="workflow">
<h2>Workflow<a class="headerlink" href="#workflow" title="Permalink to this headline"></a></h2>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Local Network (LAN)                          External Network (WAN)
                  |----------------|
     &lt;local IP,   |                | &lt;external IP,             &lt;peer IP,
       -----------|                |-----------------------------
      local port&gt; |                |  external port&gt;            peer port&gt;
                  |----------------|
</pre></div>
</div>
<ul class="simple">
<li><p>Outbound</p>
<ul>
<li><p><strong>LAN</strong> -&gt; <strong>Forward</strong> -&gt; <strong>NAT</strong> (only if targeting at WAN) -&gt; <strong>WAN</strong></p></li>
<li><p>All packets from <strong>LAN</strong> and targeting at <strong>WAN</strong> will be masqueraded
with <code class="docutils literal notranslate"><span class="pre">local</span> <span class="pre">ip:port</span></code> changed to <code class="docutils literal notranslate"><span class="pre">external</span> <span class="pre">ip:port</span></code>.</p></li>
</ul>
</li>
<li><p>Inbound</p>
<ul>
<li><p><strong>WAN</strong> -&gt; <strong>NAT</strong> (only from WAN, change destination) -&gt; <strong>Forward</strong> -&gt; <strong>LAN</strong></p></li>
<li><p>Packets from <strong>WAN</strong> will try to be changed back from
<code class="docutils literal notranslate"><span class="pre">external</span> <span class="pre">ip:port</span></code> to <code class="docutils literal notranslate"><span class="pre">local</span> <span class="pre">ip:port</span></code> and send to <strong>LAN</strong>.</p></li>
</ul>
</li>
</ul>
</section>
<section id="configuration-options">
<h2>Configuration Options<a class="headerlink" href="#configuration-options" title="Permalink to this headline"></a></h2>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">CONFIG_NET_NAT</span></code></dt><dd><p>Enable or disable Network Address Translation (NAT) function.
Depends on <code class="docutils literal notranslate"><span class="pre">CONFIG_NET_IPFORWARD</span></code>.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">CONFIG_NET_NAT_HASH_BITS</span></code></dt><dd><p>The bits of the hashtable of NAT entries, hashtable has (1 &lt;&lt; bits) buckets.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">CONFIG_NET_NAT_TCP_EXPIRE_SEC</span></code></dt><dd><p>The expiration time for idle TCP entry in NAT.
The default value 86400 is suggested by RFC2663, Section 2.6,
Page 5. But we may set it to shorter time like 240s for better
performance.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">CONFIG_NET_NAT_UDP_EXPIRE_SEC</span></code></dt><dd><p>The expiration time for idle UDP entry in NAT.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">CONFIG_NET_NAT_ICMP_EXPIRE_SEC</span></code></dt><dd><p>The expiration time for idle ICMP entry in NAT.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">CONFIG_NET_NAT_ENTRY_RECLAIM_SEC</span></code></dt><dd><p>The time to auto reclaim all expired NAT entries. A value of zero will
disable auto reclaiming.
Expired entries will be automatically reclaimed when matching
inbound/outbound entries, so this config does not have significant
impact when NAT is normally used, but very useful when the hashtable
is big and there are only a few connections using NAT (which will
only trigger reclaiming on a few chains in hashtable).</p>
</dd>
</dl>
</section>
<section id="usage">
<h2>Usage<a class="headerlink" href="#usage" title="Permalink to this headline"></a></h2>
<blockquote>
<div><ul class="simple">
<li><p><a class="reference internal" href="#c.ipv4_nat_enable" title="ipv4_nat_enable"><code class="xref c c-func docutils literal notranslate"><span class="pre">ipv4_nat_enable()</span></code></a></p></li>
<li><p><a class="reference internal" href="#c.ipv4_nat_disable" title="ipv4_nat_disable"><code class="xref c c-func docutils literal notranslate"><span class="pre">ipv4_nat_disable()</span></code></a></p></li>
</ul>
</div></blockquote>
<dl class="c function">
<dt class="sig sig-object c" id="c.ipv4_nat_enable">
<span class="kt"><span class="pre">int</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">ipv4_nat_enable</span></span></span><span class="sig-paren">(</span><span class="pre">FAR</span><span class="w"> </span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><span class="n"><span class="pre">net_driver_s</span></span><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">dev</span></span><span class="sig-paren">)</span><span class="p"><span class="pre">;</span></span><a class="headerlink" href="#c.ipv4_nat_enable" title="Permalink to this definition"></a><br /></dt>
<dd><p>Enable NAT function on a network device, on which the outbound packets
will be masqueraded.</p>
<dl class="field-list simple">
<dt class="field-odd">Returns</dt>
<dd class="field-odd"><p>Zero is returned if NAT function is successfully enabled on
the device; A negated errno value is returned if failed.</p>
</dd>
</dl>
</dd></dl>

<dl class="c function">
<dt class="sig sig-object c" id="c.ipv4_nat_disable">
<span class="kt"><span class="pre">int</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">ipv4_nat_disable</span></span></span><span class="sig-paren">(</span><span class="pre">FAR</span><span class="w"> </span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><span class="n"><span class="pre">net_driver_s</span></span><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">dev</span></span><span class="sig-paren">)</span><span class="p"><span class="pre">;</span></span><a class="headerlink" href="#c.ipv4_nat_disable" title="Permalink to this definition"></a><br /></dt>
<dd><p>Disable NAT function on a network device.</p>
<dl class="field-list simple">
<dt class="field-odd">Returns</dt>
<dd class="field-odd"><p>Zero is returned if NAT function is successfully disabled on
the device; A negated errno value is returned if failed.</p>
</dd>
</dl>
</dd></dl>

</section>
<section id="validation">
<h2>Validation<a class="headerlink" href="#validation" title="Permalink to this headline"></a></h2>
<p>Validated on Ubuntu 22.04 x86_64 with NuttX SIM by following steps:</p>
<ol class="arabic simple">
<li><p>Configure NuttX with &gt;=2 TAP devices (host route mode) and NAT enabled:</p></li>
</ol>
<blockquote>
<div><div class="highlight-Kconfig notranslate"><div class="highlight"><pre><span></span>CONFIG_NET_IPFORWARD=y<span class="w"></span>
CONFIG_NET_NAT=y<span class="w"></span>
<span class="c1"># CONFIG_SIM_NET_BRIDGE is not set</span>
CONFIG_SIM_NETDEV_NUMBER=2<span class="w"></span>
</pre></div>
</div>
</div></blockquote>
<ol class="arabic simple" start="2">
<li><p>Call <code class="docutils literal notranslate"><span class="pre">ipv4_nat_enable</span></code> on one dev on startup</p></li>
</ol>
<blockquote>
<div><div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/* arch/sim/src/sim/up_netdriver.c */</span><span class="w"></span>
<span class="kt">int</span><span class="w"> </span><span class="nf">netdriver_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="p">...</span><span class="w"></span>
<span class="w">  </span><span class="n">ipv4_nat_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">g_sim_dev</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span><span class="w"></span>
<span class="w">  </span><span class="p">...</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div></blockquote>
<ol class="arabic simple" start="3">
<li><p>Set IP Address for NuttX on startup</p></li>
</ol>
<blockquote>
<div><div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>ifconfig eth0 <span class="m">10</span>.0.1.2
ifup eth0
ifconfig eth1 <span class="m">10</span>.0.10.2
ifup eth1
</pre></div>
</div>
</div></blockquote>
<ol class="arabic simple" start="4">
<li><p>Configure IP &amp; namespace &amp; route on host side (maybe need to be root, then try <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">-i</span></code>)</p></li>
</ol>
<blockquote>
<div><div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">IF_HOST</span><span class="o">=</span><span class="s2">&quot;enp1s0&quot;</span>
<span class="nv">IF_0</span><span class="o">=</span><span class="s2">&quot;tap0&quot;</span>
<span class="nv">IP_HOST_0</span><span class="o">=</span><span class="s2">&quot;10.0.1.1&quot;</span>
<span class="nv">IF_1</span><span class="o">=</span><span class="s2">&quot;tap1&quot;</span>
<span class="nv">IP_HOST_1</span><span class="o">=</span><span class="s2">&quot;10.0.10.1&quot;</span>
<span class="nv">IP_NUTTX_1</span><span class="o">=</span><span class="s2">&quot;10.0.10.2&quot;</span>

<span class="c1"># add net namespace LAN for $IF_1</span>
ip netns add LAN
ip netns <span class="nb">exec</span> LAN sysctl -w net.ipv4.ip_forward<span class="o">=</span><span class="m">1</span>
ip link <span class="nb">set</span> <span class="nv">$IF_1</span> netns LAN
ip netns <span class="nb">exec</span> LAN ip link <span class="nb">set</span> <span class="nv">$IF_1</span> up
ip netns <span class="nb">exec</span> LAN ip link <span class="nb">set</span> lo up

<span class="c1"># add address and set default route</span>
ip addr add <span class="nv">$IP_HOST_0</span>/24 dev <span class="nv">$IF_0</span>
ip netns <span class="nb">exec</span> LAN ip addr add <span class="nv">$IP_HOST_1</span>/24 dev <span class="nv">$IF_1</span>
ip netns <span class="nb">exec</span> LAN ip route add default dev <span class="nv">$IF_1</span> via <span class="nv">$IP_NUTTX_1</span>

<span class="c1"># nat to allow NuttX to access the internet</span>
iptables -t nat -A POSTROUTING -o <span class="nv">$IF_HOST</span> -j MASQUERADE
iptables -A FORWARD -i <span class="nv">$IF_HOST</span> -o <span class="nv">$IF_0</span> -j ACCEPT
iptables -A FORWARD -i <span class="nv">$IF_0</span> -o <span class="nv">$IF_HOST</span> -j ACCEPT
sysctl -w net.ipv4.ip_forward<span class="o">=</span><span class="m">1</span>
</pre></div>
</div>
</div></blockquote>
<ol class="arabic simple" start="5">
<li><p>Do anything in the LAN namespace will go through NAT</p></li>
</ol>
<blockquote>
<div><div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="c1"># Host side</span>
iperf -B <span class="m">10</span>.0.1.1 -s -i <span class="m">1</span>
<span class="c1"># LAN side</span>
sudo ip netns <span class="nb">exec</span> LAN iperf -B <span class="m">10</span>.0.10.1 -c <span class="m">10</span>.0.1.1 -i <span class="m">1</span>
</pre></div>
</div>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="c1"># Host side</span>
python3 -m http.server
<span class="c1"># LAN side</span>
<span class="k">for</span> i <span class="k">in</span> <span class="o">{</span><span class="m">1</span>..20000<span class="o">}</span><span class="p">;</span> <span class="k">do</span> sudo ip netns <span class="nb">exec</span> LAN curl <span class="s1">&#39;http://10.0.1.1:8000/&#39;</span> &gt; /dev/null <span class="m">2</span>&gt;1<span class="p">;</span> <span class="k">done</span>
</pre></div>
</div>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="c1"># LAN side</span>
sudo ip netns <span class="nb">exec</span> LAN ping <span class="m">8</span>.8.8.8
</pre></div>
</div>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="c1"># LAN side</span>
sudo ip netns <span class="nb">exec</span> LAN traceroute -n <span class="m">8</span>.8.8.8     <span class="c1"># ICMP error msg of UDP</span>
sudo ip netns <span class="nb">exec</span> LAN traceroute -n -T <span class="m">8</span>.8.8.8  <span class="c1"># ICMP error msg of TCP</span>
</pre></div>
</div>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="c1"># Host side</span>
tcpdump -nn -i tap0
<span class="c1"># LAN side</span>
sudo ip netns <span class="nb">exec</span> LAN tcpdump -nn -i tap1
</pre></div>
</div>
</div></blockquote>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020, The Apache Software Foundation.</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>