<!--
 Documentation/_templates/layout.html

 Licensed to the Apache Software Foundation (ASF) under one or more
 contributor license agreements.  See the NOTICE file distributed with
 this work for additional information regarding copyright ownership.  The
 ASF licenses this file to you under the Apache License, Version 2.0 (the
 "License"); you may not use this file except in compliance with the
 License.  You may obtain a copy of the License at

   http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
 WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 License for the specific language governing permissions and limitations
 under the License.
-->



<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ELF Programs – With Symbol Tables &mdash; NuttX latest documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css" />
      <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
      <link rel="stylesheet" type="text/css" href="../_static/custom.css" />

  
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
      <script src="../_static/jquery.js"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
      <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
      <script src="../_static/doctools.js"></script>
      <script src="../_static/sphinx_highlight.js"></script>
      <script src="../_static/clipboard.min.js"></script>
      <script src="../_static/copybutton.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="ELF Programs – No Symbol Tables" href="fully_linked_elf.html" />
    <link rel="prev" title="Updating a Release System with ELF Programs" href="updating_release_system_elf.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
  
    <a href="../index.html" class="icon icon-home"> NuttX
  

  
  </a>

  <!-- this version selector is quite ugly, should be probably replaced by something
       more modern -->

  <div class="version-selector">
    <select onchange="javascript:location.href = this.value;">
    
    <option value="../../latest" selected="selected">latest</option>
    
    <option value="../../10.0.0" >10.0.0</option>
    
    <option value="../../10.0.1" >10.0.1</option>
    
    <option value="../../10.1.0" >10.1.0</option>
    
    <option value="../../10.2.0" >10.2.0</option>
    
    <option value="../../10.3.0" >10.3.0</option>
    
    <option value="../../11.0.0" >11.0.0</option>
    
    <option value="../../12.0.0" >12.0.0</option>
    
    <option value="../../12.1.0" >12.1.0</option>
    
    <option value="../../12.2.0" >12.2.0</option>
    
    <option value="../../12.2.1" >12.2.1</option>
    
    <option value="../../12.3.0" >12.3.0</option>
    
    <option value="../../12.4.0" >12.4.0</option>
    
    <option value="../../12.5.0" >12.5.0</option>
    
    <option value="../../12.5.1" >12.5.1</option>
    
    <option value="../../12.6.0" >12.6.0</option>
    
    <option value="../../12.7.0" >12.7.0</option>
    
    </select>
  </div>

  
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Table of Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../index.html">Home</a></li>
<li class="toctree-l1"><a class="reference internal" href="../introduction/index.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quickstart/index.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contributing/index.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../introduction/inviolables.html">The Inviolable Principles of NuttX</a></li>
<li class="toctree-l1"><a class="reference internal" href="../platforms/index.html">Supported Platforms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../components/index.html">OS Components</a></li>
<li class="toctree-l1"><a class="reference internal" href="../applications/index.html">Applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../implementation/index.html">Implementation Details</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/index.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq/index.html">FAQ</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Guides</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="nfs.html">NFS Client How-To</a></li>
<li class="toctree-l2"><a class="reference internal" href="usbtrace.html">USB Device Trace</a></li>
<li class="toctree-l2"><a class="reference internal" href="simulator.html">Simulator</a></li>
<li class="toctree-l2"><a class="reference internal" href="qemugdb.html">How to debug NuttX using QEMU and GDB</a></li>
<li class="toctree-l2"><a class="reference internal" href="rndis.html">How to use RNDIS</a></li>
<li class="toctree-l2"><a class="reference internal" href="drivers.html">Drivers</a></li>
<li class="toctree-l2"><a class="reference internal" href="tasktrace.html">Task Trace</a></li>
<li class="toctree-l2"><a class="reference internal" href="cpp_cmake.html">C++ Example using CMake</a></li>
<li class="toctree-l2"><a class="reference internal" href="pysimcoder.html">pysimCoder integration with NuttX</a></li>
<li class="toctree-l2"><a class="reference internal" href="customboards.html">Custom Boards How-To</a></li>
<li class="toctree-l2"><a class="reference internal" href="customapps.html">Custom Apps How-to</a></li>
<li class="toctree-l2"><a class="reference internal" href="citests.html">Running CI Test Locally</a></li>
<li class="toctree-l2"><a class="reference internal" href="zerolatencyinterrupts.html">High Performance: Zero Latency Interrupts, Maskable Nested Interrupts</a></li>
<li class="toctree-l2"><a class="reference internal" href="kasan.html">The Kernel Address Sanitizer (KASAN)</a></li>
<li class="toctree-l2"><a class="reference internal" href="nestedinterrupts.html">Nested Interrupts</a></li>
<li class="toctree-l2"><a class="reference internal" href="cortexmhardfaults.html">Analyzing Cortex-M Hardfaults</a></li>
<li class="toctree-l2"><a class="reference internal" href="coredump.html">Core Dump</a></li>
<li class="toctree-l2"><a class="reference internal" href="coresight.html">Coresight - HW Assisted Tracing on ARM</a></li>
<li class="toctree-l2"><a class="reference internal" href="gdbserver.html">gdbserver</a></li>
<li class="toctree-l2"><a class="reference internal" href="gdbwithpython.html">GDB with Python</a></li>
<li class="toctree-l2"><a class="reference internal" href="ofloader.html">Open Flash Loader</a></li>
<li class="toctree-l2"><a class="reference internal" href="testingtcpip.html">Testing TCP/IP Network Stacks</a></li>
<li class="toctree-l2"><a class="reference internal" href="automounter.html">Auto-Mounter</a></li>
<li class="toctree-l2"><a class="reference internal" href="stm32nullpointer.html">STM32 Null Pointer Detection</a></li>
<li class="toctree-l2"><a class="reference internal" href="stm32ccm.html">STM32 CCM Allocator</a></li>
<li class="toctree-l2"><a class="reference internal" href="stackrecord.html">Run time stack statistics</a></li>
<li class="toctree-l2"><a class="reference internal" href="etcromfs.html">etc romfs</a></li>
<li class="toctree-l2"><a class="reference internal" href="thread_local_storage.html">Thread Local Storage</a></li>
<li class="toctree-l2"><a class="reference internal" href="devicetree.html">Device Tree</a></li>
<li class="toctree-l2"><a class="reference internal" href="debuggingflash_nuttxonarm.html">Debugging / flashing NuttX on ARM with hardware debugger (JTAG/SWD)</a></li>
<li class="toctree-l2"><a class="reference internal" href="changing_systemclockconfig.html">Changing the System Clock Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="usingkernelthreads.html">Using Kernel Threads</a></li>
<li class="toctree-l2"><a class="reference internal" href="armv7m_runtimestackcheck.html">ARMv7-M Run Time Stack Checking</a></li>
<li class="toctree-l2"><a class="reference internal" href="disabling_stackdumpdebug.html">Disabling the Stack Dump During Debugging</a></li>
<li class="toctree-l2"><a class="reference internal" href="include_files_board_h.html">Including Files in board.h</a></li>
<li class="toctree-l2"><a class="reference internal" href="specialstuff_in_nuttxheaderfiles.html">Why can’t I put my special stuff in NuttX header files?</a></li>
<li class="toctree-l2"><a class="reference internal" href="kernel_threads_with_custom_stacks.html">Kernel Threads with Custom Stacks</a></li>
<li class="toctree-l2"><a class="reference internal" href="versioning_and_task_names.html">Versioning and Task Names</a></li>
<li class="toctree-l2"><a class="reference internal" href="logging_rambuffer.html">Logging to a RAM Buffer</a></li>
<li class="toctree-l2"><a class="reference internal" href="mte.html">ATM64 MTE extension</a></li>
<li class="toctree-l2"><a class="reference internal" href="ipv6.html">IPv6</a></li>
<li class="toctree-l2"><a class="reference internal" href="integrate_newlib.html">Integrating with Newlib</a></li>
<li class="toctree-l2"><a class="reference internal" href="protected_build.html">NuttX Protected Build</a></li>
<li class="toctree-l2"><a class="reference internal" href="platform_directories.html">Platform Directories</a></li>
<li class="toctree-l2"><a class="reference internal" href="port_drivers_to_stm32f7.html">Porting Drivers to the STM32 F7</a></li>
<li class="toctree-l2"><a class="reference internal" href="semihosting.html">Semihosting</a></li>
<li class="toctree-l2"><a class="reference internal" href="renode.html">Run NuttX on Renode</a></li>
<li class="toctree-l2"><a class="reference internal" href="signal_events_interrupt_handlers.html">Signaling Events from Interrupt Handlers</a></li>
<li class="toctree-l2"><a class="reference internal" href="signaling_sem_priority_inheritance.html">Signaling Semaphores and Priority Inheritance</a></li>
<li class="toctree-l2"><a class="reference internal" href="smaller_vector_tables.html">Smaller Vector Tables</a></li>
<li class="toctree-l2"><a class="reference internal" href="port.html">How to port</a></li>
<li class="toctree-l2"><a class="reference internal" href="updating_release_system_elf.html">Updating a Release System with ELF Programs</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">ELF Programs – With Symbol Tables</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#updating-a-release-system-with-elf-programs-with-symbol-tables">Updating a Release System with ELF Programs – With Symbol Tables</a></li>
<li class="toctree-l3"><a class="reference internal" href="#creating-a-symbol-table">Creating a Symbol Table</a></li>
<li class="toctree-l3"><a class="reference internal" href="#export-package">Export Package</a></li>
<li class="toctree-l3"><a class="reference internal" href="#add-on-build-directory">Add-On Build Directory</a></li>
<li class="toctree-l3"><a class="reference internal" href="#hello-example">Hello Example</a></li>
<li class="toctree-l3"><a class="reference internal" href="#building-the-elf-program">Building the ELF Program</a></li>
<li class="toctree-l3"><a class="reference internal" href="#the-makefile">The Makefile</a></li>
<li class="toctree-l3"><a class="reference internal" href="#the-linker-script">The Linker Script</a></li>
<li class="toctree-l3"><a class="reference internal" href="#replacing-nsh-built-in-functions">Replacing NSH Built-In Functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#tightly-coupled-memories">Tightly Coupled Memories</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="fully_linked_elf.html">ELF Programs – No Symbol Tables</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../logos/index.html">NuttX Logos</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">NuttX</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Guides</a></li>
      <li class="breadcrumb-item active">ELF Programs – With Symbol Tables</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/guides/partially_linked_elf.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="elf-programs-with-symbol-tables">
<h1>ELF Programs – With Symbol Tables<a class="headerlink" href="#elf-programs-with-symbol-tables" title="Permalink to this heading"></a></h1>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Migrated from:
<a class="reference external" href="https://cwiki.apache.org/confluence/pages/viewpage.action?pageId=139629543">https://cwiki.apache.org/confluence/pages/viewpage.action?pageId=139629543</a></p>
</div>
<section id="updating-a-release-system-with-elf-programs-with-symbol-tables">
<h2>Updating a Release System with ELF Programs – With Symbol Tables<a class="headerlink" href="#updating-a-release-system-with-elf-programs-with-symbol-tables" title="Permalink to this heading"></a></h2>
<p>You can easily extend the firmware in your released, embedded system using
ELF programs provided via a file system. For example, an SD card or, perhaps,
downloaded into on-board SPI FLASH.</p>
<p>In order to support such post-release updates, your released firmware must
support execution of ELF programs loaded into RAM and symbol tables also
provided via the file system (see <cite>apps/examples/elf</cite>).</p>
<p>The files shown in this Wiki page can be downloaded
<a class="reference external" href="https://cwiki.apache.org/confluence/download/attachments/139629402/elfprog-wsymtab.tar.gz?version=1&amp;modificationDate=1576735523000&amp;api=v2">here</a></p>
</section>
<section id="creating-a-symbol-table">
<h2>Creating a Symbol Table<a class="headerlink" href="#creating-a-symbol-table" title="Permalink to this heading"></a></h2>
<p>There are several ways to create an application symbol table. Only two are
compatible with the example provided here:</p>
<ol class="arabic">
<li><p><strong>Board-specific Bring-up Logic</strong>
Build a symbol table into the base firmware and add it to your
board-specific bring-up logic. This technique is typically used in kernel
mode with <code class="docutils literal notranslate"><span class="pre">CONFIG_USER_INITPATH=y</span></code>.</p>
<p>In this setup, the system does not initialize using a standard C call like
<code class="docutils literal notranslate"><span class="pre">nsh_main()</span></code>. Instead, it starts with an <code class="docutils literal notranslate"><span class="pre">init</span></code> ELF program, similar to
how Linux initializes. The configuration option
<code class="docutils literal notranslate"><span class="pre">CONFIG_EXECFUNCS_SYMTAB_ARRAY</span></code> initializes the system with a minimal set
of symbols required by the <code class="docutils literal notranslate"><span class="pre">init</span></code> program. Once initialized, the <code class="docutils literal notranslate"><span class="pre">init</span></code>
program would typically call <code class="docutils literal notranslate"><span class="pre">boardctl()</span></code> to put the final symbol table in
place.</p>
<p>To enable this method, you must:</p>
<ul class="simple">
<li><p>Set <code class="docutils literal notranslate"><span class="pre">CONFIG_EXECFUNCS_HAVE_SYMTAB=y</span></code> in your configuration.</p></li>
<li><p>Provide a symbol table with the global name <code class="docutils literal notranslate"><span class="pre">CONFIG_EXECFUNCS_SYMTAB_ARRAY</span></code> with the variable name <code class="docutils literal notranslate"><span class="pre">CONFIG_EXECFUNCS_NSYMBOLS_VAR</span></code> that holds the number of symbol entries. The default symbol table name is <code class="docutils literal notranslate"><span class="pre">g_symtab</span></code>.</p></li>
</ul>
<p>In this example, let’s illustrate this using an STM32F4-Discovery
configuration. We will assume that you have modified the
<code class="docutils literal notranslate"><span class="pre">boards/arm/stm32/stm32fdiscovery/src/stm32_bringup.c</span></code> file, adding the
following:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;nuttx/binfmt/symtab.h&gt;</span>

<span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">symtab_s</span><span class="w"> </span><span class="n">g_symtab</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">{</span><span class="s">&quot;printf&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">FAR</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">printf</span><span class="p">}</span>
<span class="p">};</span>

<span class="kt">int</span><span class="w"> </span><span class="n">g_nsymbols</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</pre></div>
</div>
<p>This is a simple symbol table containing only the symbol string “printf,”
whose value is the address of the function <code class="docutils literal notranslate"><span class="pre">printf()</span></code>.</p>
<p>There is, of course, a lot more that could be said about generating symbol
tables. NuttX provides specialized tools in the <code class="docutils literal notranslate"><span class="pre">tools/</span></code> directory and
instructions elsewhere for generating more extensive symbol tables. However,
this example keeps things simple to focus on the core functionality.</p>
</li>
<li><p><strong>Application Logic</strong>
Alternatively, the symbol table can be provided dynamically by the
application itself, using the <code class="docutils literal notranslate"><span class="pre">boardctl()</span></code> system interface. The specific
<code class="docutils literal notranslate"><span class="pre">boardctl()</span></code> command to use is <code class="docutils literal notranslate"><span class="pre">BOARDIOC_APP_SYMTAB</span></code>. This command
provides the symbol table in the same way as the board-specific logic but
allows for application-level control.</p>
<p>To use this approach, you need to:
- Enable the configurations <code class="docutils literal notranslate"><span class="pre">CONFIG_LIB_BOARDCTL=y</span></code> and <code class="docutils literal notranslate"><span class="pre">CONFIG_BOARDCTL_APP_SYMTAB=y</span></code>.
- Include application logic to provide the symbol table. If <code class="docutils literal notranslate"><span class="pre">CONFIG_EXAMPLES_NSH_SYMTAB=y</span></code> is set, NSH can handle this automatically.</p>
</li>
</ol>
</section>
<section id="export-package">
<h2>Export Package<a class="headerlink" href="#export-package" title="Permalink to this heading"></a></h2>
<p>At the time of firmware release, you should create and save an export package.
This export package contains all the necessary files required to create
post-release add-on modules for your embedded system.</p>
<p>For demonstration purposes, we use the STM32F4-Discovery with the network NSH
configuration. This setup assumes that you have the STM32F4DIS-BB baseboard.
The demonstration also requires support for externally modifiable media, such
as:</p>
<ul class="simple">
<li><p>Removable media, like an SD card or USB flash drive.</p></li>
<li><p>An internal file system remotely accessible via USB MSC, FTP, or other
protocols.</p></li>
<li><p>A remote file system, such as NFS.</p></li>
</ul>
<p>In this demonstration, the networking NSH configuration uses the SD card on
the STM32 baseboard. Other NSH configurations can also be used, provided they
supply the necessary file system support.</p>
<p>(No baseboard? You can add file system support to the basic <code class="docutils literal notranslate"><span class="pre">STM32F4-Discovery</span></code>
board by following these instructions:
<a class="reference external" href="https://www.youtube.com/watch?v=5hB5ZXpRoS4">USB FLASH drive</a>
or <a class="reference external" href="https://www.youtube.com/watch?v=H28t4RbOXqI">SD card</a>.)</p>
<p>Example for STM32F4-Discovery:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>make<span class="w"> </span>distclean
$<span class="w"> </span>tools/configure.sh<span class="w"> </span>-c<span class="w"> </span>stm32f4discovery:netnsh
$<span class="w"> </span>make<span class="w"> </span>menuconfig
</pre></div>
</div>
<p>Required configurations:</p>
<ul class="simple">
<li><p>Disable networking: <code class="docutils literal notranslate"><span class="pre">#</span> <span class="pre">CONFIG_NET</span> <span class="pre">is</span> <span class="pre">not</span> <span class="pre">set</span></code></p></li>
<li><p>Enable ELF binary support: <code class="docutils literal notranslate"><span class="pre">CONFIG_ELF=y</span></code>, <code class="docutils literal notranslate"><span class="pre">CONFIG_LIBC_EXECFUNCS=y</span></code>,
<code class="docutils literal notranslate"><span class="pre">CONFIG_EXECFUNCS_HAVE_SYMTAB=y</span></code>, <code class="docutils literal notranslate"><span class="pre">CONFIG_EXECFUNCS_SYMTAB_ARRAY=&quot;g_symtab&quot;</span></code> and
<code class="docutils literal notranslate"><span class="pre">CONFIG_EXECFUNCS_NSYMBOLS_VAR=&quot;g_nsymbols&quot;</span></code></p></li>
<li><p>Enable PATH variable support: <code class="docutils literal notranslate"><span class="pre">CONFIG_BINFMT_EXEPATH=y</span></code>,
<code class="docutils literal notranslate"><span class="pre">CONFIG_PATH_INITIAL=&quot;/bin&quot;</span></code></p></li>
<li><p>Enable execution from NSH: <code class="docutils literal notranslate"><span class="pre">CONFIG_NSH_FILE_APPS=y</span></code></p></li>
</ul>
<p>Then, build the NuttX firmware image and the export package:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>make
$<span class="w"> </span>make<span class="w"> </span><span class="nb">export</span>
</pre></div>
</div>
<p>When <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">export</span></code> completes, you will find a ZIP package in the top-level
NuttX directory called <code class="docutils literal notranslate"><span class="pre">nuttx-export-x.y.zip</span></code> (where x.y corresponds to the
version, determined by the .version file in the same directory). The contents
of this ZIP file are organized as follows:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>nuttx-export-x.x
|- arch/
|- build/
|- include/
|- libs/
|- startup/
|- System.map
`- .config
</pre></div>
</div>
</section>
<section id="add-on-build-directory">
<h2>Add-On Build Directory<a class="headerlink" href="#add-on-build-directory" title="Permalink to this heading"></a></h2>
<p>In order to create the add-on ELF program, you will need:</p>
<ol class="arabic simple">
<li><p>The export package.</p></li>
<li><p>A program build Makefile.</p></li>
<li><p>A linker script used by the Makefile.</p></li>
</ol>
<p>The example Makefile discussed below assumes the use of a GNU toolchain. Note
that non-GNU toolchains would likely require a significantly different
Makefile and linker script.</p>
</section>
<section id="hello-example">
<h2>Hello Example<a class="headerlink" href="#hello-example" title="Permalink to this heading"></a></h2>
<p>To keep things manageable, let’s use a concrete example. Suppose the ELF
program that we wish to add to the release code is the simple
source file <code class="docutils literal notranslate"><span class="pre">hello.c</span></code>:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Hello from Add-On Program!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Let’s say that we have a directory called <code class="docutils literal notranslate"><span class="pre">addon</span></code> that contains the following:</p>
<ol class="arabic simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">hello.c</span></code> source file.</p></li>
<li><p>A Makefile to build the ELF program.</p></li>
<li><p>A linker script called <code class="docutils literal notranslate"><span class="pre">gnu-elf.ld</span></code> needed by the Makefile.</p></li>
<li><p>The export package <code class="docutils literal notranslate"><span class="pre">nuttx-export-7.25.zip</span></code>.</p></li>
</ol>
</section>
<section id="building-the-elf-program">
<h2>Building the ELF Program<a class="headerlink" href="#building-the-elf-program" title="Permalink to this heading"></a></h2>
<p>The first step in creating the ELF program is to unzip the export
package. Starting in the <code class="docutils literal notranslate"><span class="pre">addon</span></code> directory:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span><span class="nb">cd</span><span class="w"> </span>addon
$<span class="w"> </span>ls
gnu-elf.ld<span class="w"> </span>hello.c<span class="w"> </span>Makefile<span class="w"> </span>nuttx-export-7.25.zip
</pre></div>
</div>
<p>Where:
- <code class="docutils literal notranslate"><span class="pre">gnu-elf.ld</span></code> is the linker script.
- <code class="docutils literal notranslate"><span class="pre">hello.c</span></code> is the example source file.
- <code class="docutils literal notranslate"><span class="pre">Makefile</span></code> builds the ELF program.
- <code class="docutils literal notranslate"><span class="pre">nuttx-export-7.25.zip</span></code> is the export package from NuttX 7.25.</p>
<p>Unzip the export package as follows:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>unzip<span class="w"> </span>nuttx-export-7.25.zip
</pre></div>
</div>
<p>This creates a new directory called <code class="docutils literal notranslate"><span class="pre">nuttx-export-7.25</span></code>, containing
all the content from the released NuttX code required to build
the ELF program.</p>
</section>
<section id="the-makefile">
<h2>The Makefile<a class="headerlink" href="#the-makefile" title="Permalink to this heading"></a></h2>
<p>To build the ELF program, simply run:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>make
</pre></div>
</div>
<p>This uses the following Makefile to generate several files:
- <code class="docutils literal notranslate"><span class="pre">hello.o</span></code>: The compiled object file for <code class="docutils literal notranslate"><span class="pre">hello.c</span></code>.
- <code class="docutils literal notranslate"><span class="pre">hello</span></code>: The linked ELF program.</p>
<p>Only the resulting <code class="docutils literal notranslate"><span class="pre">hello</span></code> file is needed.</p>
<p>The Makefile used to create the ELF program is as follows:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>include<span class="w"> </span>nuttx-export-7.25/build/Make.defs

<span class="c1"># Long calls are need to call from RAM into FLASH</span>

<span class="nv">ARCHCFLAGS</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span>-mlong-calls
<span class="nv">ARCHWARNINGS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>-Wall<span class="w"> </span>-Wstrict-prototypes<span class="w"> </span>-Wshadow<span class="w"> </span>-Wundef
<span class="nv">ARCHOPTIMIZATION</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>-Os<span class="w"> </span>-fno-strict-aliasing<span class="w"> </span>-fno-strength-reduce<span class="w"> </span>-fomit-frame-pointer
<span class="nv">ARCHINCLUDES</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>-I.<span class="w"> </span>-isystem<span class="w">  </span>nuttx-export-7.25/include

<span class="nv">CFLAGS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">$(</span>ARCHCFLAGS<span class="k">)</span><span class="w"> </span><span class="k">$(</span>ARCHWARNINGS<span class="k">)</span><span class="w"> </span><span class="k">$(</span>ARCHOPTIMIZATION<span class="k">)</span><span class="w"> </span><span class="k">$(</span>ARCHINCLUDES<span class="k">)</span><span class="w"> </span>-pipe

<span class="nv">CROSSDEV</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>arm-none-eabi-
<span class="nv">CC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">$(</span>CROSSDEV<span class="k">)</span>gcc
<span class="nv">LD</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">$(</span>CROSSDEV<span class="k">)</span>ld
<span class="nv">STRIP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">$(</span>CROSSDEV<span class="k">)</span>strip<span class="w"> </span>--strip-unneeded

<span class="c1"># Setup up linker command line options</span>

<span class="nv">LDELFFLAGS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>-r<span class="w"> </span>-e<span class="w"> </span>main
<span class="nv">LDELFFLAGS</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span>-T<span class="w"> </span>gnu-elf.ld

<span class="c1"># This might change in a different environment</span>

OBJEXT<span class="w"> </span>?<span class="o">=</span><span class="w"> </span>.o

<span class="c1"># This is the generated ELF program</span>

<span class="nv">BIN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>hello

<span class="c1"># These are the sources files that we use</span>

<span class="nv">SRCS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>hello.c
<span class="nv">OBJS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">$(</span>SRCS:.c<span class="o">=</span><span class="k">$(</span>OBJEXT<span class="k">))</span>

<span class="c1"># Build targets</span>

all:<span class="w"> </span><span class="k">$(</span>BIN<span class="k">)</span>
.PHONY:<span class="w"> </span>clean

<span class="k">$(</span>OBJS<span class="k">)</span>:<span class="w"> </span>%<span class="k">$(</span>OBJEXT<span class="k">)</span>:<span class="w"> </span>%.c
<span class="k">$(</span>CC<span class="k">)</span><span class="w"> </span>-c<span class="w"> </span><span class="k">$(</span>CFLAGS<span class="k">)</span><span class="w"> </span>$&lt;<span class="w"> </span>-o<span class="w"> </span><span class="nv">$@</span>

<span class="k">$(</span>BIN<span class="k">)</span>:<span class="w"> </span><span class="k">$(</span>OBJS<span class="k">)</span>
<span class="k">$(</span>LD<span class="k">)</span><span class="w"> </span><span class="k">$(</span>LDELFFLAGS<span class="k">)</span><span class="w"> </span>-o<span class="w"> </span><span class="nv">$@</span><span class="w"> </span>$^
<span class="k">$(</span>STRIP<span class="k">)</span><span class="w"> </span><span class="k">$(</span>BIN<span class="k">)</span>

clean:
rm<span class="w"> </span>-f<span class="w"> </span><span class="k">$(</span>BIN<span class="k">)</span>
rm<span class="w"> </span>-f<span class="w"> </span>*.o
</pre></div>
</div>
</section>
<section id="the-linker-script">
<h2>The Linker Script<a class="headerlink" href="#the-linker-script" title="Permalink to this heading"></a></h2>
<p>The linker script that I am using in this example, gnu-elf.ld,
contains the following:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>SECTIONS
<span class="o">{</span>
.text<span class="w"> </span>0x00000000<span class="w"> </span>:
<span class="w">    </span><span class="o">{</span>
<span class="w">    </span><span class="nv">_stext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>.<span class="w"> </span><span class="p">;</span>
<span class="w">    </span>*<span class="o">(</span>.text<span class="o">)</span>
<span class="w">    </span>*<span class="o">(</span>.text.*<span class="o">)</span>
<span class="w">    </span>*<span class="o">(</span>.gnu.warning<span class="o">)</span>
<span class="w">    </span>*<span class="o">(</span>.stub<span class="o">)</span>
<span class="w">    </span>*<span class="o">(</span>.glue_7<span class="o">)</span>
<span class="w">    </span>*<span class="o">(</span>.glue_7t<span class="o">)</span>
<span class="w">    </span>*<span class="o">(</span>.jcr<span class="o">)</span>
<span class="w">    </span><span class="nv">_etext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>.<span class="w"> </span><span class="p">;</span>
<span class="w">    </span><span class="o">}</span>

.rodata<span class="w"> </span>:
<span class="w">    </span><span class="o">{</span>
<span class="w">    </span><span class="nv">_srodata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>.<span class="w"> </span><span class="p">;</span>
<span class="w">    </span>*<span class="o">(</span>.rodata<span class="o">)</span>
<span class="w">    </span>*<span class="o">(</span>.rodata1<span class="o">)</span>
<span class="w">    </span>*<span class="o">(</span>.rodata.*<span class="o">)</span>
<span class="w">    </span>*<span class="o">(</span>.gnu.linkonce.r*<span class="o">)</span>
<span class="w">    </span><span class="nv">_erodata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>.<span class="w"> </span><span class="p">;</span>
<span class="w">    </span><span class="o">}</span>

.data<span class="w"> </span>:
<span class="w">    </span><span class="o">{</span>
<span class="w">    </span><span class="nv">_sdata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>.<span class="w"> </span><span class="p">;</span>
<span class="w">    </span>*<span class="o">(</span>.data<span class="o">)</span>
<span class="w">    </span>*<span class="o">(</span>.data1<span class="o">)</span>
<span class="w">    </span>*<span class="o">(</span>.data.*<span class="o">)</span>
<span class="w">    </span>*<span class="o">(</span>.gnu.linkonce.d*<span class="o">)</span>
<span class="w">    </span><span class="nv">_edata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>.<span class="w"> </span><span class="p">;</span>
<span class="w">    </span><span class="o">}</span>

.bss<span class="w"> </span>:
<span class="w">    </span><span class="o">{</span>
<span class="w">    </span><span class="nv">_sbss</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>.<span class="w"> </span><span class="p">;</span>
<span class="w">    </span>*<span class="o">(</span>.bss<span class="o">)</span>
<span class="w">    </span>*<span class="o">(</span>.bss.*<span class="o">)</span>
<span class="w">    </span>*<span class="o">(</span>.sbss<span class="o">)</span>
<span class="w">    </span>*<span class="o">(</span>.sbss.*<span class="o">)</span>
<span class="w">    </span>*<span class="o">(</span>.gnu.linkonce.b*<span class="o">)</span>
<span class="w">    </span>*<span class="o">(</span>COMMON<span class="o">)</span>
<span class="w">    </span><span class="nv">_ebss</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>.<span class="w"> </span><span class="p">;</span>
<span class="w">    </span><span class="o">}</span>

<span class="w">    </span>/*<span class="w"> </span>Stabs<span class="w"> </span>debugging<span class="w"> </span>sections.<span class="w">    </span>*/

<span class="w">    </span>.stab<span class="w"> </span><span class="m">0</span><span class="w"> </span>:<span class="w"> </span><span class="o">{</span><span class="w"> </span>*<span class="o">(</span>.stab<span class="o">)</span><span class="w"> </span><span class="o">}</span>
<span class="w">    </span>.stabstr<span class="w"> </span><span class="m">0</span><span class="w"> </span>:<span class="w"> </span><span class="o">{</span><span class="w"> </span>*<span class="o">(</span>.stabstr<span class="o">)</span><span class="w"> </span><span class="o">}</span>
<span class="w">    </span>.stab.excl<span class="w"> </span><span class="m">0</span><span class="w"> </span>:<span class="w"> </span><span class="o">{</span><span class="w"> </span>*<span class="o">(</span>.stab.excl<span class="o">)</span><span class="w"> </span><span class="o">}</span>
<span class="w">    </span>.stab.exclstr<span class="w"> </span><span class="m">0</span><span class="w"> </span>:<span class="w"> </span><span class="o">{</span><span class="w"> </span>*<span class="o">(</span>.stab.exclstr<span class="o">)</span><span class="w"> </span><span class="o">}</span>
<span class="w">    </span>.stab.index<span class="w"> </span><span class="m">0</span><span class="w"> </span>:<span class="w"> </span><span class="o">{</span><span class="w"> </span>*<span class="o">(</span>.stab.index<span class="o">)</span><span class="w"> </span><span class="o">}</span>
<span class="w">    </span>.stab.indexstr<span class="w"> </span><span class="m">0</span><span class="w"> </span>:<span class="w"> </span><span class="o">{</span><span class="w"> </span>*<span class="o">(</span>.stab.indexstr<span class="o">)</span><span class="w"> </span><span class="o">}</span>
<span class="w">    </span>.comment<span class="w"> </span><span class="m">0</span><span class="w"> </span>:<span class="w"> </span><span class="o">{</span><span class="w"> </span>*<span class="o">(</span>.comment<span class="o">)</span><span class="w"> </span><span class="o">}</span>
<span class="w">    </span>.debug_abbrev<span class="w"> </span><span class="m">0</span><span class="w"> </span>:<span class="w"> </span><span class="o">{</span><span class="w"> </span>*<span class="o">(</span>.debug_abbrev<span class="o">)</span><span class="w"> </span><span class="o">}</span>
<span class="w">    </span>.debug_info<span class="w"> </span><span class="m">0</span><span class="w"> </span>:<span class="w"> </span><span class="o">{</span><span class="w"> </span>*<span class="o">(</span>.debug_info<span class="o">)</span><span class="w"> </span><span class="o">}</span>
<span class="w">    </span>.debug_line<span class="w"> </span><span class="m">0</span><span class="w"> </span>:<span class="w"> </span><span class="o">{</span><span class="w"> </span>*<span class="o">(</span>.debug_line<span class="o">)</span><span class="w"> </span><span class="o">}</span>
<span class="w">    </span>.debug_pubnames<span class="w"> </span><span class="m">0</span><span class="w"> </span>:<span class="w"> </span><span class="o">{</span><span class="w"> </span>*<span class="o">(</span>.debug_pubnames<span class="o">)</span><span class="w"> </span><span class="o">}</span>
<span class="w">    </span>.debug_aranges<span class="w"> </span><span class="m">0</span><span class="w"> </span>:<span class="w"> </span><span class="o">{</span><span class="w"> </span>*<span class="o">(</span>.debug_aranges<span class="o">)</span><span class="w"> </span><span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</section>
<section id="replacing-nsh-built-in-functions">
<h2>Replacing NSH Built-In Functions<a class="headerlink" href="#replacing-nsh-built-in-functions" title="Permalink to this heading"></a></h2>
<p>Files can be executed by NSH from the command line by simply typing the name
of the ELF program. This requires (1) that the feature be enabled with
<code class="docutils literal notranslate"><span class="pre">CONFIG_NSH_FILE_APP=y</span></code> and (2) that support for the PATH variable is
enabled with <code class="docutils literal notranslate"><span class="pre">CONFIG_BINFMT_EXEPATH=y</span></code> and <code class="docutils literal notranslate"><span class="pre">CONFIG_PATH_INITIAL</span></code> set to
the mount point of the file system that may contain ELF programs.</p>
<p>In this example, there is no application in the base firmware called
<code class="docutils literal notranslate"><span class="pre">hello</span></code>. So attempts to run <code class="docutils literal notranslate"><span class="pre">hello</span></code> will fail:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>nsh&gt;<span class="w"> </span>hello
nsh:<span class="w"> </span>hello:<span class="w"> </span><span class="nb">command</span><span class="w"> </span>not<span class="w"> </span>found
nsh&gt;
</pre></div>
</div>
<p>But if we mount the SD card containing the <code class="docutils literal notranslate"><span class="pre">hello</span></code> image that we created
above, then we can successfully execute the <code class="docutils literal notranslate"><span class="pre">hello</span></code> command:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>nsh&gt;<span class="w"> </span>mount<span class="w"> </span>-t<span class="w"> </span>vfat<span class="w"> </span>/dev/mmcsd0<span class="w"> </span>/bin
nsh&gt;<span class="w"> </span>ls<span class="w"> </span>/bin
/bin:
<span class="w"> </span>System<span class="w"> </span>Volume<span class="w"> </span>Information/
<span class="w"> </span>hello
nsh&gt;<span class="w"> </span>hello
Hello<span class="w"> </span>from<span class="w"> </span>Add-On<span class="w"> </span>Program!
nsh&gt;
</pre></div>
</div>
<p>Here we showed how you can add a new command to NSH to a product without
modifying the base firmware. We can also replace or update an existing
built-in application in this way:</p>
<p>In the above configuration, NSH will first attempt to run the program called
<code class="docutils literal notranslate"><span class="pre">hello</span></code> from the file system. This will fail because we have not yet put
our custom <code class="docutils literal notranslate"><span class="pre">hello</span></code> ELF program in the file system. So instead, NSH will
fallback and execute the built-in application called <code class="docutils literal notranslate"><span class="pre">hello</span></code>. In this way,
any command known to NSH can be replaced from an ELF program installed in a
mounted file system directory that can be found via the PATH variable.</p>
<p>After we do add our custom <code class="docutils literal notranslate"><span class="pre">hello</span></code> to the file system, when NSH attempts to
run the program called <code class="docutils literal notranslate"><span class="pre">hello</span></code> from the file system it will run
successfully. The built-in version will be ignored. It has been replaced with
the version in the file system.</p>
</section>
<section id="tightly-coupled-memories">
<h2>Tightly Coupled Memories<a class="headerlink" href="#tightly-coupled-memories" title="Permalink to this heading"></a></h2>
<p>Most MCUs based on ARMv7-M family processors support some kind of Tightly
Coupled Memory (TCM). These TCMs have somewhat different properties for
specialized operations. Depending on the bus matrix of the processor, you
may not be able to execute programs from the TCM. For instance, the STM32 F4
supports Core Coupled Memory (CCM), but since it is tied directly to the
D-bus, it cannot be used to execute programs! On the other hand, the STM32F3
has a CCM that is accessible to both the D-Bus and the I-Bus, in which case
it should be possible to execute programs from this TCM.</p>
<img alt="../_images/system_arch_stm32f42xx_and_f43xx.png" src="../_images/system_arch_stm32f42xx_and_f43xx.png" />
<img alt="../_images/system_arch_stm32f303xBC_and_f358xC.png" src="../_images/system_arch_stm32f303xBC_and_f358xC.png" />
<p>When ELF programs are loaded into memory, the memory is allocated from the
heap via a standard memory allocator. By default with the STM32 F4, the CCM
is included in the heap and will typically be allocated first. If CCM memory
is allocated to hold the ELF program in memory, then a hard-fault will occur
immediately when you try to execute the ELF program in memory.</p>
<p>Therefore, it is necessary on STM32 F4 platforms to include the following
configuration setting:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="nv">CONFIG_STM32_CCMEXCLUDE</span><span class="o">=</span>y
</pre></div>
</div>
<p>With that setting, the CCM memory will be excluded from the heap and so will
never be allocated for ELF program memory.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="updating_release_system_elf.html" class="btn btn-neutral float-left" title="Updating a Release System with ELF Programs" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="fully_linked_elf.html" class="btn btn-neutral float-right" title="ELF Programs – No Symbol Tables" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, The Apache Software Foundation.</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>