<!--
 Documentation/_templates/layout.html

 Licensed to the Apache Software Foundation (ASF) under one or more
 contributor license agreements.  See the NOTICE file distributed with
 this work for additional information regarding copyright ownership.  The
 ASF licenses this file to you under the Apache License, Version 2.0 (the
 "License"); you may not use this file except in compliance with the
 License.  You may obtain a copy of the License at

   http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
 WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 License for the specific language governing permissions and limitations
 under the License.
-->



<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Make Build System &mdash; NuttX latest documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css" />
      <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
      <link rel="stylesheet" type="text/css" href="../_static/sphinx_collapse.css" />
      <link rel="stylesheet" type="text/css" href="../_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css" />
      <link rel="stylesheet" type="text/css" href="../_static/custom.css" />

  
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
      <script src="../_static/jquery.js"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
      <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
      <script src="../_static/doctools.js"></script>
      <script src="../_static/sphinx_highlight.js"></script>
      <script src="../_static/clipboard.min.js"></script>
      <script src="../_static/copybutton.js"></script>
      <script src="../_static/design-tabs.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="OS Drivers Design" href="drivers_design.html" />
    <link rel="prev" title="Implementation Details" href="index.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
  
    <a href="../index.html" class="icon icon-home"> NuttX
  

  
  </a>

  <!-- this version selector is quite ugly, should be probably replaced by something
       more modern -->

  <div class="version-selector">
    <select onchange="javascript:location.href = this.value;">
    
    <option value="../../latest" selected="selected">latest</option>
    
    <option value="../../10.0.0" >10.0.0</option>
    
    <option value="../../10.0.1" >10.0.1</option>
    
    <option value="../../10.1.0" >10.1.0</option>
    
    <option value="../../10.2.0" >10.2.0</option>
    
    <option value="../../10.3.0" >10.3.0</option>
    
    <option value="../../11.0.0" >11.0.0</option>
    
    <option value="../../12.0.0" >12.0.0</option>
    
    <option value="../../12.1.0" >12.1.0</option>
    
    <option value="../../12.2.0" >12.2.0</option>
    
    <option value="../../12.2.1" >12.2.1</option>
    
    <option value="../../12.3.0" >12.3.0</option>
    
    <option value="../../12.4.0" >12.4.0</option>
    
    <option value="../../12.5.0" >12.5.0</option>
    
    <option value="../../12.5.1" >12.5.1</option>
    
    <option value="../../12.6.0" >12.6.0</option>
    
    <option value="../../12.7.0" >12.7.0</option>
    
    <option value="../../12.8.0" >12.8.0</option>
    
    <option value="../../12.9.0" >12.9.0</option>
    
    <option value="../../12.10.0" >12.10.0</option>
    
    <option value="../../12.11.0" >12.11.0</option>
    
    <option value="../../12.12.0" >12.12.0</option>
    
    </select>
  </div>

  
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Table of Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../index.html">Home</a></li>
<li class="toctree-l1"><a class="reference internal" href="../introduction/index.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quickstart/index.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contributing/index.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../introduction/inviolables.html">The Inviolable Principles of NuttX</a></li>
<li class="toctree-l1"><a class="reference internal" href="../platforms/index.html">Supported Platforms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../components/index.html">OS Components</a></li>
<li class="toctree-l1"><a class="reference internal" href="../applications/index.html">Applications</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Implementation Details</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">Make Build System</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#verbosity">Verbosity</a></li>
<li class="toctree-l3"><a class="reference internal" href="#build-process">Build Process</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#starting-the-build">Starting the Build</a></li>
<li class="toctree-l4"><a class="reference internal" href="#built-in-dependency-mechanism">Built-in dependency mechanism</a></li>
<li class="toctree-l4"><a class="reference internal" href="#building-nuttx-libs">Building NuttX libs</a></li>
<li class="toctree-l4"><a class="reference internal" href="#pass1-pass2">pass1 &amp; pass2</a></li>
<li class="toctree-l4"><a class="reference internal" href="#staging-the-libs">Staging the libs</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#win-mk">Win.mk</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#forward-vs-back-slashes">Forward vs Back slashes</a></li>
<li class="toctree-l4"><a class="reference internal" href="#hostexeext-hostdynext">${HOSTEXEEXT} ${HOSTDYNEXT}</a></li>
<li class="toctree-l4"><a class="reference internal" href="#symbolic-linking">Symbolic Linking</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#unix-mk">Unix.mk</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#versioning">Versioning</a></li>
<li class="toctree-l4"><a class="reference internal" href="#config-h-config-mkconfig">config.h, .config, mkconfig</a></li>
<li class="toctree-l4"><a class="reference internal" href="#symlinks-dirlinks">Symlinks &amp; dirlinks</a></li>
<li class="toctree-l4"><a class="reference internal" href="#dummies">Dummies</a></li>
<li class="toctree-l4"><a class="reference internal" href="#build-modes">Build Modes</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#config-mk">Config.mk</a></li>
<li class="toctree-l3"><a class="reference internal" href="#flatlibs-mk">FlatLibs.mk</a></li>
<li class="toctree-l3"><a class="reference internal" href="#protectedlibs-mk">ProtectedLibs.mk</a></li>
<li class="toctree-l3"><a class="reference internal" href="#kernellibs-mk">KernelLibs.mk</a></li>
<li class="toctree-l3"><a class="reference internal" href="#directories-mk">Directories.mk</a></li>
<li class="toctree-l3"><a class="reference internal" href="#libtargets-mk">LibTargets.mk</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="drivers_design.html">OS Drivers Design</a></li>
<li class="toctree-l2"><a class="reference internal" href="device_drivers.html">Device Drivers</a></li>
<li class="toctree-l2"><a class="reference internal" href="processes_vs_tasks.html">Linux Processes vs NuttX Tasks</a></li>
<li class="toctree-l2"><a class="reference internal" href="critical_sections.html">Critical Sections</a></li>
<li class="toctree-l2"><a class="reference internal" href="interrupt_controls.html">Per-Thread Interrupt Controls</a></li>
<li class="toctree-l2"><a class="reference internal" href="preemption_latency.html">Effects of Disabling Interrupts or Pre-Emption on Response Latency</a></li>
<li class="toctree-l2"><a class="reference internal" href="bottomhalf_interrupt.html">Bottom-Half Interrupt Handlers</a></li>
<li class="toctree-l2"><a class="reference internal" href="simulation.html">The NuttX Simulation</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../reference/index.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq/index.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../debugging/index.html">Debugging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../guides/index.html">Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../standards/index.html">Standards</a></li>
<li class="toctree-l1"><a class="reference internal" href="../glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../logos/index.html">NuttX Logos</a></li>
<li class="toctree-l1"><a class="reference internal" href="../_tags/tagsindex.html">Tags</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">NuttX</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Implementation Details</a></li>
      <li class="breadcrumb-item active">Make Build System</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/apache/nuttx/blob/master/Documentation/implementation/make_build_system.rst" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="make-build-system">
<h1>Make Build System<a class="headerlink" href="#make-build-system" title="Permalink to this heading"></a></h1>
<p>Currently, NuttX supports both CMake and Make build systems.
This guide explains the NuttX <code class="docutils literal notranslate"><span class="pre">make</span></code>-based build system.</p>
<p>Due to <em>requirements, constraints, and the complexity of the build process</em>, NuttX divides
this work into multiple files, each handling specific parts of the build process.</p>
<p>As stated in <a class="reference internal" href="../introduction/inviolables.html"><span class="doc">The Inviolable Principles of NuttX</span></a>, multiple platforms should be supported:</p>
<ul class="simple">
<li><p><a class="reference internal" href="#win-mk"><span class="std std-ref">Win.mk</span></a>: handles windows platform support.</p></li>
<li><p><a class="reference internal" href="#unix-mk"><span class="std std-ref">Unix.mk</span></a>: handles unix-like platforms support.</p></li>
</ul>
<p>NuttX supports multiple build modes. See <a class="reference internal" href="../guides/protected_build.html"><span class="doc">NuttX Protected Build</span></a>:</p>
<ul class="simple">
<li><p><a class="reference internal" href="#flatlibs-mk"><span class="std std-ref">FlatLibs.mk</span></a>: Kernel and user-space built into a single <code class="docutils literal notranslate"><span class="pre">blob</span></code>.</p></li>
<li><p><a class="reference internal" href="#protectedlibs-mk"><span class="std std-ref">ProtectedLibs.mk</span></a>: Kernel and user-space built as two separate <code class="docutils literal notranslate"><span class="pre">blobs</span></code>.</p></li>
<li><p><a class="reference internal" href="#kernelibs-mk"><span class="std std-ref">KernelLibs.mk</span></a>: Kernel built into single <code class="docutils literal notranslate"><span class="pre">blob</span></code>. User apps must be loaded
into memory for execution.</p></li>
</ul>
<p>NuttX targets multiple libs, or <code class="docutils literal notranslate"><span class="pre">silos</span></code>, each handling its own compilation:</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Gregory Nutt has a nice presentation about
<a class="reference external" href="https://cwiki.apache.org/confluence/pages/viewpage.action?pageId=139629399&amp;preview=/139629402/140774623/nuttx-3-archoverview.pdf">NuttX architecture</a></p>
<p>There the <code class="docutils literal notranslate"><span class="pre">silo</span></code> concept is explained. Only the <code class="docutils literal notranslate"><span class="pre">silos</span></code> there are listed below as libs.
The build mode influences the needed libs.</p>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ls<span class="w"> </span>-l<span class="w"> </span>staging/
<span class="go">drwxr-xr-x  2 xxx xxx    4096 Oct  6 16:02 .</span>
<span class="go">drwxr-xr-x 27 xxx xxx    4096 Oct  6 16:02 ..</span>
<span class="go">-rw-r--r--  1 xxx xxx  323640 Oct  6 16:02 libapps.a</span>
<span class="go">-rw-r--r--  1 xxx xxx  384352 Oct  6 16:02 libarch.a</span>
<span class="go">-rw-r--r--  1 xxx xxx   62182 Oct  6 16:02 libbinfmt.a</span>
<span class="go">-rw-r--r--  1 xxx xxx    6468 Oct  6 16:01 libboards.a</span>
<span class="go">-rw-r--r--  1 xxx xxx 2820054 Oct  6 16:02 libc.a</span>
<span class="go">-rw-r--r--  1 xxx xxx  161486 Oct  6 16:01 libdrivers.a</span>
<span class="go">-rw-r--r--  1 xxx xxx  981638 Oct  6 16:02 libfs.a</span>
<span class="go">-rw-r--r--  1 xxx xxx  224446 Oct  6 16:02 libmm.a</span>
<span class="go">-rw-r--r--  1 xxx xxx 2435746 Oct  6 16:01 libsched.a</span>
<span class="go">-rw-r--r--  1 xxx xxx   51768 Oct  6 16:02 libxx.a</span>
</pre></div>
</div>
<section id="verbosity">
<span id="id1"></span><h2>Verbosity<a class="headerlink" href="#verbosity" title="Permalink to this heading"></a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">V</span></code> variable can be passed to <code class="docutils literal notranslate"><span class="pre">make</span></code> to control the build verbosity.</p>
<ul class="simple">
<li><p><strong>Quiet (Default):</strong> The build output is minimal.</p></li>
<li><p><strong>Verbose (`V=1 V=2`):</strong> Shows the full compiler commands <em>(enables command echo)</em>.</p></li>
<li><p><strong>Verbose Tools (`V=2`):</strong> Enables verbose output for tools and scripts.</p></li>
</ul>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span><span class="nv">V</span><span class="o">=</span><span class="m">1</span>,2:<span class="w"> </span>Enable<span class="w"> </span><span class="nb">echo</span><span class="w"> </span>of<span class="w"> </span>commands
<span class="gp">$ </span>make<span class="w"> </span><span class="nv">V</span><span class="o">=</span><span class="m">1</span>

<span class="gp"># </span><span class="nv">V</span><span class="o">=</span><span class="m">2</span>:<span class="w">   </span>Enable<span class="w"> </span>bug/verbose<span class="w"> </span>options<span class="w"> </span><span class="k">in</span><span class="w"> </span>tools<span class="w"> </span>and<span class="w"> </span>scripts
<span class="gp">$ </span>make<span class="w"> </span><span class="nv">V</span><span class="o">=</span><span class="m">2</span>
</pre></div>
</div>
</section>
<section id="build-process">
<h2>Build Process<a class="headerlink" href="#build-process" title="Permalink to this heading"></a></h2>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Keep the configuration step and board folder layout short.
Separate docs should be created.</p>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">Make</span></code> based build process starts with the NuttX tree configuration.
This is done by running <code class="docutils literal notranslate"><span class="pre">tools/configure.sh</span></code> script.
The configuration step, prepares the NuttX kernel tree, setting the board specific
arch, chip and board files.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">Make</span></code> build system refers the needed subsystems using <em>generic</em> naming:</p>
<ul class="simple">
<li><p>The <em>current</em> architecture is refered as <code class="docutils literal notranslate"><span class="pre">arch</span></code></p></li>
<li><p>The <em>current</em> chip is refered as <code class="docutils literal notranslate"><span class="pre">chip</span></code></p></li>
<li><p>The <em>current</em> board is refered as <code class="docutils literal notranslate"><span class="pre">board</span></code></p></li>
</ul>
<p>These <em>generic</em> names are mapped to the <em>actual</em> names by symlinks:</p>
<ul class="simple">
<li><p>The <em>current</em> chip directory gets symlinked to <code class="docutils literal notranslate"><span class="pre">nutt/include/arch/chip</span></code>.</p></li>
<li><p>The <em>current</em> board directory gets symlinked to <code class="docutils literal notranslate"><span class="pre">nutt/include/arch/board</span></code>.</p></li>
<li><p>The <em>current</em> arch directory gets symlinked to <code class="docutils literal notranslate"><span class="pre">nutt/include/arch</span></code>.</p></li>
</ul>
<p>The board config is stored as <code class="docutils literal notranslate"><span class="pre">defconfig</span></code> file, which is a minimal config,
storing only the configs that differs from default config values.
Due to NuttX’s particularity of strict dependance to the <code class="docutils literal notranslate"><span class="pre">app</span></code>
directory, the <code class="docutils literal notranslate"><span class="pre">.config</span></code> file is not generated by either <code class="docutils literal notranslate"><span class="pre">kconfiglib</span></code> or
<code class="docutils literal notranslate"><span class="pre">kconfig-frontends</span></code>, but rather by the an in-tree <code class="docutils literal notranslate"><span class="pre">tools/process_config.sh</span></code>
script. This script takes a “base” input file (the boards <code class="docutils literal notranslate"><span class="pre">defconfig</span></code> file),
additional include paths (the most relevant being the <code class="docutils literal notranslate"><span class="pre">apps</span></code> top directory),
and generate an output file (the <code class="docutils literal notranslate"><span class="pre">$(TOPDIR)/.config</span></code> file).</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>part<span class="w"> </span>of<span class="w"> </span>configure.sh<span class="w"> </span>shell<span class="w"> </span>script,<span class="w"> </span>starting<span class="w"> </span>at<span class="w"> </span>line<span class="w"> </span><span class="m">240</span>
<span class="gp">#</span>
<span class="gp"># </span><span class="nv">src_config</span><span class="o">=</span><span class="si">${</span><span class="nv">configpath</span><span class="si">}</span>/defconfig
<span class="gp"># </span><span class="nv">dest_config</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">TOPDIR</span><span class="si">}</span><span class="s2">/.config&quot;</span>
<span class="gp"># </span><span class="nv">original_config</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">TOPDIR</span><span class="si">}</span><span class="s2">/.config.orig&quot;</span>
<span class="gp"># </span><span class="nv">backup_config</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">TOPDIR</span><span class="si">}</span><span class="s2">/defconfig&quot;</span>

<span class="gp">$ </span>ln<span class="w"> </span>-sf<span class="w"> </span><span class="si">${</span><span class="nv">src_makedefs</span><span class="si">}</span><span class="w"> </span><span class="si">${</span><span class="nv">dest_makedefs</span><span class="si">}</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span><span class="o">{</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Failed to symlink </span><span class="si">${</span><span class="nv">src_makedefs</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="nb">exit</span><span class="w"> </span><span class="m">8</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="o">}</span>
<span class="gp">$ </span><span class="si">${</span><span class="nv">TOPDIR</span><span class="si">}</span>/tools/process_config.sh<span class="w"> </span>-I<span class="w"> </span><span class="si">${</span><span class="nv">configpath</span><span class="si">}</span>/../../common/configs<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-I<span class="w"> </span><span class="si">${</span><span class="nv">configpath</span><span class="si">}</span>/../common<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-I<span class="w"> </span><span class="si">${</span><span class="nv">configpath</span><span class="si">}</span><span class="w"> </span>-I<span class="w"> </span><span class="si">${</span><span class="nv">TOPDIR</span><span class="si">}</span>/../apps<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-I<span class="w"> </span><span class="si">${</span><span class="nv">TOPDIR</span><span class="si">}</span>/../nuttx-apps<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-o<span class="w"> </span><span class="si">${</span><span class="nv">dest_config</span><span class="si">}</span><span class="w"> </span><span class="si">${</span><span class="nv">src_config</span><span class="si">}</span>
</pre></div>
</div>
<section id="starting-the-build">
<h3>Starting the Build<a class="headerlink" href="#starting-the-build" title="Permalink to this heading"></a></h3>
<p>The root <strong>Makefile</strong> is the build process entrypoint. Its main job is
to check for a <code class="docutils literal notranslate"><span class="pre">.config</span></code> file and include the appropriate <strong>host-specific Makefile</strong>.
The “actual” first steps of the build process are handled by the host-specific
<strong>Makefile</strong> (either <code class="docutils literal notranslate"><span class="pre">Win.mk</span></code> or <code class="docutils literal notranslate"><span class="pre">Unix.mk</span></code>).</p>
<p>Early on, during parsing, both host-specific <strong>Makefile</strong> will also include</p>
<ul class="simple">
<li><p>board’s <code class="docutils literal notranslate"><span class="pre">Make.defs</span></code> file mentioned above. This will include also</p>
<ul>
<li><p>the main <code class="docutils literal notranslate"><span class="pre">.config</span></code> file.</p></li>
<li><p>the tools <code class="docutils literal notranslate"><span class="pre">config.mk</span></code> file.</p></li>
<li><p>the arch <code class="docutils literal notranslate"><span class="pre">toolchain.defs</span></code> file.</p></li>
</ul>
</li>
<li><p>based on the build mode, one of the following files:</p>
<ul>
<li><p><a class="reference internal" href="#flatlibs-mk"><span class="std std-ref">FlatLibs.mk</span></a></p></li>
<li><p><a class="reference internal" href="#protectedlibs-mk"><span class="std std-ref">ProtectedLibs.mk</span></a></p></li>
<li><p><a class="reference internal" href="#kernelibs-mk"><span class="std std-ref">KernelLibs.mk</span></a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#directories-mk"><span class="std std-ref">Directories.mk</span></a></p></li>
</ul>
</section>
<section id="built-in-dependency-mechanism">
<h3>Built-in dependency mechanism<a class="headerlink" href="#built-in-dependency-mechanism" title="Permalink to this heading"></a></h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The documentation for <a class="reference internal" href="../components/tools/index.html#mkdeps"><span class="std std-ref">mkdeps.c, cnvwindeps.c, mkwindeps.sh, and mknulldeps.sh</span></a> should be extended. Lots of details
are missing. Part of the documentation here should be moved.</p>
</div>
<p>NuttX implements a built-in dependency mechanism. See <a class="reference internal" href="../components/tools/index.html#mkdeps"><span class="std std-ref">mkdeps.c, cnvwindeps.c, mkwindeps.sh, and mknulldeps.sh</span></a>.
This mechanism uses <code class="docutils literal notranslate"><span class="pre">gcc</span></code> to generate a <code class="docutils literal notranslate"><span class="pre">*.d</span></code> like dependency files that can be
included by the <strong>Makefile</strong> to track file dependencies.
This mechanism is kick-started by the <code class="docutils literal notranslate"><span class="pre">depend</span></code> target, and targets specific
directories in the NuttX tree based on the build mode. It is <em>required</em> by both
<code class="docutils literal notranslate"><span class="pre">pass1dep</span></code> and <code class="docutils literal notranslate"><span class="pre">pass2dep</span></code>.</p>
<div class="highlight-makefile notranslate"><div class="highlight"><pre><span></span><span class="nf">pass1dep</span><span class="o">:</span><span class="w"> </span><span class="n">context</span> <span class="n">tools</span>/<span class="n">mkdeps</span><span class="k">$(</span><span class="nv">HOSTEXEEXT</span><span class="k">)</span> <span class="n">tools</span>/<span class="n">cnvwindeps</span><span class="k">$(</span><span class="nv">HOSTEXEEXT</span><span class="k">)</span>
<span class="w">      </span><span class="k">$(</span>Q<span class="k">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>dir<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">$(</span>USERDEPDIRS<span class="k">)</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="se">\</span>
<span class="w">        </span><span class="k">$(</span>MAKE<span class="k">)</span><span class="w"> </span>-C<span class="w"> </span><span class="nv">$$</span>dir<span class="w"> </span>depend<span class="w"> </span><span class="o">||</span><span class="w"> </span>exit<span class="p">;</span><span class="w"> </span><span class="se">\</span>
<span class="w">      </span><span class="k">done</span>
<span class="nf">pass2dep</span><span class="o">:</span><span class="w"> </span><span class="n">context</span> <span class="n">tools</span>/<span class="n">mkdeps</span><span class="k">$(</span><span class="nv">HOSTEXEEXT</span><span class="k">)</span> <span class="n">tools</span>/<span class="n">cnvwindeps</span><span class="k">$(</span><span class="nv">HOSTEXEEXT</span><span class="k">)</span>
<span class="w">      </span><span class="k">$(</span>Q<span class="k">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>dir<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">$(</span>KERNDEPDIRS<span class="k">)</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="se">\</span>
<span class="w">        </span><span class="k">$(</span>MAKE<span class="k">)</span><span class="w"> </span>-C<span class="w"> </span><span class="nv">$$</span>dir<span class="w"> </span><span class="nv">EXTRAFLAGS</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>KDEFINE<span class="k">)</span><span class="s2"> </span><span class="k">$(</span>EXTRAFLAGS<span class="k">)</span><span class="s2">&quot;</span><span class="w"> </span>depend<span class="w"> </span><span class="o">||</span><span class="w"> </span>exit<span class="p">;</span><span class="w"> </span><span class="se">\</span>
<span class="w">      </span><span class="k">done</span>
</pre></div>
</div>
<p>Both <code class="docutils literal notranslate"><span class="pre">pass1dep</span></code> and <code class="docutils literal notranslate"><span class="pre">pass2dep</span></code> sets different directories and orders
in which the <code class="docutils literal notranslate"><span class="pre">depend</span></code> target is ran. See <a class="reference internal" href="#directories-mk"><span class="std std-ref">Directories.mk</span></a>.</p>
</section>
<section id="building-nuttx-libs">
<h3>Building NuttX libs<a class="headerlink" href="#building-nuttx-libs" title="Permalink to this heading"></a></h3>
<p>The host-specific <strong>Makefile</strong> will not build the required NuttX libs.
It will defer work by “recursively” calling make in each of the directories
listed in the <code class="docutils literal notranslate"><span class="pre">$(USERLIBS)</span></code> and <code class="docutils literal notranslate"><span class="pre">$(NUTTXLIBS)</span></code> variables.</p>
</section>
<section id="pass1-pass2">
<h3>pass1 &amp; pass2<a class="headerlink" href="#pass1-pass2" title="Permalink to this heading"></a></h3>
<p>The NuttX binary is always generated by running both <code class="docutils literal notranslate"><span class="pre">pass1</span></code> and <code class="docutils literal notranslate"><span class="pre">pass2</span></code> targets.
The actual dependencies of the mentioned targets may vary depending on the build mode.</p>
<p>Different NuttX build modes will not influence the “execution” of the <code class="docutils literal notranslate"><span class="pre">pass1</span></code> and <code class="docutils literal notranslate"><span class="pre">pass2</span></code> targets,
but rather will influence the dependencies pulled by those targets.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">pass1</span></code> target depends on the <code class="docutils literal notranslate"><span class="pre">$(USERLIBS)</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pass2</span></code> target depends on the <code class="docutils literal notranslate"><span class="pre">$(NUTTXLIBS)</span></code>.</p></li>
</ul>
<div class="highlight-makefile notranslate"><div class="highlight"><pre><span></span><span class="nf">all</span><span class="o">:</span><span class="w"> </span><span class="n">pass</span>1 <span class="n">pass</span>2

<span class="nf">pass1</span><span class="o">:</span><span class="w"> </span><span class="k">$(</span><span class="nv">USERLIBS</span><span class="k">)</span>
<span class="nf">pass2</span><span class="o">:</span><span class="w"> </span><span class="k">$(</span><span class="nv">NUTTXLIBS</span><span class="k">)</span>
</pre></div>
</div>
<p>The content of the <code class="docutils literal notranslate"><span class="pre">$(USERLIBS)</span></code> and <code class="docutils literal notranslate"><span class="pre">$(NUTTXLIBS)</span></code> variables is defined in each build mode makefile.
See <a class="reference internal" href="#build-modes"><span class="std std-ref">Build Modes</span></a> above.</p>
</section>
<section id="staging-the-libs">
<h3>Staging the libs<a class="headerlink" href="#staging-the-libs" title="Permalink to this heading"></a></h3>
<p>After compiling libraries defined by the <code class="docutils literal notranslate"><span class="pre">$(USERLIBS)</span></code> and <code class="docutils literal notranslate"><span class="pre">$(NUTTXLIBS)</span></code> at the previous step,
the <code class="docutils literal notranslate"><span class="pre">make</span></code> build system will <code class="docutils literal notranslate"><span class="pre">install</span></code> them at a special <code class="docutils literal notranslate"><span class="pre">staging/</span></code> directory, residing at the
root of the NuttX tree.</p>
<p>These libraries are passed to the the final target rule (<code class="docutils literal notranslate"><span class="pre">$(BIN)</span></code>).</p>
<div class="highlight-makefile notranslate"><div class="highlight"><pre><span></span><span class="c"># Unix.mk : line 536</span>
<span class="nf">$(BIN)</span><span class="o">:</span><span class="w"> </span><span class="n">pass</span>1 <span class="n">pass</span>2
<span class="c"># ...</span>
<span class="w">      </span><span class="k">$(</span>Q<span class="k">)</span><span class="w"> </span><span class="k">$(</span>MAKE<span class="k">)</span><span class="w"> </span>-C<span class="w"> </span><span class="k">$(</span>ARCH_SRC<span class="k">)</span><span class="w"> </span><span class="nv">EXTRA_OBJS</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>EXTRA_OBJS<span class="k">)</span><span class="s2">&quot;</span><span class="w"> </span><span class="nv">LINKLIBS</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>LINKLIBS<span class="k">)</span><span class="s2">&quot;</span><span class="w"> </span><span class="nv">APPDIR</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>APPDIR<span class="k">)</span><span class="s2">&quot;</span><span class="w"> </span><span class="nv">EXTRAFLAGS</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>KDEFINE<span class="k">)</span><span class="s2"> </span><span class="k">$(</span>EXTRAFLAGS<span class="k">)</span><span class="s2">&quot;</span><span class="w"> </span><span class="k">$(</span>BIN<span class="k">)</span>
<span class="c"># ...</span>
</pre></div>
</div>
</section>
</section>
<section id="win-mk">
<span id="id2"></span><h2>Win.mk<a class="headerlink" href="#win-mk" title="Permalink to this heading"></a></h2>
<p>Although targeting different platforms, both <strong>Win.mk</strong> and <strong>Unix.mk</strong> aim to produce
the same output. The need for independent files is due to the differences in the
platform’s approaches.</p>
<section id="forward-vs-back-slashes">
<h3>Forward vs Back slashes<a class="headerlink" href="#forward-vs-back-slashes" title="Permalink to this heading"></a></h3>
<p>One of the main differences is the use of forward slashes
(<code class="docutils literal notranslate"><span class="pre">/</span></code>) on unix-like platforms versus backslashes (<code class="docutils literal notranslate"><span class="pre">\</span></code>) on windows</p>
</section>
<section id="hostexeext-hostdynext">
<h3>${HOSTEXEEXT} ${HOSTDYNEXT}<a class="headerlink" href="#hostexeext-hostdynext" title="Permalink to this heading"></a></h3>
<p>These variables are used by the build system to configure the executable suffix required
by the used platform. They are defined in <a class="reference internal" href="#config-mk"><span class="std std-ref">Config.mk</span></a>.</p>
<p>For windows platform:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">${HOSTEXEEXT}</span></code> is set to <code class="docutils literal notranslate"><span class="pre">.exe</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">${HOSTDYNEXT}</span></code> is set to <code class="docutils literal notranslate"><span class="pre">.dll</span></code>.</p></li>
</ul>
</section>
<section id="symbolic-linking">
<h3>Symbolic Linking<a class="headerlink" href="#symbolic-linking" title="Permalink to this heading"></a></h3>
<p>For the windows platform, the build system handles symbolic links differently.</p>
</section>
</section>
<section id="unix-mk">
<span id="id3"></span><h2>Unix.mk<a class="headerlink" href="#unix-mk" title="Permalink to this heading"></a></h2>
<section id="versioning">
<h3>Versioning<a class="headerlink" href="#versioning" title="Permalink to this heading"></a></h3>
<p>The build system will impact versioning if NuttX is cloned as a repo. See <a class="reference internal" href="../guides/versioning_and_task_names.html#versioning"><span class="std std-ref">Versioning</span></a>.</p>
</section>
<section id="config-h-config-mkconfig">
<h3>config.h, .config, mkconfig<a class="headerlink" href="#config-h-config-mkconfig" title="Permalink to this heading"></a></h3>
<p>NuttX’s build system defers the <code class="docutils literal notranslate"><span class="pre">config.h</span></code> generation to a separate tool called
<code class="docutils literal notranslate"><span class="pre">mkconfig</span></code>. See <a class="reference internal" href="../components/tools/index.html#makefile-host"><span class="std std-ref">Makefile.host</span></a>.</p>
<div class="highlight-makefile notranslate"><div class="highlight"><pre><span></span><span class="nf">tools/mkconfig$(HOSTEXEEXT)</span><span class="o">:</span><span class="w"> </span><span class="n">prebuild</span>
<span class="w">          </span><span class="k">$(</span>Q<span class="k">)</span><span class="w"> </span><span class="k">$(</span>MAKE<span class="k">)</span><span class="w"> </span>-C<span class="w"> </span>tools<span class="w"> </span>-f<span class="w"> </span>Makefile.host<span class="w"> </span>mkconfig<span class="k">$(</span>HOSTEXEEXT<span class="k">)</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">include/nuttx/config.h</span></code> recipe calls the <code class="docutils literal notranslate"><span class="pre">mkconfig</span></code> executable generated by the
rule above to create the <code class="docutils literal notranslate"><span class="pre">config.h</span></code> file from the current <code class="docutils literal notranslate"><span class="pre">.config</span></code> file.</p>
</section>
<section id="symlinks-dirlinks">
<h3>Symlinks &amp; dirlinks<a class="headerlink" href="#symlinks-dirlinks" title="Permalink to this heading"></a></h3>
<p>Dirlinks are symbolic links that allow the build system to use generic paths while pointing
to architecture-specific, chip-specific, or board-specific directories. This enables a single
build system workflow across many different hardware configurations.</p>
<ul class="simple">
<li><p>Symlink <code class="docutils literal notranslate"><span class="pre">arch/&lt;arch-name&gt;/include</span></code> to <code class="docutils literal notranslate"><span class="pre">include/arch</span></code></p></li>
<li><p>Symlink <code class="docutils literal notranslate"><span class="pre">boards/&lt;arch&gt;/&lt;chip&gt;/&lt;board&gt;/include</span></code> to <code class="docutils literal notranslate"><span class="pre">include/arch/board</span></code></p></li>
<li><p>Symlink <code class="docutils literal notranslate"><span class="pre">arch/&lt;arch-name&gt;/include/&lt;chip-name&gt;</span></code> to <code class="docutils literal notranslate"><span class="pre">include/arch/chip</span></code></p></li>
<li><p>Symlink <code class="docutils literal notranslate"><span class="pre">boards/&lt;arch&gt;/&lt;chip&gt;/&lt;board&gt;</span></code> to <code class="docutils literal notranslate"><span class="pre">arch/&lt;arch-name&gt;/src/board/&lt;board&gt;</span></code></p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Some boards make use of a <code class="docutils literal notranslate"><span class="pre">common</span></code> directory. In that case:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">boards/&lt;arch&gt;/&lt;chip&gt;/common</span></code> is symlinked to <code class="docutils literal notranslate"><span class="pre">arch/&lt;arch-name&gt;/src/board</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">boards/&lt;arch&gt;/&lt;chip&gt;/&lt;board&gt;</span></code> is symlinked to <code class="docutils literal notranslate"><span class="pre">arch/&lt;arch-name&gt;/src/board/&lt;board&gt;</span></code></p></li>
</ul>
</div>
<ul class="simple">
<li><p>Symlink <code class="docutils literal notranslate"><span class="pre">arch/&lt;arch-name&gt;/src/&lt;chip-name&gt;</span></code> to <code class="docutils literal notranslate"><span class="pre">arch/&lt;arch-name&gt;/src/chip</span></code></p></li>
</ul>
<p>The <code class="docutils literal notranslate"><span class="pre">.dirlinks</span></code> file itself is just a timestamp marker that indicates all dirlinks have been
created.</p>
</section>
<section id="dummies">
<h3>Dummies<a class="headerlink" href="#dummies" title="Permalink to this heading"></a></h3>
<p>The main reason for the use of dummies is to handle some specific scenarios, such as external
code bases, custom chips and boards or to overcome tooling limitations. If any of the features below
are not used, the build system will fallback to a dummy.</p>
<ul>
<li><p><strong>${EXTERNALDIR}</strong></p>
<p>Possible values for <code class="docutils literal notranslate"><span class="pre">$(EXTERNALDIR)</span></code> are <code class="docutils literal notranslate"><span class="pre">external</span></code> or <code class="docutils literal notranslate"><span class="pre">dummy</span></code>.</p>
<p>NuttX code base can be extended by using <code class="docutils literal notranslate"><span class="pre">$(TOPDIR)/external/</span></code> directory.
The build system searches for a <code class="docutils literal notranslate"><span class="pre">Kconfig</span></code> file in that directory. If found,
the build system defines the <code class="docutils literal notranslate"><span class="pre">EXTERNALDIR</span></code> variable to <code class="docutils literal notranslate"><span class="pre">external</span></code> and also
appends another lib (<code class="docutils literal notranslate"><span class="pre">libexternal</span></code>) to the build process.</p>
<div class="highlight-makefile notranslate"><div class="highlight"><pre><span></span><span class="c"># External code support</span>
<span class="c"># If external/ contains a Kconfig, we define the EXTERNALDIR variable to &#39;external&#39;</span>
<span class="c"># so that main Kconfig can find it. Otherwise, we redirect it to a dummy Kconfig</span>
<span class="c"># This is due to kconfig inability to do conditional inclusion.</span>

<span class="nv">EXTERNALDIR</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">$(</span>shell<span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-r<span class="w"> </span><span class="k">$(</span>TOPDIR<span class="k">)</span>/external/Kconfig<span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s1">&#39;external&#39;</span><span class="p">;</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s1">&#39;dummy&#39;</span><span class="p">;</span><span class="w"> </span><span class="k">fi)</span>
</pre></div>
</div>
</li>
<li><p><strong>dummy/Kconfig</strong></p>
<p>The <code class="docutils literal notranslate"><span class="pre">dummy/Kconfig</span></code> is used to handle custom chips and boards.</p>
<p>If in-tree chip/board is used, the build system will resolve to dummy_kconfig files.
- <code class="docutils literal notranslate"><span class="pre">$(CHIP_KCONFIG)</span></code> is set to <code class="docutils literal notranslate"><span class="pre">$(TOPDIR)$(DELIM)arch$(DELIM)dummy$(DELIM)dummy_kconfig</span></code>
- <code class="docutils literal notranslate"><span class="pre">$(BOARD_KCONFIG)</span></code> is set to <code class="docutils literal notranslate"><span class="pre">$(TOPDIR)$(DELIM)boards$(DELIM)dummy$(DELIM)dummy_kconfig</span></code></p>
<p>If custom chip/board is used, the build system will resolve to their custom paths.</p>
<div class="highlight-makefile notranslate"><div class="highlight"><pre><span></span><span class="c"># Copy $(CHIP_KCONFIG) to arch/dummy/Kconfig</span>

<span class="nf">arch/dummy/Kconfig</span><span class="o">:</span>
<span class="w">    </span>@echo<span class="w"> </span><span class="s2">&quot;CP: </span><span class="nv">$@</span><span class="s2"> to </span><span class="k">$(</span>CHIP_KCONFIG<span class="k">)</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="k">$(</span>Q<span class="k">)</span><span class="w"> </span>cp<span class="w"> </span>-f<span class="w"> </span><span class="k">$(</span>CHIP_KCONFIG<span class="k">)</span><span class="w"> </span><span class="nv">$@</span>

<span class="c"># Copy $(BOARD_KCONFIG) to boards/dummy/Kconfig</span>

<span class="nf">boards/dummy/Kconfig</span><span class="o">:</span>
<span class="w">    </span>@echo<span class="w"> </span><span class="s2">&quot;CP: </span><span class="nv">$@</span><span class="s2"> to </span><span class="k">$(</span>BOARD_KCONFIG<span class="k">)</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="k">$(</span>Q<span class="k">)</span><span class="w"> </span>cp<span class="w"> </span>-f<span class="w"> </span><span class="k">$(</span>BOARD_KCONFIG<span class="k">)</span><span class="w"> </span><span class="nv">$@</span>
</pre></div>
</div>
</li>
<li><p><strong>boards/dummy.c</strong></p>
<p>A special <code class="docutils literal notranslate"><span class="pre">boards/dummy.c</span></code> file is used by the build system to generate a useless object.
The purpose of the useless object is to assure that libboards.a/lib is created. Some archivers
(ZDS-II, SDCC) require a non-empty library or they will generate errors.</p>
</li>
</ul>
</section>
<section id="build-modes">
<span id="id4"></span><h3>Build Modes<a class="headerlink" href="#build-modes" title="Permalink to this heading"></a></h3>
<p>As specified above, NuttX supports multiple build modes. The build mode is selected
based on specific <code class="docutils literal notranslate"><span class="pre">Kconfig</span></code> options.</p>
<div class="highlight-makefile notranslate"><div class="highlight"><pre><span></span><span class="c"># Library build selections</span>
<span class="c">#</span>
<span class="c"># NUTTXLIBS is the list of NuttX libraries that is passed to the</span>
<span class="c">#   processor-specific Makefile to build the final NuttX target.</span>
<span class="c"># USERLIBS is the list of libraries used to build the final user-space</span>
<span class="c">#   application</span>
<span class="c"># EXPORTLIBS is the list of libraries that should be exported by</span>
<span class="c">#   &#39;make export&#39; is</span>

<span class="cp">ifeq ($(CONFIG_BUILD_PROTECTED),y)</span>
<span class="cp">include tools/ProtectedLibs.mk</span>
<span class="cp">else ifeq ($(CONFIG_BUILD_KERNEL),y)</span>
<span class="cp">include tools/KernelLibs.mk</span>
<span class="cp">else</span>
<span class="cp">include tools/FlatLibs.mk</span>
<span class="cp">endif</span>
</pre></div>
</div>
<p>The content of each file referenced above is documented in its own section.</p>
<ul class="simple">
<li><p>tools/ProtectedLibs.mk <a class="reference internal" href="#protectedlibs-mk"><span class="std std-ref">ProtectedLibs.mk</span></a></p></li>
<li><p>tools/FlatLibs.mk <a class="reference internal" href="#flatlibs-mk"><span class="std std-ref">FlatLibs.mk</span></a></p></li>
<li><p>tools/KernelLibs.mk <a class="reference internal" href="#kernelibs-mk"><span class="std std-ref">KernelLibs.mk</span></a></p></li>
</ul>
</section>
</section>
<section id="config-mk">
<span id="id5"></span><h2>Config.mk<a class="headerlink" href="#config-mk" title="Permalink to this heading"></a></h2>
<p><code class="docutils literal notranslate"><span class="pre">Config.mk</span></code> contains common definitions used by many configuration files.</p>
<ul>
<li><p>It defines the logic behind the <a class="reference internal" href="#verbosity"><span class="std std-ref">Verbosity</span></a></p></li>
<li><p>It resolves the platform specific particularities, such as</p>
<ul class="simple">
<li><p>build <em>tools</em> <code class="docutils literal notranslate"><span class="pre">e.g.</span> <span class="pre">mkdeps,</span> <span class="pre">cnvwindeps,</span> <span class="pre">link.sh/.bat,</span> <span class="pre">unlink.sh/.bat</span></code></p></li>
<li><p>file extensions <code class="docutils literal notranslate"><span class="pre">e.g.</span> <span class="pre">.exe,</span> <span class="pre">.dll</span> <span class="pre">for</span> <span class="pre">windows,</span> <span class="pre">.o,</span> <span class="pre">.a</span> <span class="pre">for</span> <span class="pre">unix</span></code></p></li>
<li><p>delim based on the host platform. <code class="docutils literal notranslate"><span class="pre">e.g.</span> <span class="pre">\</span> <span class="pre">for</span> <span class="pre">windows,</span> <span class="pre">/</span> <span class="pre">for</span> <span class="pre">unix</span></code></p></li>
</ul>
</li>
<li><p>Resolve custom bard/chip/arch</p></li>
<li><p>Defines the rules for the dependency mechanism</p>
<div class="highlight-makefile notranslate"><div class="highlight"><pre><span></span><span class="nv">OBJPATH</span><span class="w"> </span><span class="o">?=</span><span class="w"> </span>.

<span class="nf">%.dds</span><span class="o">:</span><span class="w"> </span>%.<span class="n">S</span>
<span class="w">    </span><span class="k">$(</span>Q<span class="k">)</span><span class="w"> </span><span class="k">$(</span>MKDEP<span class="k">)</span><span class="w"> </span>--obj-path<span class="w"> </span><span class="k">$(</span>OBJPATH<span class="k">)</span><span class="w"> </span>--obj-suffix<span class="w"> </span><span class="k">$(</span>OBJEXT<span class="k">)</span><span class="w"> </span><span class="k">$(</span>DEPPATH<span class="k">)</span><span class="w"> </span><span class="s2">&quot;</span><span class="k">$(</span>CC<span class="k">)</span><span class="s2">&quot;</span><span class="w"> </span>--<span class="w"> </span><span class="k">$(</span>CFLAGS<span class="k">)</span><span class="w"> </span>--<span class="w"> </span>$&lt;<span class="w"> </span>&gt;<span class="w"> </span><span class="nv">$@</span>

<span class="nf">%.ddc</span><span class="o">:</span><span class="w"> </span>%.<span class="n">c</span>
<span class="w">    </span><span class="k">$(</span>Q<span class="k">)</span><span class="w"> </span><span class="k">$(</span>MKDEP<span class="k">)</span><span class="w"> </span>--obj-path<span class="w"> </span><span class="k">$(</span>OBJPATH<span class="k">)</span><span class="w"> </span>--obj-suffix<span class="w"> </span><span class="k">$(</span>OBJEXT<span class="k">)</span><span class="w"> </span><span class="k">$(</span>DEPPATH<span class="k">)</span><span class="w"> </span><span class="s2">&quot;</span><span class="k">$(</span>CC<span class="k">)</span><span class="s2">&quot;</span><span class="w"> </span>--<span class="w"> </span><span class="k">$(</span>CFLAGS<span class="k">)</span><span class="w"> </span>--<span class="w"> </span>$&lt;<span class="w"> </span>&gt;<span class="w"> </span><span class="nv">$@</span>

<span class="nf">%.ddp</span><span class="o">:</span><span class="w"> </span>%.<span class="n">cpp</span>
<span class="w">    </span><span class="k">$(</span>Q<span class="k">)</span><span class="w"> </span><span class="k">$(</span>MKDEP<span class="k">)</span><span class="w"> </span>--obj-path<span class="w"> </span><span class="k">$(</span>OBJPATH<span class="k">)</span><span class="w"> </span>--obj-suffix<span class="w"> </span><span class="k">$(</span>OBJEXT<span class="k">)</span><span class="w"> </span><span class="k">$(</span>DEPPATH<span class="k">)</span><span class="w"> </span><span class="s2">&quot;</span><span class="k">$(</span>CXX<span class="k">)</span><span class="s2">&quot;</span><span class="w"> </span>--<span class="w"> </span><span class="k">$(</span>CXXFLAGS<span class="k">)</span><span class="w"> </span>--<span class="w"> </span>$&lt;<span class="w"> </span>&gt;<span class="w"> </span><span class="nv">$@</span>

<span class="nf">%.ddx</span><span class="o">:</span><span class="w"> </span>%.<span class="n">cxx</span>
<span class="w">    </span><span class="k">$(</span>Q<span class="k">)</span><span class="w"> </span><span class="k">$(</span>MKDEP<span class="k">)</span><span class="w"> </span>--obj-path<span class="w"> </span><span class="k">$(</span>OBJPATH<span class="k">)</span><span class="w"> </span>--obj-suffix<span class="w"> </span><span class="k">$(</span>OBJEXT<span class="k">)</span><span class="w"> </span><span class="k">$(</span>DEPPATH<span class="k">)</span><span class="w"> </span><span class="s2">&quot;</span><span class="k">$(</span>CXX<span class="k">)</span><span class="s2">&quot;</span><span class="w"> </span>--<span class="w"> </span><span class="k">$(</span>CXXFLAGS<span class="k">)</span><span class="w"> </span>--<span class="w"> </span>$&lt;<span class="w"> </span>&gt;<span class="w"> </span><span class="nv">$@</span>

<span class="nf">%.ddh</span><span class="o">:</span><span class="w"> </span>%.<span class="n">c</span>
<span class="w">    </span><span class="k">$(</span>Q<span class="k">)</span><span class="w"> </span><span class="k">$(</span>MKDEP<span class="k">)</span><span class="w"> </span>--obj-path<span class="w"> </span><span class="k">$(</span>OBJPATH<span class="k">)</span><span class="w"> </span>--obj-suffix<span class="w"> </span><span class="k">$(</span>OBJEXT<span class="k">)</span><span class="w"> </span><span class="k">$(</span>DEPPATH<span class="k">)</span><span class="w"> </span><span class="s2">&quot;</span><span class="k">$(</span>CC<span class="k">)</span><span class="s2">&quot;</span><span class="w"> </span>--<span class="w"> </span><span class="k">$(</span>HOSTCFLAGS<span class="k">)</span><span class="w"> </span>--<span class="w"> </span>$&lt;<span class="w"> </span>&gt;<span class="w"> </span><span class="nv">$@</span>
</pre></div>
</div>
</li>
<li><p>Defines the include flag prefix based on compiler</p></li>
<li><p>Defines the common functions used to compile, assemble, archive files, etc.</p></li>
</ul>
<p>This file (along with <em>&lt;nuttx&gt;</em>/.config) must be included at the top of
each configuration-specific Make.defs file like</p>
<div class="highlight-makefile notranslate"><div class="highlight"><pre><span></span><span class="cp">include $(TOPDIR)/.config</span>
<span class="cp">include $(TOPDIR)/tools/Config.mk</span>
</pre></div>
</div>
<p>Subsequent logic within the configuration-specific Make.defs file may then
override these default definitions as necessary.</p>
</section>
<section id="flatlibs-mk">
<span id="id6"></span><h2>FlatLibs.mk<a class="headerlink" href="#flatlibs-mk" title="Permalink to this heading"></a></h2>
<p>This file defines the library sets for the <strong>flat build mode</strong>. In this mode,
the NuttX kernel and all user-space applications are compiled and linked into a
single, monolithic binary.</p>
<p>Its primary responsibilities are:</p>
<ul class="simple">
<li><p><strong>Populating ``NUTTXLIBS``:</strong> The file systematically appends all required
libraries to the <code class="docutils literal notranslate"><span class="pre">NUTTXLIBS</span></code> variable. This includes core OS libraries
(<code class="docutils literal notranslate"><span class="pre">libsched</span></code>, <code class="docutils literal notranslate"><span class="pre">libmm</span></code>, <code class="docutils literal notranslate"><span class="pre">libc</span></code>), architecture and board support libraries,
and device drivers.</p></li>
<li><p><strong>Conditional Library Inclusion:</strong> It uses <code class="docutils literal notranslate"><span class="pre">ifeq</span> <span class="pre">($(CONFIG_XXX),y)</span></code> checks
to conditionally include libraries for optional features based on the
system’s Kconfig. For example, <code class="docutils literal notranslate"><span class="pre">staging/libnet.a</span></code> is added only if
<code class="docutils literal notranslate"><span class="pre">CONFIG_NET=y</span></code>, and <code class="docutils literal notranslate"><span class="pre">staging/libcrypto.a</span></code> is added if <code class="docutils literal notranslate"><span class="pre">CONFIG_CRYPTO=y</span></code>.</p></li>
<li><p><strong>Defining ``USERLIBS``:</strong> In the flat build, there is no separate user-space
binary, so the <code class="docutils literal notranslate"><span class="pre">USERLIBS</span></code> variable is initialized but remains empty.</p></li>
<li><p><strong>Setting ``EXPORTLIBS``:</strong> It assigns the complete list of <code class="docutils literal notranslate"><span class="pre">NUTTXLIBS</span></code> to
the <code class="docutils literal notranslate"><span class="pre">EXPORTLIBS</span></code> variable. This ensures that the <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">export</span></code> command
packages all the compiled libraries required to link the final binary.</p></li>
</ul>
</section>
<section id="protectedlibs-mk">
<span id="id7"></span><h2>ProtectedLibs.mk<a class="headerlink" href="#protectedlibs-mk" title="Permalink to this heading"></a></h2>
<p>This file defines the library sets for the <strong>protected build mode</strong>. In this mode,
the NuttX kernel and user-space applications are built as two distinct binaries,
enabling memory protection and a more robust system architecture.</p>
<p>Its primary responsibilities are:</p>
<ul class="simple">
<li><p><strong>Separate Library Lists:</strong> Unlike the flat build, this file populates both
the <code class="docutils literal notranslate"><span class="pre">NUTTXLIBS</span></code> variable (for the kernel binary) and the <code class="docutils literal notranslate"><span class="pre">USERLIBS</span></code> variable
(for user-space applications).</p></li>
<li><p><strong>Kernel vs. User Library Variants:</strong> It explicitly differentiates between
kernel and user variants of core libraries. For instance:</p>
<ul>
<li><p>Kernel-specific libraries (e.g., <code class="docutils literal notranslate"><span class="pre">libkc.a</span></code>, <code class="docutils literal notranslate"><span class="pre">libkmm.a</span></code>, <code class="docutils literal notranslate"><span class="pre">libkarch.a</span></code>)
are added to <code class="docutils literal notranslate"><span class="pre">NUTTXLIBS</span></code>.</p></li>
<li><p>User-space counterparts (e.g., <code class="docutils literal notranslate"><span class="pre">libc.a</span></code>, <code class="docutils literal notranslate"><span class="pre">libmm.a</span></code>, <code class="docutils literal notranslate"><span class="pre">libarch.a</span></code>)
are added to <code class="docutils literal notranslate"><span class="pre">USERLIBS</span></code>.</p></li>
</ul>
</li>
<li><p><strong>System Call Mechanism:</strong> It includes essential components for the system
call interface:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">staging/libstubs.a</span></code> (system call stubs) is added to <code class="docutils literal notranslate"><span class="pre">NUTTXLIBS</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">staging/libproxies.a</span></code> (system call proxies) is added to <code class="docutils literal notranslate"><span class="pre">USERLIBS</span></code>.
These facilitate safe communication between user applications and the kernel.</p></li>
</ul>
</li>
<li><p><strong>Conditional Library Inclusion:</strong> Similar to other build modes, it uses
<code class="docutils literal notranslate"><span class="pre">ifeq</span> <span class="pre">($(CONFIG_XXX),y)</span></code> checks to conditionally include libraries for
optional features in both kernel and user-space, based on the Kconfig settings.</p></li>
<li><p><strong>Exporting User Libraries:</strong> A key distinction is that <code class="docutils literal notranslate"><span class="pre">EXPORTLIBS</span></code> is set
to <code class="docutils literal notranslate"><span class="pre">$(USERLIBS)</span></code>. This means that the <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">export</span></code> command will primarily
package the user-space libraries, which are then used by external build
systems or for linking user applications.</p></li>
</ul>
</section>
<section id="kernellibs-mk">
<span id="kernelibs-mk"></span><h2>KernelLibs.mk<a class="headerlink" href="#kernellibs-mk" title="Permalink to this heading"></a></h2>
<p>This file defines the library sets for the <strong>kernel build mode</strong>. In this mode,
only the NuttX kernel is compiled and linked into a single binary. User
applications are expected to be loaded and executed separately, typically in a
protected user-space environment.</p>
<p>Its primary responsibilities are:</p>
<ul class="simple">
<li><p><strong>Kernel-Only ``NUTTXLIBS``:</strong> The file populates the <code class="docutils literal notranslate"><span class="pre">NUTTXLIBS</span></code> variable
with all the necessary kernel-space libraries. This includes core OS
components (e.g., <code class="docutils literal notranslate"><span class="pre">libsched</span></code>, <code class="docutils literal notranslate"><span class="pre">libdrivers</span></code>), kernel variants of common
libraries (e.g., <code class="docutils literal notranslate"><span class="pre">libkc.a</span></code>, <code class="docutils literal notranslate"><span class="pre">libkmm.a</span></code>, <code class="docutils literal notranslate"><span class="pre">libkarch.a</span></code>), and board support.</p></li>
<li><p><strong>Empty ``USERLIBS``:</strong> The <code class="docutils literal notranslate"><span class="pre">USERLIBS</span></code> variable is explicitly initialized
but remains empty, as this build mode does not produce a user-space binary.</p></li>
<li><p><strong>System Call Stubs:</strong> It includes <code class="docutils literal notranslate"><span class="pre">staging/libstubs.a</span></code> in <code class="docutils literal notranslate"><span class="pre">NUTTXLIBS</span></code>,
providing the kernel-side implementation for system calls. User-space system
call proxies (<code class="docutils literal notranslate"><span class="pre">libproxies.a</span></code>) are not included, consistent with the absence
of a user-space build.</p></li>
<li><p><strong>Conditional Library Inclusion:</strong> It uses <code class="docutils literal notranslate"><span class="pre">ifeq</span> <span class="pre">($(CONFIG_XXX),y)</span></code> checks
to conditionally include kernel-specific libraries for optional features
based on the system’s Kconfig.</p></li>
<li><p><strong>Exporting User Libraries (Empty):</strong> <code class="docutils literal notranslate"><span class="pre">EXPORTLIBS</span></code> is set to <code class="docutils literal notranslate"><span class="pre">$(USERLIBS)</span></code>.
Consequently, in this kernel-only build mode, <code class="docutils literal notranslate"><span class="pre">EXPORTLIBS</span></code> will be empty,
reflecting that no user-space libraries are produced for external packaging.</p></li>
</ul>
</section>
<section id="directories-mk">
<span id="id8"></span><h2>Directories.mk<a class="headerlink" href="#directories-mk" title="Permalink to this heading"></a></h2>
<p>This file defines the directories used throughout the NuttX build process.
These directory lists are not static but are <strong>dynamically constructed</strong>
based on the active Kconfig configuration.</p>
<p>The file begins by defining a <code class="docutils literal notranslate"><span class="pre">BASEDIRS</span></code> variable, which includes core directories
that are always part of the build. Subsequently, it uses conditional logic
(<code class="docutils literal notranslate"><span class="pre">ifeq</span> <span class="pre">($(CONFIG_XXX),y)</span></code>) to append additional directories to various master lists,
such as <code class="docutils literal notranslate"><span class="pre">ALLDIRS</span></code> and <code class="docutils literal notranslate"><span class="pre">CLEANDIRS</span></code>, only if their corresponding Kconfig options are
enabled.</p>
<p>For example:</p>
<ul class="simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">net/</span></code> directory is added to the build lists only if <code class="docutils literal notranslate"><span class="pre">CONFIG_NET=y</span></code>.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">graphics/</span></code> directory is included if <code class="docutils literal notranslate"><span class="pre">CONFIG_GRAPHICS=y</span></code>.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">crypto/</span></code> directory is included if <code class="docutils literal notranslate"><span class="pre">CONFIG_CRYPTO=y</span></code>.</p></li>
</ul>
<p>The file defines key variables that hold these dynamically generated directory lists:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">KERNDEPDIRS</span></code>: Directories containing kernel files for dependency generation.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">USERDEPDIRS</span></code>: Directories containing user-space files for dependency generation.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">CCLEANDIRS</span></code>: Directories where the <code class="docutils literal notranslate"><span class="pre">clean_context</span></code> target will execute.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">CLEANDIRS</span></code>: All known directories where the <code class="docutils literal notranslate"><span class="pre">clean</span></code> target will execute.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">CONTEXTDIRS</span></code>: Directories with special pre-build requirements, such as auto-generation of files or symbolic link creation.</p></li>
</ul>
</section>
<section id="libtargets-mk">
<span id="id9"></span><h2>LibTargets.mk<a class="headerlink" href="#libtargets-mk" title="Permalink to this heading"></a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">LibTargets.mk</span></code> file defines all the targets needed to build the NuttX
libraries from their respective source directories and then install the
resulting library file into the <code class="docutils literal notranslate"><span class="pre">staging/</span></code> directory.</p>
<p>For many core libraries (e.g., <code class="docutils literal notranslate"><span class="pre">libc</span></code>, <code class="docutils literal notranslate"><span class="pre">libm</span></code>, <code class="docutils literal notranslate"><span class="pre">libmm</span></code>, <code class="docutils literal notranslate"><span class="pre">libbuiltin</span></code>, <code class="docutils literal notranslate"><span class="pre">libnx</span></code>, <code class="docutils literal notranslate"><span class="pre">libarch</span></code>),
<code class="docutils literal notranslate"><span class="pre">LibTargets.mk</span></code> defines distinct targets for <strong>kernel</strong> and <strong>user</strong> variants.</p>
<ul class="simple">
<li><p><strong>Kernel libraries</strong> are typically prefixed with <code class="docutils literal notranslate"><span class="pre">libk</span></code> (e.g., <code class="docutils literal notranslate"><span class="pre">libkc.a</span></code> for kernel C library,
<code class="docutils literal notranslate"><span class="pre">libkmm.a</span></code> for kernel memory management). These are compiled with specific
<code class="docutils literal notranslate"><span class="pre">EXTRAFLAGS</span></code> that include <code class="docutils literal notranslate"><span class="pre">$(KDEFINE)</span></code>, which sets kernel-specific preprocessor
definitions (e.g., <code class="docutils literal notranslate"><span class="pre">-D__KERNEL__</span></code>). This ensures they are built with the necessary
context and APIs for the kernel environment.</p></li>
<li><p><strong>User libraries</strong> retain their standard names (e.g., <code class="docutils literal notranslate"><span class="pre">libc.a</span></code>, <code class="docutils literal notranslate"><span class="pre">libmm.a</span></code>).
These are compiled without the <code class="docutils literal notranslate"><span class="pre">$(KDEFINE)</span></code> flag, making them suitable for user-space
applications. The build process for user-mode libraries often depends on <code class="docutils literal notranslate"><span class="pre">pass1dep</span></code>,
while kernel-mode libraries depend on <code class="docutils literal notranslate"><span class="pre">pass2dep</span></code>, reflecting the two-pass build
strategy in protected and kernel build modes.</p></li>
</ul>
<p>For each variant of a library, two main targets are defined:</p>
<ol class="arabic simple">
<li><p><strong>A build target:</strong> This target recursively calls <code class="docutils literal notranslate"><span class="pre">make</span></code> within the library’s
source directory (e.g., <code class="docutils literal notranslate"><span class="pre">libs/libc/</span></code>, <code class="docutils literal notranslate"><span class="pre">mm/</span></code>) to compile the sources and create
the library archive (<code class="docutils literal notranslate"><span class="pre">.a</span></code>) file. It passes the appropriate <code class="docutils literal notranslate"><span class="pre">EXTRAFLAGS</span></code>
depending on whether it’s a kernel-mode or user-mode build. The dependency for
these targets is either <code class="docutils literal notranslate"><span class="pre">pass1dep</span></code> or <code class="docutils literal notranslate"><span class="pre">pass2dep</span></code>, ensuring dependencies are
checked before building.</p></li>
<li><p><strong>A staging target:</strong> This target depends on the successful creation of the
library archive from the previous step. Its recipe calls the <code class="docutils literal notranslate"><span class="pre">INSTALL_LIB</span></code>
macro (defined in <code class="docutils literal notranslate"><span class="pre">Unix.mk</span></code> or <code class="docutils literal notranslate"><span class="pre">Win.mk</span></code>) to copy the newly created
library to the top-level <code class="docutils literal notranslate"><span class="pre">staging/</span></code> directory.</p></li>
</ol>
<p>The file contains conditional logic, primarily based on <code class="docutils literal notranslate"><span class="pre">CONFIG_BUILD_FLAT</span></code>,
to adjust dependencies (<code class="docutils literal notranslate"><span class="pre">pass1dep</span></code> vs. <code class="docutils literal notranslate"><span class="pre">pass2dep</span></code>) for libraries that can
be part of either the user or kernel space, ensuring they are built in the
correct pass according to the selected build mode.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="index.html" class="btn btn-neutral float-left" title="Implementation Details" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="drivers_design.html" class="btn btn-neutral float-right" title="OS Drivers Design" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, The Apache Software Foundation.</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>